---
interface Props {
  role: 'recepcionista' | 'encargado' | 'mecanico' | 'admin';
  currentPath: string;
}

const { role, currentPath } = Astro.props;

interface LinkItem {
  href: string;
  icon: string;
  label: string;
}

interface LinkSection {
  title: string;
  items: LinkItem[];
}

const linkSections: Record<string, LinkSection[]> = {
  recepcionista: [
    {
      title: 'Principal',
      items: [
        { href: '/recepcion/dash_recep', icon: 'dashboard', label: 'Dashboard' },
      ]
    },
    {
      title: 'Clientes',
      items: [
        { href: '/recepcion/buscar_cliente', icon: 'person_search', label: 'Buscar Cliente' },
        { href: '/recepcion/crear_cliente', icon: 'person_add', label: 'Nuevo Cliente' },
        { href: '/recepcion/list_c_y_v', icon: 'groups', label: 'Listado' },
      ]
    },
    {
      title: 'Vehículos',
      items: [
        { href: '/recepcion/crear_vehiculo', icon: 'directions_car', label: 'Nuevo Vehículo' },
        { href: '/recepcion/historial_vehiculo', icon: 'history', label: 'Historial' },
      ]
    },
    {
      title: 'Órdenes',
      items: [
        { href: '/recepcion/crear_orden', icon: 'post_add', label: 'Nueva Orden' },
        { href: '/recepcion/ver_estado_orden', icon: 'search', label: 'Consultar Estado' },
      ]
    },
    {
      title: 'Entregas',
      items: [
        { href: '/recepcion/confirmar_pago', icon: 'payments', label: 'Confirmar Pago' },
        { href: '/recepcion/entrega_vehiculo', icon: 'key', label: 'Entregar Vehículo' },
        { href: '/recepcion/comprobante', icon: 'receipt', label: 'Comprobante' },
      ]
    },
  ],
  encargado: [
    {
      title: 'Principal',
      items: [
        { href: '/encargado/dash_enc', icon: 'dashboard', label: 'Dashboard' },
        { href: '/encargado/reportes', icon: 'analytics', label: 'Reportes' },
      ]
    },
    {
      title: 'Equipo',
      items: [
        { href: '/encargado/asig_orden', icon: 'assignment_ind', label: 'Asignar Orden' },
        { href: '/encargado/reasignar_orden', icon: 'swap_horiz', label: 'Reasignar Orden' },
        { href: '/encargado/gestion_mecanicos', icon: 'engineering', label: 'Mecánicos' },
      ]
    },
    {
      title: 'Órdenes',
      items: [
        { href: '/encargado/trabajos_en_curso', icon: 'construction', label: 'En Curso' },
        { href: '/encargado/historial', icon: 'history', label: 'Historial' },
        { href: '/encargado/detalles_de_orden', icon: 'info', label: 'Ver Detalle' },
      ]
    },
    {
      title: 'Facturación',
      items: [
        { href: '/encargado/presupuestos', icon: 'request_quote', label: 'Presupuestos' },
        { href: '/encargado/gen_factura', icon: 'receipt_long', label: 'Generar Factura' },
        { href: '/encargado/ver_factura', icon: 'description', label: 'Ver Factura' },
        { href: '/encargado/marc_orden', icon: 'check_circle', label: 'Marcar Entrega' },
      ]
    },
    {
      title: 'Inventario',
      items: [
        { href: '/encargado/inventario', icon: 'inventory', label: 'Stock' },
        { href: '/encargado/alert_stock', icon: 'warning', label: 'Alertas' },
        { href: '/encargado/aprobar_solicitudes', icon: 'approval', label: 'Solicitudes' },
      ]
    },
  ],
  mecanico: [
    {
      title: 'Principal',
      items: [
        { href: '/mecanico/dash_mec', icon: 'dashboard', label: 'Mis Órdenes' },
      ]
    },
    {
      title: 'Trabajo',
      items: [
        { href: '/mecanico/detalle_orden_trabajo', icon: 'build', label: 'Detalle Orden' },
        { href: '/mecanico/bitacora_repuestos', icon: 'edit_note', label: 'Bitácora' },
        { href: '/mecanico/pausar_trabajo', icon: 'pause_circle', label: 'Pausar Trabajo' },
        { href: '/mecanico/checklist_entrega', icon: 'checklist', label: 'Checklist Entrega' },
      ]
    },
    {
      title: 'Repuestos',
      items: [
        { href: '/mecanico/solicitar_repuesto', icon: 'shopping_cart', label: 'Solicitar' },
        { href: '/mecanico/historial_vehiculo', icon: 'history', label: 'Historial Vehículo' },
      ]
    },
  ],
  admin: [
    {
      title: 'Principal',
      items: [
        { href: '/admin', icon: 'dashboard', label: 'Dashboard' },
      ]
    },
    {
      title: 'Usuarios',
      items: [
        { href: '/admin/usuarios', icon: 'manage_accounts', label: 'Gestionar Usuarios' },
      ]
    },
    {
      title: 'Catálogos',
      items: [
        { href: '/admin/servicios', icon: 'home_repair_service', label: 'Servicios' },
        { href: '/admin/clientes', icon: 'people', label: 'Clientes' },
        { href: '/admin/vehiculos', icon: 'directions_car', label: 'Vehículos' },
        { href: '/admin/mecanicos', icon: 'engineering', label: 'Mecánicos' },
        { href: '/admin/repuestos', icon: 'inventory_2', label: 'Repuestos' },
        { href: '/admin/zonas', icon: 'location_on', label: 'Zonas' },
      ]
    },
    {
      title: 'Operaciones',
      items: [
        { href: '/admin/ordenes', icon: 'assignment', label: 'Órdenes' },
      ]
    },
  ]
};

const currentSections = linkSections[role] || [];

// Determinar qué secciones deben estar abiertas inicialmente
const getInitialOpenSections = () => {
  const openSections: string[] = [];
  currentSections.forEach((section) => {
    const hasActiveItem = section.items.some(
      item => currentPath === item.href || currentPath.startsWith(item.href + '/')
    );
    if (hasActiveItem) {
      openSections.push(section.title);
    }
  });
  // Si no hay ninguna activa, abrir la primera por defecto
  if (openSections.length === 0 && currentSections.length > 0) {
    openSections.push(currentSections[0].title);
  }
  return openSections;
};

const initialOpen = getInitialOpenSections();
---

<!-- Mobile Overlay -->
<div 
  id="sidebar-overlay"
  class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"
  x-data
  @click="window.dispatchEvent(new CustomEvent('toggle-sidebar'))"
></div>

<!-- Sidebar -->
<aside 
  id="sidebar"
  class="fixed lg:sticky top-0 left-0 h-screen w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col"
  x-data={`{ openSections: ${JSON.stringify(initialOpen)} }`}
>
    <!-- Header con botón cerrar (solo móvil) -->
    <div class="flex items-center justify-between p-5 lg:p-5">
        <!-- Brand -->
        <div class="flex gap-3 items-center">
            <div class="bg-gradient-to-br from-primary-600 to-primary-700 text-white rounded-xl p-2.5 shadow-lg shadow-primary-500/30 flex items-center justify-center">
                 <span class="material-symbols-outlined text-2xl">garage</span>
            </div>
            <div class="flex flex-col">
                <h1 class="text-gray-900 dark:text-white text-lg font-bold font-display tracking-tight leading-tight">Taller Veloz</h1>
                <p class="text-gray-500 dark:text-gray-400 text-xs font-medium uppercase tracking-wider">{role}</p>
            </div>
        </div>
        
        <!-- Botón cerrar (solo móvil) -->
        <button 
          id="sidebar-close"
          class="lg:hidden p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
        >
            <span class="material-symbols-outlined">close</span>
        </button>
    </div>
    
    <!-- Navigation (scrollable) -->
    <nav class="flex flex-col gap-2 flex-1 overflow-y-auto px-5 pb-4">
        {currentSections.map((section) => {
            const sectionId = section.title;
            const hasActiveItem = section.items.some(
              item => currentPath === item.href || currentPath.startsWith(item.href + '/')
            );
            return (
                <div class="mb-2">
                    <!-- Dropdown Header -->
                    <button 
                        type="button"
                        @click={`openSections.includes('${sectionId}') ? openSections = openSections.filter(s => s !== '${sectionId}') : openSections.push('${sectionId}')`}
                        class:list={[
                            "w-full flex items-center justify-between px-3 py-2.5 rounded-xl text-sm font-semibold transition-all duration-200 group select-none",
                            hasActiveItem 
                                ? "text-primary-700 dark:text-primary-300 bg-primary-50 dark:bg-primary-900/20"
                                : "text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-200"
                        ]}
                    >
                        <span class="uppercase tracking-wider text-[11px] font-bold">{section.title}</span>
                        <span 
                            class="material-symbols-outlined text-[18px] transition-transform duration-200 opacity-50 group-hover:opacity-100"
                            x-bind:class={`openSections.includes('${sectionId}') ? 'rotate-180' : ''`}
                        >
                            expand_more
                        </span>
                    </button>
                    
                    <!-- Dropdown Content -->
                    <div 
                        x-show={`openSections.includes('${sectionId}')`}
                        x-collapse
                        class="flex flex-col gap-1 mt-1 ml-3 pl-3 border-l border-gray-200 dark:border-gray-700"
                    >
                        {section.items.map((link) => {
                            const isActive = currentPath === link.href || currentPath.startsWith(link.href + '/');
                            return (
                                <a 
                                    href={link.href} 
                                    class:list={[
                                        "flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200",
                                        isActive 
                                            ? "bg-primary-100/50 dark:bg-primary-900/40 text-primary-700 dark:text-primary-300 shadow-sm" 
                                            : "text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-200 hover:translate-x-1"
                                    ]}
                                >
                                    <span class:list={["material-symbols-outlined text-[20px]", isActive ? "text-primary-600 dark:text-primary-400" : "text-gray-400"]}>{link.icon}</span>
                                    {link.label}
                                </a>
                            );
                        })}
                    </div>
                </div>
            );
        })}
    </nav>

    <!-- Footer Actions -->
    <div class="mt-auto flex flex-col gap-1 p-5 pt-4 border-t border-gray-200 dark:border-gray-800">
        <a href="/settings" class="flex items-center gap-3 px-3 py-2.5 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 hover:text-gray-900 dark:hover:text-gray-200 rounded-xl text-sm font-medium transition-colors">
            <span class="material-symbols-outlined text-[20px] text-gray-400">settings</span>
            Configuración
        </a>
        <a href="/logout" class="flex items-center gap-3 px-3 py-2.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl text-sm font-medium transition-colors">
            <span class="material-symbols-outlined text-[20px]">logout</span>
            Cerrar Sesión
        </a>
    </div>
</aside>

<script>
  // Sidebar toggle functionality
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  const closeBtn = document.getElementById('sidebar-close');
  
  function openSidebar() {
    sidebar?.classList.remove('-translate-x-full');
    sidebar?.classList.add('translate-x-0');
    overlay?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  
  function closeSidebar() {
    sidebar?.classList.add('-translate-x-full');
    sidebar?.classList.remove('translate-x-0');
    overlay?.classList.add('hidden');
    document.body.style.overflow = '';
  }
  
  // Listen for toggle event from header
  window.addEventListener('toggle-sidebar', () => {
    if (sidebar?.classList.contains('-translate-x-full')) {
      openSidebar();
    } else {
      closeSidebar();
    }
  });
  
  // Close button click
  closeBtn?.addEventListener('click', closeSidebar);
  
  // Close on ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !sidebar?.classList.contains('-translate-x-full')) {
      closeSidebar();
    }
  });
  
  // Close sidebar when clicking a link (on mobile)
  const sidebarLinks = sidebar?.querySelectorAll('a');
  sidebarLinks?.forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth < 1024) {
        closeSidebar();
      }
    });
  });
  
  // Handle resize - reset sidebar state on desktop
  window.addEventListener('resize', () => {
    if (window.innerWidth >= 1024) {
      sidebar?.classList.remove('-translate-x-full');
      sidebar?.classList.add('translate-x-0');
      overlay?.classList.add('hidden');
      document.body.style.overflow = '';
    } else {
      sidebar?.classList.add('-translate-x-full');
      sidebar?.classList.remove('translate-x-0');
    }
  });
</script>
