---
// Notification Center Component
interface Notification {
  id: string;
  type: 'info' | 'success' | 'warning' | 'error';
  title: string;
  message: string;
  time: string;
  read: boolean;
}

interface Props {
  notifications?: Notification[];
}

const { notifications = [] } = Astro.props;
---

<div id="notification-system" data-notifications={JSON.stringify(notifications)}>
  <!-- Notification sound (optional) -->
  <audio id="notification-sound" preload="auto">
    <source src="/sounds/notification.mp3" type="audio/mpeg">
  </audio>
</div>

<script is:inline>
(function() {
  var badge = document.getElementById('notification-badge');
  var listContainer = document.getElementById('notifications-list');
  var notifications = [];
  var unreadCount = 0;

  // Icon and color maps
  var iconMap = {
    info: 'info',
    success: 'check_circle',
    warning: 'warning',
    error: 'error'
  };
  
  var colorMap = {
    info: 'blue',
    success: 'green',
    warning: 'amber',
    error: 'red'
  };

  function updateBadge() {
    if (!badge) return;
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }

  function renderNotifications() {
    if (!listContainer) return;

    if (notifications.length === 0) {
      listContainer.innerHTML = '<div class="p-8 text-center text-gray-500 dark:text-gray-400"><span class="material-symbols-outlined text-4xl mb-2 block opacity-50">notifications_off</span><p class="text-sm">No hay notificaciones nuevas</p></div>';
      return;
    }

    var html = '';
    notifications.slice(0, 10).forEach(function(n) {
      var bgClass = n.read ? 'bg-white dark:bg-gray-800' : 'bg-blue-50 dark:bg-blue-900/20';
      var icon = iconMap[n.type] || iconMap.info;
      var color = colorMap[n.type] || colorMap.info;
      
      html += '<div class="p-4 border-b border-gray-100 dark:border-gray-700 ' + bgClass + ' hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer" data-notification-id="' + n.id + '">';
      html += '<div class="flex gap-3">';
      html += '<div class="w-8 h-8 rounded-full bg-' + color + '-100 dark:bg-' + color + '-900/30 flex items-center justify-center flex-shrink-0">';
      html += '<span class="material-symbols-outlined text-' + color + '-600 dark:text-' + color + '-400 text-lg">' + icon + '</span>';
      html += '</div>';
      html += '<div class="flex-1 min-w-0">';
      html += '<div class="flex items-start justify-between gap-2">';
      html += '<p class="text-sm font-medium text-gray-900 dark:text-white">' + n.title + '</p>';
      if (!n.read) html += '<span class="w-2 h-2 rounded-full bg-blue-500 flex-shrink-0 mt-1.5"></span>';
      html += '</div>';
      html += '<p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">' + n.message + '</p>';
      html += '<p class="text-xs text-gray-400 dark:text-gray-500 mt-1">' + n.time + '</p>';
      html += '</div></div></div>';
    });
    
    listContainer.innerHTML = html;
  }

  function addNotification(notification) {
    notification.id = notification.id || 'notif-' + Date.now();
    notification.time = notification.time || 'Ahora';
    notification.read = false;
    
    notifications.unshift(notification);
    unreadCount++;
    
    updateBadge();
    renderNotifications();
    
    // Play sound (optional)
    var sound = document.getElementById('notification-sound');
    if (sound && sound.play) {
      sound.play().catch(function() {});
    }
    
    // Show toast notification
    if (window.showToast) {
      window.showToast(notification.title + ': ' + notification.message, notification.type);
    }
  }

  function markAsRead(id) {
    var notif = notifications.find(function(n) { return n.id === id; });
    if (notif && !notif.read) {
      notif.read = true;
      unreadCount = Math.max(0, unreadCount - 1);
      updateBadge();
      renderNotifications();
    }
  }

  function markAllAsRead() {
    notifications.forEach(function(n) { n.read = true; });
    unreadCount = 0;
    updateBadge();
    renderNotifications();
  }

  // Click handler for notifications
  if (listContainer) {
    listContainer.addEventListener('click', function(e) {
      var notifEl = e.target.closest('[data-notification-id]');
      if (notifEl) {
        markAsRead(notifEl.dataset.notificationId);
      }
    });
  }

  // Expose functions globally
  window.NotificationCenter = {
    add: addNotification,
    markAsRead: markAsRead,
    markAllAsRead: markAllAsRead,
    getUnreadCount: function() { return unreadCount; },
    refresh: loadNotifications
  };

  // Load notifications from API
  function loadNotifications() {
    fetch('/api/notifications')
      .then(function(res) { return res.json(); })
      .then(function(data) {
        if (data.notifications) {
          notifications = data.notifications;
          unreadCount = data.unreadCount || 0;
          updateBadge();
          renderNotifications();
        }
      })
      .catch(function(err) {
        console.error('Error loading notifications:', err);
      });
  }

  // Initialize
  updateBadge();
  renderNotifications();
  
  // Load notifications on page load
  loadNotifications();
  
  // Refresh notifications every 30 seconds
  setInterval(loadNotifications, 30000);

  // Listen for custom notification events
  window.addEventListener('new-notification', function(e) {
    if (e.detail) {
      addNotification(e.detail);
    }
  });
})();
</script>

<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
