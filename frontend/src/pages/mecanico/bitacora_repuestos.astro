---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Input from '../../components/ui/Input.astro';
import { strapiGet, strapiPost, strapiPut } from '../../lib/strapi';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

// --- TYPE DEFINITIONS ---
interface Cliente {
  nombre: string;
  apellido: string;
}

interface Vehiculo {
  marca: string;
  modelo: string;
  ano: number;
  patente: string;
  cliente?: Cliente;
}

interface Repuesto {
  id: number;
  documentId: string;
  nombre: string;
  stock: number;
  precio: number;
}

interface OrdenDeTrabajo {
  id: number;
  documentId: string;
  descripcion: string;
  vehiculo?: Vehiculo;
  repuestos?: Repuesto[];
}

// --- DATA FETCHING & STATE ---
let order: OrdenDeTrabajo | null = null;
let vehicle: Vehiculo | null = null;
let client: Cliente | null = null;
let allParts: Repuesto[] = [];
let error = '';
let success = '';

const orderId = Astro.url.searchParams.get('id');

if (!orderId) {
  error = 'No se especificó una orden de trabajo.';
} else {
  try {
    // Handle form submission
    if (Astro.request.method === 'POST') {
      const formData = await Astro.request.formData();
      const description = formData.get('description') as string;
      const timeSpent = formData.get('time_spent') as string;
      const usedPartsJson = formData.get('used_parts') as string;
      
      // Get the order's numeric ID for relations
      const orderResponse = await strapiGet(`/api/orden-de-trabajos/${orderId}`);
      const orderNumericId = orderResponse.data?.id;

      // Create bitacora entry
      if (description) {
        await strapiPost('/api/bitacoras', {
          procedimientos: description,
          tiempo: timeSpent ? parseFloat(timeSpent) : null,
          fecha: new Date().toISOString().split('T')[0],
          orden_de_trabajo: orderNumericId,
        });
      }

      // Update stock for used parts
      if (usedPartsJson) {
        const usedParts = JSON.parse(usedPartsJson);
        for (const part of usedParts) {
          // Get current stock
          const partResponse = await strapiGet(`/api/repuestos/${part.id}`);
          const currentStock = partResponse.data?.stock || 0;
          const newStock = Math.max(0, currentStock - part.quantity);
          
          // Update stock
          await strapiPut(`/api/repuestos/${part.id}`, {
            stock: newStock
          });
        }
      }

      success = 'Entrada guardada correctamente.';
      return Astro.redirect(`/mecanico/detalle_orden_trabajo?id=${orderId}&success=bitacora`);
    }

    // Fetch order data
    const orderResponse = await strapiGet(`/api/orden-de-trabajos/${orderId}?populate[vehiculo][populate][0]=cliente&populate[repuestos]=true`);
    order = orderResponse.data;
    
    if (order?.vehiculo) {
      vehicle = order.vehiculo;
      client = order.vehiculo.cliente || null;
    }

    // Fetch all available parts
    const partsResponse = await strapiGet('/api/repuestos?sort=nombre:asc');
    allParts = partsResponse.data || [];

  } catch (e: any) {
    console.error('Error:', e);
    error = e.message || 'Error al cargar los datos.';
  }
}
---

<DashboardLayout title="Bitácora de Repuestos" role="mecanico" currentPath={Astro.url.pathname}>
    <div class="max-w-5xl mx-auto">
        {error && <div class="bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6" role="alert">{error}</div>}
        {success && <div class="bg-green-100 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6" role="alert">{success}</div>}

        {order ? (
            <div x-data="partsManager()">
                <form method="POST">
                    <!-- PageHeading -->
                    <div class="flex flex-col gap-2 mb-8">
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Registrar Avance en Orden #{order.id}</h1>
                        <p class="text-gray-500 dark:text-gray-400">Añade una nueva entrada a la bitácora de servicio.</p>
                    </div>

                    <!-- Order Info Card -->
                    <Card class="mb-8">
                        <div class="flex flex-col gap-4">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">
                                {vehicle ? `${vehicle.marca} ${vehicle.modelo} ${vehicle.ano}` : 'Vehículo no especificado'} 
                                <span class="text-gray-500 font-normal ml-2">{vehicle?.patente || 'S/P'}</span>
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="flex flex-col gap-1">
                                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Cliente</span>
                                    <span class="text-gray-900 dark:text-white font-medium">{client ? `${client.nombre} ${client.apellido}` : 'Cliente no especificado'}</span>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Servicio Solicitado</span>
                                    <span class="text-gray-900 dark:text-white font-medium">{order.descripcion}</span>
                                </div>
                            </div>
                        </div>
                    </Card>

                    <Card>
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary-600">assignment</span>
                            Detalles de la Tarea
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descripción de Acciones Realizadas</label>
                                <textarea name="description" class="form-textarea w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200 placeholder:text-gray-400 min-h-[120px]" placeholder="Ej: Se desmontaron las pinzas de freno, se limpiaron y se instalaron nuevas pastillas..." required></textarea>
                            </div>
                            <div>
                                <Input 
                                    name="time_spent" 
                                    label="Tiempo Invertido (hrs)" 
                                    type="number" 
                                    min="0" 
                                    step="0.1" 
                                    placeholder="Ej: 2.5" 
                                />
                            </div>
                        </div>

                        <div class="border-t border-gray-100 dark:border-gray-700 my-8"></div>

                        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary-600">build_circle</span>
                            Repuestos Utilizados
                        </h2>
                        
                        <div class="flex flex-col gap-6">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Buscar Repuestos</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="material-symbols-outlined text-gray-400">search</span>
                                    </div>
                                    <input 
                                        type="search" 
                                        x-model="search" 
                                        @input.debounce.300ms="filterParts" 
                                        class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 dark:border-gray-700 rounded-lg leading-5 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm" 
                                        placeholder="Buscar por nombre o código..."
                                    />
                                </div>
                                
                                <!-- Search Results Dropdown -->
                                <div x-show="search.length > 0 && filteredParts.length > 0" x-cloak class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                    <template x-for="part in filteredParts" :key="part.id">
                                        <div @click="addPart(part)" class="cursor-pointer px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-700 last:border-0 flex justify-between items-center transition-colors">
                                            <div>
                                                <span class="font-medium text-gray-900 dark:text-white block" x-text="part.nombre"></span>
                                                <span class="text-xs text-gray-500 dark:text-gray-400" x-text="`ID: ${part.id}`"></span>
                                            </div>
                                            <span class="text-xs font-semibold px-2 py-1 rounded-full" :class="part.stock > 0 ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300'" x-text="`Stock: ${part.stock}`"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Added parts list -->
                            <div class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700">
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-800/50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Repuesto</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Stock Disp.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Cantidad</th>
                                            <th class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <template x-if="usedParts.length === 0">
                                            <tr><td colspan="4" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400 text-sm">No se han agregado repuestos a esta entrada.</td></tr>
                                        </template>
                                        <template x-for="usedPart in usedParts" :key="usedPart.id">
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white" x-text="usedPart.nombre"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                    <span x-text="usedPart.stock" :class="{'text-amber-600 font-bold': usedPart.stock < 5}"></span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                    <div class="flex items-center gap-2">
                                                        <button type="button" @click="decrementQuantity(usedPart.id)" class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-colors">-</button>
                                                        <span class="w-8 text-center font-medium text-gray-900 dark:text-white" x-text="usedPart.quantity"></span>
                                                        <button type="button" @click="incrementQuantity(usedPart.id)" class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-colors">+</button>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button type="button" @click="removePart(usedPart.id)" class="text-red-600 hover:text-red-900 dark:hover:text-red-400 transition-colors p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20">
                                                        <span class="material-symbols-outlined text-xl">delete</span>
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Hidden input to store used parts data for form submission -->
                        <input type="hidden" name="used_parts" :value="JSON.stringify(usedParts.map(p => ({ id: p.id, quantity: p.quantity, nombre: p.nombre })))" />

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 pt-8">
                            <a href={`/mecanico/detalle_orden_trabajo?id=${orderId}`}>
                                <Button type="button" variant="secondary">Cancelar</Button>
                            </a>
                            <Button type="submit" icon="save">Guardar Entrada</Button>
                        </div>
                    </Card>
                </form>
            </div>
        ) : (
            <div class="text-center py-20">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mb-4"></div>
                <p class="text-lg text-gray-500">{error || "Cargando datos..."}</p>
            </div>
        )}
    </div>

    <script define:vars={{ allParts }}>
        document.addEventListener('alpine:init', () => {
            Alpine.data('partsManager', () => ({
                allParts: allParts,
                search: '',
                filteredParts: [],
                usedParts: [],

                init() {
                    console.log('Alpine parts manager initialized with', this.allParts.length, 'parts');
                },

                filterParts() {
                    if (this.search === '') {
                        this.filteredParts = [];
                        return;
                    }
                    this.filteredParts = this.allParts.filter((part) =>
                        part.nombre.toLowerCase().includes(this.search.toLowerCase()) &&
                        !this.usedParts.some((used) => used.id === part.id)
                    );
                },

                addPart(part) {
                    if (!this.usedParts.some((p) => p.id === part.id)) {
                        this.usedParts.push({ ...part, quantity: 1 });
                        this.search = '';
                        this.filteredParts = [];
                    }
                },

                removePart(partId) {
                    this.usedParts = this.usedParts.filter((p) => p.id !== partId);
                },

                incrementQuantity(partId) {
                    const part = this.usedParts.find((p) => p.id === partId);
                    if (part && part.quantity < part.stock) {
                        part.quantity++;
                    }
                },

                decrementQuantity(partId) {
                    const part = this.usedParts.find((p) => p.id === partId);
                    if (part && part.quantity > 1) {
                        part.quantity--;
                    }
                }
            }));
        });
    </script>
</DashboardLayout>
