---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
const apiBase = import.meta.env.PUBLIC_STRAPI_URL || 'http://localhost:1337';

if (!userRole) {
  return Astro.redirect('/login');
}
---

<DashboardLayout title="Mis Solicitudes" role="mecanico" currentPath="/mecanico/mis_solicitudes">
  <div class="max-w-5xl mx-auto"
    x-data=`{
      apiBase: '${apiBase}',
      solicitudes: [],
      loading: true,
      lastUpdate: null,

      get pendientes() { return this.solicitudes.filter(s => s.estado === 'pendiente').length; },
      get aprobadas() { return this.solicitudes.filter(s => s.estado === 'aprobada').length; },
      get rechazadas() { return this.solicitudes.filter(s => s.estado === 'rechazada').length; },

      async fetchData() {
        try {
          const endpoint = this.apiBase + '/api/solicitud-de-repuestos?populate[repuesto][fields][0]=nombre&populate[repuesto][fields][1]=sku&populate[orden_de_trabajo][populate][vehiculo][fields][0]=marca&populate[orden_de_trabajo][populate][vehiculo][fields][1]=modelo&sort=createdAt:desc&pagination[limit]=50';
          const res = await fetch(endpoint);
          const data = await res.json();
          if (data.data) this.solicitudes = data.data;
          this.lastUpdate = new Date();
          this.loading = false;
        } catch (e) {
          console.error('Error:', e);
          this.loading = false;
        }
      },

      getEstadoClass(estado) {
        if (estado === 'aprobada') return 'bg-green-100 text-green-700';
        if (estado === 'rechazada') return 'bg-red-100 text-red-700';
        return 'bg-amber-100 text-amber-700';
      },

      getUrgenciaClass(urgencia) {
        if (urgencia === 'alta') return 'text-red-600 bg-red-50';
        if (urgencia === 'media') return 'text-orange-600 bg-orange-50';
        return 'text-gray-600 bg-gray-50';
      },

      formatDate(date) {
        return new Date(date).toLocaleDateString('es-CL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
      },

      getTimeSinceUpdate() {
        if (!this.lastUpdate) return '';
        const s = Math.floor((new Date() - this.lastUpdate) / 1000);
        return s < 60 ? 'hace ' + s + 's' : 'hace ' + Math.floor(s/60) + 'm';
      },

      init() {
        this.fetchData();
        setInterval(() => this.fetchData(), 15000);
      }
    }`
  >
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Mis Solicitudes de Repuestos</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1">Seguimiento del estado de tus pedidos.</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 text-sm text-gray-500 bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700">
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
          <span>Actualizado <span x-text="getTimeSinceUpdate()"></span></span>
          <button @click="fetchData()" class="text-primary-600 hover:text-primary-700 ml-1">
            <span class="material-symbols-outlined text-sm" :class="loading && 'animate-spin'">refresh</span>
          </button>
        </div>
        <a href="/mecanico/solicitar_repuesto" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 flex items-center gap-2">
          <span class="material-symbols-outlined">add</span>
          Nueva Solicitud
        </a>
      </div>
    </div>

    <!-- Loading -->
    <template x-if="loading">
      <div class="flex items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
      </div>
    </template>

    <template x-if="!loading">
      <div>
        <!-- Stats -->
        <div class="grid grid-cols-3 gap-4 mb-8">
          <div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl p-4 border border-amber-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                <span class="material-symbols-outlined text-amber-600">pending</span>
              </div>
              <div>
                <p class="text-2xl font-bold text-amber-800" x-text="pendientes">0</p>
                <p class="text-sm text-amber-600">Pendientes</p>
              </div>
            </div>
          </div>
          <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 border border-green-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                <span class="material-symbols-outlined text-green-600">check_circle</span>
              </div>
              <div>
                <p class="text-2xl font-bold text-green-800" x-text="aprobadas">0</p>
                <p class="text-sm text-green-600">Aprobadas</p>
              </div>
            </div>
          </div>
          <div class="bg-red-50 dark:bg-red-900/20 rounded-xl p-4 border border-red-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                <span class="material-symbols-outlined text-red-600">cancel</span>
              </div>
              <div>
                <p class="text-2xl font-bold text-red-800" x-text="rechazadas">0</p>
                <p class="text-sm text-red-600">Rechazadas</p>
              </div>
            </div>
          </div>
        </div>

        <!-- List -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
          <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">Historial de Solicitudes</h3>
          </div>
          
          <template x-if="solicitudes.length > 0">
            <div class="divide-y divide-gray-200 dark:divide-gray-700">
              <template x-for="s in solicitudes" :key="s.id">
                <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                  <div class="flex items-start justify-between gap-4">
                    <div class="flex items-start gap-4">
                      <div class="w-10 h-10 rounded-lg flex items-center justify-center" :class="getUrgenciaClass(s.urgencia)">
                        <span class="material-symbols-outlined">inventory_2</span>
                      </div>
                      <div>
                        <div class="flex items-center gap-2 mb-1">
                          <span class="font-bold text-gray-900 dark:text-white" x-text="s.repuesto?.nombre || 'Repuesto'"></span>
                          <span class="px-2 py-0.5 rounded-full text-xs font-medium" :class="getEstadoClass(s.estado)" x-text="s.estado.toUpperCase()"></span>
                        </div>
                        <p class="text-sm text-gray-500">
                          Cantidad: <span x-text="s.cantidad"></span> • SKU: <span x-text="s.repuesto?.sku || 'N/A'"></span>
                        </p>
                        <template x-if="s.orden_de_trabajo?.vehiculo">
                          <p class="text-xs text-gray-400 mt-1">
                            Para: <span x-text="s.orden_de_trabajo.vehiculo.marca + ' ' + s.orden_de_trabajo.vehiculo.modelo"></span>
                          </p>
                        </template>
                      </div>
                    </div>
                    <div class="text-right">
                      <p class="text-xs text-gray-400" x-text="formatDate(s.createdAt)"></p>
                      <span class="text-xs px-2 py-0.5 rounded" :class="getUrgenciaClass(s.urgencia)" x-text="'Urgencia: ' + s.urgencia"></span>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </template>

          <template x-if="solicitudes.length === 0">
            <div class="p-12 text-center">
              <span class="material-symbols-outlined text-4xl text-gray-300 mb-4">inventory_2</span>
              <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Sin solicitudes</h4>
              <p class="text-gray-500 mb-4">No tienes solicitudes de repuestos aún.</p>
              <a href="/mecanico/solicitar_repuesto" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                <span class="material-symbols-outlined">add</span>
                Crear Solicitud
              </a>
            </div>
          </template>
        </div>

        <!-- Back -->
        <div class="mt-6">
          <a href="/mecanico/dash_mec" class="text-gray-500 hover:text-primary-600 flex items-center gap-2">
            <span class="material-symbols-outlined">arrow_back</span>
            Volver al Dashboard
          </a>
        </div>
      </div>
    </template>
  </div>
</DashboardLayout>
