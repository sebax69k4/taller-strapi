---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import '../../styles/global.css';
import { strapiGet } from '../../lib/strapi';

const userRole = Astro.cookies.get('user_role')?.value;
const mecanicoId = Astro.cookies.get('mecanico_id')?.value;

if (!userRole || (userRole === 'mecanico' && !mecanicoId)) {
  return Astro.redirect('/login');
}

interface Order {
  id: number;
  descripcion: string;
  estado: string;
  createdAt: string;
  vehiculo?: {
    marca: string;
    modelo: string;
    imagen_url?: string;
  }
}

let assignedOrders: Order[] = [];
let filteredOrders: Order[] = [];
let mechanicName = "Mecánico";
let error = '';

// Status mapping for colors and text
const statusConfig: { [key: string]: { color: string; label: string; bg: string } } = {
  'Pendiente': { color: 'text-blue-700', bg: 'bg-blue-50', label: 'Pendiente' },
  'En Progreso': { color: 'text-yellow-700', bg: 'bg-yellow-50', label: 'En Progreso' },
  'Finalizada': { color: 'text-green-700', bg: 'bg-green-50', label: 'Finalizada' },
  'Bloqueada': { color: 'text-red-700', bg: 'bg-red-50', label: 'Bloqueada' },
  'Entregado': { color: 'text-gray-700', bg: 'bg-gray-50', label: 'Entregado' },
};

try {
  const userName = Astro.cookies.get('user_name')?.value;
  mechanicName = userName || 'Mecánico';

  // Fetch work orders assigned to the logged-in mechanic
  const ordersRes = await strapiGet(`/api/orden-de-trabajos?filters[mecanico][id][$eq]=${mecanicoId}&populate=vehiculo&sort=createdAt:desc`);
  assignedOrders = ordersRes.data || [];

} catch (e: any) {
  console.error('Error en el dashboard del mecánico:', e);
  error = e.message || 'Error de conexión con el servidor.';
}

// 3. Filter orders based on query param
const statusFilter = Astro.url.searchParams.get('status');
if (statusFilter && statusFilter !== 'Todas') {
  filteredOrders = assignedOrders.filter((order: Order) => order.estado === statusFilter);
} else {
  filteredOrders = assignedOrders;
}
---

<DashboardLayout title="Dashboard Mecánico" role="mecanico" currentPath={Astro.url.pathname}>
    <div class="flex flex-col gap-1">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Mis Órdenes de Trabajo</h1>
        <p class="text-gray-500 dark:text-gray-400">Hola {mechanicName}, aquí tienes un resumen de tus órdenes asignadas.</p>
    </div>

    {error && (
        <div class="p-4 text-sm text-red-700 bg-red-50 rounded-lg border border-red-100 flex items-center gap-2" role="alert">
            <span class="material-symbols-outlined text-lg">error</span>
            <span>{error}</span>
        </div>
    )}

    <div class="flex gap-2 overflow-x-auto pb-2">
        <a href="/mecanico/dash_mec?status=Todas" 
           class:list={[
               "flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap",
               !statusFilter || statusFilter === 'Todas' 
                   ? "bg-primary-600 text-white shadow-sm" 
                   : "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"
           ]}>
           Todas
        </a>
        {Object.keys(statusConfig).filter(s => s !== 'Entregado').map(status => (
            <a href={`/mecanico/dash_mec?status=${status}`} 
               class:list={[
                   "flex items-center justify-center px-4 py-2 rounded-lg text-sm font-medium transition-colors whitespace-nowrap",
                   statusFilter === status 
                       ? "bg-primary-600 text-white shadow-sm" 
                       : "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"
               ]}>
               {status}
            </a>
        ))}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredOrders.length > 0 ? (
            filteredOrders.map((order: Order) => {
                const statusInfo = statusConfig[order.estado] || { color: 'text-gray-700', bg: 'bg-gray-50', label: order.estado };
                const vehicleName = order.vehiculo ? `${order.vehiculo.marca} ${order.vehiculo.modelo}` : 'Vehículo no especificado';
                const imageUrl = order.vehiculo?.imagen_url || 'https://cdn.usegalileo.ai/stability/64938e55-2324-4692-a43a-99badb3a964a.png';

                return (
                    <Card noPadding class="flex flex-col h-full group hover:shadow-lg transition-all duration-300">
                        <div class="relative h-48 overflow-hidden">
                            <div class="absolute inset-0 bg-center bg-cover transition-transform duration-500 group-hover:scale-105" style={`background-image: url("${imageUrl}");`}></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                            <div class="absolute bottom-4 left-4 right-4">
                                <span class:list={["inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-white/90 backdrop-blur-sm shadow-sm", statusInfo.color]}>
                                    {statusInfo.label}
                                </span>
                            </div>
                        </div>
                        <div class="p-5 flex flex-col flex-1 gap-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white leading-tight">OT-{order.id} - {vehicleName}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">calendar_today</span>
                                    {new Date(order.createdAt).toLocaleDateString()}
                                </p>
                            </div>
                            
                            <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2 flex-1">
                                {order.descripcion || 'Sin descripción.'}
                            </p>
                            
                            <a href={`/mecanico/detalle_orden_trabajo?id=${order.id}`} class="mt-auto">
                                <Button variant="primary" block>
                                    Ver Detalles
                                </Button>
                            </a>
                        </div>
                    </Card>
                )
            })
        ) : (
            <div class="col-span-full py-12 flex flex-col items-center justify-center text-center">
                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
                    <span class="material-symbols-outlined text-3xl text-gray-400">assignment_late</span>
                </div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">No hay órdenes</h3>
                <p class="text-gray-500 dark:text-gray-400 max-w-sm mt-1">No tienes órdenes de trabajo asignadas con este filtro.</p>
                <a href="/mecanico/dash_mec?status=Todas" class="mt-4 text-primary-600 font-medium hover:underline">Ver todas las órdenes</a>
            </div>
        )}
    </div>
</DashboardLayout>