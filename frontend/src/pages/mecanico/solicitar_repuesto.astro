---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import { strapiGet, strapiPost } from '../../lib/strapi';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
const mecanicoId = Astro.cookies.get('mecanico_id')?.value;

if (!userRole) {
  return Astro.redirect('/login');
}

let repuestos: any[] = [];
let ordenes: any[] = [];
let message = '';
let messageType = '';

// Obtener mensaje de URL
const urlMessage = Astro.url.searchParams.get('message');
const urlType = Astro.url.searchParams.get('type');
if (urlMessage) {
  message = urlMessage;
  messageType = urlType || 'success';
}

try {
  // Obtener repuestos
  const repuestosData = await strapiGet('/api/repuestos?sort=nombre:asc&pagination[limit]=100');
  repuestos = repuestosData.data || [];

  // Obtener órdenes activas del mecánico
  let ordenesEndpoint = '/api/orden-de-trabajos?filters[estado][$notIn][0]=entregado&filters[estado][$notIn][1]=facturado&populate[vehiculo]=true&sort=updatedAt:desc';
  if (mecanicoId) {
    ordenesEndpoint = `/api/orden-de-trabajos?filters[mecanico][id][$eq]=${mecanicoId}&filters[estado][$notIn][0]=entregado&filters[estado][$notIn][1]=facturado&populate[vehiculo]=true&sort=updatedAt:desc`;
  }
  const ordenesData = await strapiGet(ordenesEndpoint);
  ordenes = ordenesData.data || [];

  // Manejar POST (Carrito)
  if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const cartJson = formData.get('cart') as string;
    const ordenId = formData.get('ordenId');
    
    if (cartJson && ordenId) {
        const cart = JSON.parse(cartJson);
        const orderResponse = await strapiGet(`/api/orden-de-trabajos/${ordenId}`);
        const orderNumericId = orderResponse.data?.id;

        let successCount = 0;
        let errors = [];

        for (const item of cart) {
            try {
                // Obtener ID numérico del repuesto
                // Nota: item.id debería ser el documentId si viene del frontend, necesitamos el ID numérico para la relación
                // O Strapi v5 usa documentId para relaciones? Depende de la config.
                // Asumiremos que necesitamos buscar el ID numérico o usar el que tenemos si ya es numérico.
                // En el frontend pasaremos el objeto repuesto completo.
                
                // Crear solicitud
                await strapiPost('/api/solicitud-de-repuestos', {
                    cantidad: parseInt(item.cantidad),
                    urgencia: item.urgencia,
                    estado: 'pendiente',
                    observaciones: item.notas || '',
                    repuesto: item.repuesto.id, // ID numérico
                    orden_de_trabajo: orderNumericId
                });
                successCount++;
            } catch (err: any) {
                console.error('Error requesting part:', err);
                errors.push(item.repuesto.nombre);
            }
        }

        if (successCount > 0) {
            // Log en bitácora
            await strapiPost('/api/bitacoras', {
                procedimientos: `[SOLICITUD] Se solicitaron ${successCount} repuestos al encargado.`,
                fecha: new Date().toISOString().split('T')[0],
                orden_de_trabajo: orderNumericId,
            });
            
            return Astro.redirect(`/mecanico/solicitar_repuesto?message=${encodeURIComponent(`Se enviaron ${successCount} solicitudes correctamente.`)}&type=success`);
        } else {
             return Astro.redirect(`/mecanico/solicitar_repuesto?message=${encodeURIComponent('Error al procesar las solicitudes.')}&type=error`);
        }
    }
  }

} catch (e) {
  console.error(e);
}
---

<DashboardLayout title="Solicitar Repuestos" role="mecanico" currentPath="/mecanico/solicitar_repuesto">
  <div class="max-w-6xl mx-auto" x-data="requestCart()">
    
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Solicitar Repuestos</h1>
      <p class="text-gray-500 dark:text-gray-400 mt-2">Gestiona tus pedidos de piezas al encargado.</p>
    </div>

    {message && (
      <div class={`p-4 mb-6 rounded-lg border flex items-center gap-3 ${messageType === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
        <span class="material-symbols-outlined">{messageType === 'success' ? 'check_circle' : 'error'}</span>
        <p>{message}</p>
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <!-- Left Column: Selection -->
      <div class="lg:col-span-2 space-y-6">
        
        <!-- Order Selection -->
        <Card>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">1. Seleccionar Orden de Trabajo</label>
            <select x-model="selectedOrder" class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 py-3">
                <option value="">-- Seleccione una orden --</option>
                {ordenes.map(orden => (
                    <option value={orden.documentId}>
                        OT-{orden.id} • {orden.vehiculo?.marca} {orden.vehiculo?.modelo}
                    </option>
                ))}
            </select>
        </Card>

        <!-- Part Selection -->
        <Card class="relative" x-bind:class="!selectedOrder ? 'opacity-50 pointer-events-none' : ''">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">2. Buscar y Agregar Repuestos</label>
            
            <div class="flex gap-4 mb-4">
                <div class="flex-1 relative">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input 
                        type="text" 
                        x-model="search" 
                        placeholder="Buscar por nombre o SKU..." 
                        class="w-full pl-10 rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900"
                    >
                    <!-- Dropdown Results -->
                    <div x-show="search.length > 1 && !selectedPart" class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                        <template x-for="part in filteredParts" :key="part.id">
                            <div @click="selectPart(part)" class="p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-0">
                                <div class="flex justify-between">
                                    <span class="font-medium text-gray-900 dark:text-white" x-text="part.nombre"></span>
                                    <span class="text-xs font-bold" :class="part.stock > 0 ? 'text-green-600' : 'text-red-600'" x-text="'Stock: ' + part.stock"></span>
                                </div>
                                <p class="text-xs text-gray-500" x-text="'SKU: ' + part.sku"></p>
                            </div>
                        </template>
                        <div x-show="filteredParts.length === 0" class="p-3 text-sm text-gray-500 text-center">No se encontraron repuestos</div>
                    </div>
                </div>
            </div>

            <!-- Selected Part Config -->
            <div x-show="selectedPart" class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="font-bold text-gray-900 dark:text-white" x-text="selectedPart?.nombre"></h4>
                        <p class="text-sm text-gray-500" x-text="selectedPart?.sku"></p>
                    </div>
                    <button @click="selectedPart = null; search = ''" class="text-gray-400 hover:text-red-500">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Cantidad</label>
                        <input type="number" x-model="quantity" min="1" class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Urgencia</label>
                        <select x-model="urgency" class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800">
                            <option value="baja">Baja</option>
                            <option value="media">Media</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Notas (Opcional)</label>
                    <input type="text" x-model="notes" placeholder="Ej: Marca específica..." class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800">
                </div>

                <div class="mt-4 flex justify-end">
                    <button @click="addToCart()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 flex items-center gap-2">
                        <span class="material-symbols-outlined">add_shopping_cart</span>
                        Agregar al Pedido
                    </button>
                </div>
            </div>
        </Card>
      </div>

      <!-- Right Column: Cart -->
      <div class="lg:col-span-1">
        <Card class="sticky top-6 h-[calc(100vh-100px)] flex flex-col">
            <div class="flex items-center gap-2 mb-4 pb-4 border-b border-gray-100 dark:border-gray-700">
                <span class="material-symbols-outlined text-primary-600">shopping_cart</span>
                <h2 class="font-bold text-lg text-gray-900 dark:text-white">Tu Pedido</h2>
                <span class="ml-auto bg-primary-100 text-primary-800 text-xs font-bold px-2 py-1 rounded-full" x-text="cart.length">0</span>
            </div>

            <div class="flex-1 overflow-y-auto space-y-3 pr-2">
                <template x-for="(item, index) in cart" :key="index">
                    <div class="p-3 bg-gray-50 dark:bg-gray-900/30 rounded-lg border border-gray-200 dark:border-gray-700 relative group">
                        <button @click="removeFromCart(index)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                        <p class="font-medium text-sm text-gray-900 dark:text-white pr-6" x-text="item.repuesto.nombre"></p>
                        <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                            <span class="bg-white dark:bg-gray-800 px-1.5 py-0.5 rounded border border-gray-200 dark:border-gray-600" x-text="'x' + item.cantidad"></span>
                            <span class="capitalize" :class="{
                                'text-red-600 font-bold': item.urgencia === 'alta',
                                'text-orange-600': item.urgencia === 'media'
                            }" x-text="item.urgencia"></span>
                        </div>
                        <p x-show="item.notas" class="text-xs text-gray-400 mt-1 italic" x-text="item.notas"></p>
                    </div>
                </template>
                
                <div x-show="cart.length === 0" class="text-center py-10 text-gray-400">
                    <span class="material-symbols-outlined text-4xl mb-2 opacity-50">remove_shopping_cart</span>
                    <p class="text-sm">El carrito está vacío</p>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                <form method="POST">
                    <input type="hidden" name="cart" :value="JSON.stringify(cart)">
                    <input type="hidden" name="ordenId" :value="selectedOrder">
                    
                    <button 
                        type="submit" 
                        class="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-all shadow-lg shadow-green-600/20 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        :disabled="cart.length === 0 || !selectedOrder"
                    >
                        <span class="material-symbols-outlined">send</span>
                        Enviar Solicitud
                    </button>
                </form>
            </div>
        </Card>
      </div>

    </div>
  </div>
</DashboardLayout>

<script define:vars={{ repuestos }}>
  document.addEventListener('alpine:init', () => {
    Alpine.data('requestCart', () => ({
      repuestos: repuestos,
      selectedOrder: '',
      search: '',
      selectedPart: null,
      quantity: 1,
      urgency: 'media',
      notes: '',
      cart: [],

      get filteredParts() {
        if (this.search.length < 2) return [];
        return this.repuestos.filter(p => 
          p.nombre.toLowerCase().includes(this.search.toLowerCase()) || 
          p.sku.toLowerCase().includes(this.search.toLowerCase())
        ).slice(0, 10);
      },

      selectPart(part) {
        this.selectedPart = part;
        this.quantity = 1;
        this.urgency = 'media';
        this.notes = '';
        this.search = '';
      },

      addToCart() {
        if (!this.selectedPart) return;
        
        this.cart.push({
            repuesto: this.selectedPart,
            cantidad: this.quantity,
            urgencia: this.urgency,
            notas: this.notes
        });

        this.selectedPart = null;
        this.search = '';
      },

      removeFromCart(index) {
        this.cart.splice(index, 1);
      }
    }));
  });
</script>
