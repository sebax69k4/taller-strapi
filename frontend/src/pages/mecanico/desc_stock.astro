---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import { strapiGet, strapiPut } from '../../lib/strapi';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

let allParts: any[] = [];
let error = '';
let success = '';

try {
  if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const partsData = formData.get('parts') as string;
    const partsToDeduct = JSON.parse(partsData); // [{ id, quantity, stock }]

    // Process deductions
    for (const part of partsToDeduct) {
      const newStock = part.stock - part.quantity;
      if (newStock < 0) throw new Error(`Stock insuficiente para ${part.nombre}`);
      
      await strapiPut(`/api/repuestos/${part.id}`, {
        stock: newStock
      });
    }

    success = 'Stock descontado correctamente.';
  }

  // Fetch all parts
  const response = await strapiGet('/api/repuestos');
  allParts = response.data || [];

} catch (e: any) {
  console.error(e);
  error = e.message;
}
---

<DashboardLayout title="Descontar Stock" role="mecanico" currentPath={Astro.url.pathname}>
    <div class="max-w-4xl mx-auto">
        <div class="flex flex-col gap-2 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Descontar Stock Manual</h1>
            <p class="text-gray-500 dark:text-gray-400">Registra salidas de repuestos fuera de órdenes de trabajo.</p>
        </div>

        {error && <div class="bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6" role="alert">{error}</div>}
        {success && <div class="bg-green-100 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-6" role="alert">{success}</div>}

        <Card>
            <div x-data={`stockManager(${JSON.stringify(allParts)})`}>
                <form method="POST">
                    <div class="flex flex-col gap-6">
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Buscar Repuestos</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="material-symbols-outlined text-gray-400">search</span>
                                </div>
                                <input 
                                    type="search" 
                                    x-model="search" 
                                    @input.debounce.300ms="filterParts" 
                                    class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 dark:border-gray-700 rounded-lg leading-5 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm" 
                                    placeholder="Buscar por nombre o código..."
                                />
                            </div>
                            
                            <!-- Search Results -->
                            <div x-show="search.length > 0 && filteredParts.length > 0" x-cloak class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                <template x-for="part in filteredParts" :key="part.id">
                                    <div @click="addPart(part)" class="cursor-pointer px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-700 last:border-0 flex justify-between items-center transition-colors">
                                        <div>
                                            <span class="font-medium text-gray-900 dark:text-white block" x-text="part.nombre"></span>
                                            <span class="text-xs text-gray-500 dark:text-gray-400" x-text="`ID: ${part.id}`"></span>
                                        </div>
                                        <span class="text-xs font-semibold px-2 py-1 rounded-full" :class="part.stock > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" x-text="`Stock: ${part.stock}`"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Selected Parts List -->
                        <div class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-800/50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Repuesto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Stock Actual</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">A Descontar</th>
                                        <th class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <template x-if="selectedParts.length === 0">
                                        <tr><td colspan="4" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400 text-sm">No hay repuestos seleccionados.</td></tr>
                                    </template>
                                    <template x-for="part in selectedParts" :key="part.id">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white" x-text="part.nombre"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="part.stock"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                <div class="flex items-center gap-2">
                                                    <button type="button" @click="decrement(part.id)" class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">-</button>
                                                    <span class="w-8 text-center font-medium" x-text="part.quantity"></span>
                                                    <button type="button" @click="increment(part.id)" class="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">+</button>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button type="button" @click="remove(part.id)" class="text-red-600 hover:text-red-900">
                                                    <span class="material-symbols-outlined">delete</span>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <input type="hidden" name="parts" :value="JSON.stringify(selectedParts)">

                        <div class="flex justify-end pt-4">
                            <Button type="submit" icon="check_circle" :disabled="selectedParts.length === 0">Confirmar Descuento</Button>
                        </div>
                    </div>
                </form>
            </div>
        </Card>
    </div>

    <script>
        function stockManager(allParts) {
            return {
                allParts: allParts,
                search: '',
                filteredParts: [],
                selectedParts: [],

                filterParts() {
                    if (this.search === '') {
                        this.filteredParts = [];
                        return;
                    }
                    this.filteredParts = this.allParts.filter(part => 
                        part.nombre.toLowerCase().includes(this.search.toLowerCase()) &&
                        !this.selectedParts.some(p => p.id === part.id)
                    );
                },

                addPart(part) {
                    this.selectedParts.push({ ...part, quantity: 1 });
                    this.search = '';
                    this.filteredParts = [];
                },

                remove(id) {
                    this.selectedParts = this.selectedParts.filter(p => p.id !== id);
                },

                increment(id) {
                    const part = this.selectedParts.find(p => p.id === id);
                    if (part && part.quantity < part.stock) part.quantity++;
                },

                decrement(id) {
                    const part = this.selectedParts.find(p => p.id === id);
                    if (part && part.quantity > 1) part.quantity--;
                }
            }
        }
    </script>
</DashboardLayout>