---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Input from '../../components/ui/Input.astro';
import { strapiGet, strapiPost } from '../../lib/strapi';
import { validatePatente, validateVehicleYear, validateRequired } from '../../lib/validations';


// TypeScript Interfaces for Strapi Data
interface ClienteAttributes {
  nombre: string;
  apellido: string;
  rut: string;
  createdAt: string;
  updatedAt: string;
  publishedAt: string;
}

interface Cliente {
  id: number;
  nombre: string;
  apellido: string;
  rut: string;
  telefono?: string;
  attributes?: ClienteAttributes;
}

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

let message = Astro.url.searchParams.get('message');
let messageType = Astro.url.searchParams.get('type');
let clientes: Cliente[] = [];
let validationErrors: string[] = [];

try {
    const response = await strapiGet('/api/clientes?sort=nombre:asc');
    clientes = response.data || [];
} catch (error: any) {
    console.error('Error fetching clients:', error);
    message = 'Error al cargar la lista de clientes. ' + error.message;
    messageType = 'error';
}


if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const clienteId = formData.get('cliente')?.toString() || '';
    const patente = formData.get('patente')?.toString().toUpperCase().trim() || '';
    const marca = formData.get('marca')?.toString().trim() || '';
    const modelo = formData.get('modelo')?.toString().trim() || '';
    const anio = formData.get('anio')?.toString() || '';
    const vin = formData.get('vin')?.toString().trim() || '';
    const color = formData.get('color')?.toString().trim() || '';
    const tipoCombustible = formData.get('tipo_combustible')?.toString() || '';
    const kilometraje = formData.get('kilometraje')?.toString() || '';
    const observaciones = formData.get('observaciones')?.toString().trim() || '';

    // Validaciones del servidor
    if (!clienteId) validationErrors.push('Debe seleccionar un cliente');

    const patenteVal = validatePatente(patente);
    if (!patenteVal.valid) validationErrors.push(patenteVal.message);

    const result = await strapiPost('/api/vehiculos', {
      patente,
      marca,
      modelo,
      ano: parseInt(anio, 10),
      numero_de_chasis: vin || null,
      color: color || null,
      tipo_combustible: tipoCombustible || null,
      kilometraje: kilometraje ? parseInt(kilometraje, 10) : null,
      observaciones: observaciones || null,
      cliente: parseInt(clienteId, 10)
    });

    const successMessage = `Veh√≠culo con patente "${patente}" creado y asociado exitosamente.`;
    return Astro.redirect(`/recepcion/crear_vehiculo?message=${encodeURIComponent(successMessage)}&type=success`);

  } catch (error: any) {
    const errorMessage = error.message || 'Error al crear el veh√≠culo.';
    return Astro.redirect(`/recepcion/crear_vehiculo?message=${encodeURIComponent(errorMessage)}&type=error`);
  }
}
---

<DashboardLayout title="A√±adir Nuevo Veh√≠culo" role="recepcionista" currentPath={Astro.url.pathname}>
    <script is:inline>
    document.addEventListener('alpine:init', () => {
        Alpine.data('vehiculoFormValidator', (initialData) => ({
            cliente: initialData.cliente || '',
            patente: initialData.patente || '',
            marca: initialData.marca || '',
            modelo: initialData.modelo || '',
            anio: initialData.anio || '',
            vin: initialData.vin || '',
            color: initialData.color || '',
            tipo_combustible: initialData.tipo_combustible || '',
            kilometraje: initialData.kilometraje || '',
            observaciones: initialData.observaciones || '',
            errors: {},
            touched: {},
            serverMessage: initialData.serverMessage || '',
            serverMessageType: initialData.serverMessageType || '',
            isSubmitting: false,

            // Lista de marcas populares para autocompletado
            marcasPopulares: ['Toyota', 'Chevrolet', 'Hyundai', 'Kia', 'Nissan', 'Mazda', 'Suzuki', 'Ford', 'Volkswagen', 'Honda', 'Mitsubishi', 'Subaru', 'Peugeot', 'Renault', 'Fiat', 'Jeep', 'RAM', 'BMW', 'Mercedes-Benz', 'Audi'],
            
            // Lista de colores comunes
            coloresComunes: ['Blanco', 'Negro', 'Gris', 'Plata', 'Rojo', 'Azul', 'Verde', 'Amarillo', 'Naranja', 'Caf√©', 'Beige', 'Dorado'],

            formatPatente(patente) {
                return patente.toUpperCase().replace(/[^A-Z0-9]/g, '');
            },

            onPatenteInput(event) {
                this.patente = this.formatPatente(event.target.value);
                event.target.value = this.patente;
                if (this.touched.patente) this.validateField('patente');
            },

            formatKilometraje(value) {
                // Remover caracteres no num√©ricos
                return value.replace(/[^0-9]/g, '');
            },

            onKilometrajeInput(event) {
                this.kilometraje = this.formatKilometraje(event.target.value);
                event.target.value = this.kilometraje;
            },

            validateField(field) {
                this.touched[field] = true;
                delete this.errors[field];

                switch (field) {
                    case 'cliente':
                        if (!this.cliente) {
                            this.errors.cliente = 'Debe seleccionar un cliente';
                        }
                        break;
                    case 'patente':
                        const cleanPatente = this.formatPatente(this.patente);
                        if (!cleanPatente) {
                            this.errors.patente = 'La patente es obligatoria';
                        } else {
                            const formatoNuevo = /^[A-Z]{4}\d{2}$/;
                            const formatoAntiguo = /^[A-Z]{2}\d{4}$/;
                            const formatoIntermedio = /^[A-Z]{3}\d{3}$/;
                            if (!formatoNuevo.test(cleanPatente) && !formatoAntiguo.test(cleanPatente) && !formatoIntermedio.test(cleanPatente)) {
                                this.errors.patente = 'Formato inv√°lido. Use: ABCD12, AB1234 o ABC123';
                            }
                        }
                        break;
                    case 'marca':
                        if (!this.marca.trim()) {
                            this.errors.marca = 'La marca es obligatoria';
                        }
                        break;
                    case 'modelo':
                        if (!this.modelo.trim()) {
                            this.errors.modelo = 'El modelo es obligatorio';
                        }
                        break;
                    case 'anio':
                        const currentYear = new Date().getFullYear();
                        const yearNum = parseInt(this.anio);
                        if (isNaN(yearNum)) {
                            this.errors.anio = 'El a√±o debe ser un n√∫mero';
                        } else if (yearNum < 1900) {
                            this.errors.anio = 'El a√±o no puede ser anterior a 1900';
                        } else if (yearNum > currentYear + 1) {
                            this.errors.anio = `El a√±o no puede ser mayor a ${currentYear + 1}`;
                        }
                        break;
                    case 'kilometraje':
                        if (this.kilometraje && parseInt(this.kilometraje) < 0) {
                            this.errors.kilometraje = 'El kilometraje no puede ser negativo';
                        }
                        break;
                }
                return !this.errors[field];
            },

            validateAll() {
                ['cliente', 'patente', 'marca', 'modelo', 'anio'].forEach(f => this.validateField(f));
                return Object.keys(this.errors).length === 0;
            },

            get isValid() {
                return Object.keys(this.errors).length === 0 && 
                       this.cliente && this.patente && this.marca && this.modelo && this.anio;
            },

            submitForm(event) {
                if (!this.validateAll()) {
                    event.preventDefault();
                    return false;
                }
                this.isSubmitting = true;
                return true;
            }
        }));
    });
    </script>
    <div class="w-full max-w-4xl mx-auto" x-data={`vehiculoFormValidator(${JSON.stringify({ cliente: '', patente: '', marca: '', modelo: '', anio: '', vin: '', color: '', tipo_combustible: '', kilometraje: '', observaciones: '', serverMessage: message || '', serverMessageType: messageType || '' })})`}>
        <div class="flex flex-col gap-2 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">A√±adir Nuevo Veh√≠culo</h1>
            <p class="text-gray-500 dark:text-gray-400">Seleccione un cliente y complete los detalles para registrar un nuevo veh√≠culo.</p>
        </div>

        <!-- Server Message -->
        <template x-if="serverMessage">
            <div x-show="serverMessage" x-transition class="p-4 mb-6 rounded-lg text-sm flex items-center gap-2" :class="{ 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300': serverMessageType === 'success', 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300': serverMessageType === 'error' }" role="alert">
                <span class="material-symbols-outlined text-lg" x-text="serverMessageType === 'success' ? 'check_circle' : 'error'"></span>
                <span x-text="serverMessage"></span>
            </div>
        </template>

        <Card>
            <form method="POST" @submit="submitForm($event)" class="space-y-8">
                <!-- Client Selection -->
                <div>
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 text-xs">1</span>
                        Selecci√≥n de Cliente
                    </h2>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Cliente Existente <span class="text-red-500">*</span></label>
                        <select 
                            name="cliente" 
                            x-model="cliente"
                            @change="validateField('cliente')"
                            class="form-select w-full rounded-lg bg-white dark:bg-gray-800 focus:ring-primary-500 dark:text-gray-200 transition-colors"
                            :class="errors.cliente ? 'border-red-500 focus:ring-red-500 focus:border-red-500' : 'border-gray-300 dark:border-gray-700 focus:border-primary-500'"
                            required
                        >
                            <option value="" disabled>Seleccione un cliente...</option>
                            {clientes.map((cliente: any) => (
                                <option value={cliente.id}>{cliente.nombre} {cliente.apellido} ({cliente.rut}) {cliente.telefono ? `- ${cliente.telefono}` : ''}</option>
                            ))}
                        </select>
                        <p x-show="errors.cliente" x-text="errors.cliente" class="mt-1 text-sm text-red-600 dark:text-red-400"></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">El veh√≠culo se asociar√° a este cliente. Si el cliente no existe, <a href="/recepcion/crear_cliente" class="text-primary-600 hover:underline">cr√©elo aqu√≠</a>.</p>
                    </div>
                </div>

                <div class="border-t border-gray-100 dark:border-gray-800"></div>

                <!-- Vehicle Details -->
                <div>
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 text-xs">2</span>
                        Identificaci√≥n del Veh√≠culo
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Patente -->
                        <div>
                            <label for="patente" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Patente <span class="text-red-500">*</span></label>
                            <input 
                                type="text"
                                name="patente" 
                                id="patente"
                                x-model="patente"
                                @input="onPatenteInput($event)"
                                @blur="validateField('patente')"
                                placeholder="ABCD12"
                                maxlength="6"
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white transition-colors uppercase font-mono text-lg tracking-wider"
                                :class="errors.patente ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 dark:border-gray-600'"
                                required
                            />
                            <p x-show="errors.patente" x-text="errors.patente" class="mt-1 text-sm text-red-600 dark:text-red-400"></p>
                            <p x-show="!errors.patente && touched.patente && patente" class="mt-1 text-sm text-green-600 dark:text-green-400 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">check_circle</span> Patente v√°lida
                            </p>
                        </div>
                        
                        <!-- Marca -->
                        <div>
                            <label for="marca" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Marca <span class="text-red-500">*</span></label>
                            <input 
                                type="text"
                                name="marca" 
                                id="marca"
                                x-model="marca"
                                @blur="validateField('marca')"
                                @input="touched.marca && validateField('marca')"
                                placeholder="Ej: Toyota"
                                list="marcas-list"
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white transition-colors"
                                :class="errors.marca ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 dark:border-gray-600'"
                                required
                            />
                            <datalist id="marcas-list">
                                <template x-for="m in marcasPopulares" :key="m">
                                    <option :value="m"></option>
                                </template>
                            </datalist>
                            <p x-show="errors.marca" x-text="errors.marca" class="mt-1 text-sm text-red-600 dark:text-red-400"></p>
                        </div>
                        
                        <!-- Modelo -->
                        <div>
                            <label for="modelo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Modelo <span class="text-red-500">*</span></label>
                            <input 
                                type="text"
                                name="modelo" 
                                id="modelo"
                                x-model="modelo"
                                @blur="validateField('modelo')"
                                @input="touched.modelo && validateField('modelo')"
                                placeholder="Ej: Yaris"
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white transition-colors"
                                :class="errors.modelo ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 dark:border-gray-600'"
                                required
                            />
                            <p x-show="errors.modelo" x-text="errors.modelo" class="mt-1 text-sm text-red-600 dark:text-red-400"></p>
                        </div>
                        
                        <!-- A√±o -->
                        <div>
                            <label for="anio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">A√±o <span class="text-red-500">*</span></label>
                            <input 
                                type="number"
                                name="anio" 
                                id="anio"
                                x-model="anio"
                                @blur="validateField('anio')"
                                @input="touched.anio && validateField('anio')"
                                placeholder="Ej: 2022"
                                min="1900"
                                max={new Date().getFullYear() + 1}
                                class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white transition-colors"
                                :class="errors.anio ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 dark:border-gray-600'"
                                required
                            />
                            <p x-show="errors.anio" x-text="errors.anio" class="mt-1 text-sm text-red-600 dark:text-red-400"></p>
                        </div>

                        <!-- Color -->
                        <div>
                            <label for="color" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Color</label>
                            <input 
                                type="text"
                                name="color" 
                                id="color"
                                x-model="color"
                                placeholder="Ej: Blanco"
                                list="colores-list"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white transition-colors"
                            />
                            <datalist id="colores-list">
                                <template x-for="c in coloresComunes" :key="c">
                                    <option :value="c"></option>
                                </template>
                            </datalist>
                        </div>

                        <!-- Tipo de Combustible -->
                        <div>
                            <label for="tipo_combustible" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo de Combustible</label>
                            <select 
                                name="tipo_combustible" 
                                id="tipo_combustible"
                                x-model="tipo_combustible"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white transition-colors"
                            >
                                <option value="">Seleccionar...</option>
                                <option value="bencina">üõ¢Ô∏è Bencina</option>
                                <option value="diesel">‚õΩ Diesel</option>
                                <option value="hibrido">üîã H√≠brido</option>
                                <option value="electrico">‚ö° El√©ctrico</option>
                                <option value="gas">üí® Gas (GLP/GNC)</option>
                            </select>
                        </div>
                        
                        <!-- VIN -->
                        <div>
                            <label for="vin" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">N¬∫ de Chasis (VIN)</label>
                            <input 
                                type="text"
                                name="vin" 
                                id="vin"
                                x-model="vin"
                                placeholder="17 caracteres"
                                maxlength="17"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white transition-colors font-mono uppercase"
                            />
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">N√∫mero de identificaci√≥n del veh√≠culo (opcional)</p>
                        </div>

                        <!-- Kilometraje -->
                        <div>
                            <label for="kilometraje" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Kilometraje Actual</label>
                            <div class="relative">
                                <input 
                                    type="text"
                                    name="kilometraje" 
                                    id="kilometraje"
                                    x-model="kilometraje"
                                    @input="onKilometrajeInput($event)"
                                    @blur="validateField('kilometraje')"
                                    placeholder="Ej: 45000"
                                    class="w-full px-3 py-2 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white transition-colors"
                                    :class="errors.kilometraje ? 'border-red-500 focus:ring-red-500' : ''"
                                />
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">km</span>
                            </div>
                            <p x-show="errors.kilometraje" x-text="errors.kilometraje" class="mt-1 text-sm text-red-600 dark:text-red-400"></p>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-100 dark:border-gray-800"></div>

                <!-- Additional Info -->
                <div>
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 text-xs">3</span>
                        Informaci√≥n Adicional
                    </h2>
                    
                    <!-- Observaciones -->
                    <div>
                        <label for="observaciones" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Observaciones / Notas</label>
                        <textarea 
                            name="observaciones" 
                            id="observaciones"
                            x-model="observaciones"
                            rows="3"
                            placeholder="Ingrese cualquier observaci√≥n relevante sobre el veh√≠culo: estado general, detalles cosm√©ticos, historial conocido, etc."
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-800 dark:text-white transition-colors resize-none"
                        ></textarea>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Informaci√≥n adicional que pueda ser √∫til para el taller</p>
                    </div>
                </div>

                <div class="border-t border-gray-100 dark:border-gray-800"></div>

                <!-- Action Area -->
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 pt-2">
                    <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg">info</span>
                        Los campos marcados con <span class="text-red-500">*</span> son obligatorios
                    </div>
                    <div class="flex gap-3">
                        <a href="/recepcion/dash_recep">
                            <Button type="button" variant="secondary">
                                Cancelar
                            </Button>
                        </a>
                        <button 
                            type="submit" 
                            :disabled="isSubmitting || Object.keys(errors).length > 0"
                            class="inline-flex items-center gap-2 px-6 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
                        >
                            <span class="material-symbols-outlined text-lg" x-show="!isSubmitting">add_circle</span>
                            <span class="material-symbols-outlined text-lg animate-spin" x-show="isSubmitting">progress_activity</span>
                            <span x-text="isSubmitting ? 'Guardando...' : 'Guardar Veh√≠culo'"></span>
                        </button>
                    </div>
                </div>
            </form>
        </Card>
    </div>
</DashboardLayout>