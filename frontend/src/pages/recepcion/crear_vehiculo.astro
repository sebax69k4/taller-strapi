---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Input from '../../components/ui/Input.astro';
import { fetchStrapi, strapiGet, strapiPost, strapiPut } from '../../lib/strapi';


// TypeScript Interfaces for Strapi Data
interface ClienteAttributes {
  nombre: string;
  apellido: string;
  rut: string;
  createdAt: string;
  updatedAt: string;
  publishedAt: string;
}

interface Cliente {
  id: number;
  nombre: string;
  apellido: string;
  rut: string;
  attributes?: ClienteAttributes;
}

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

let message = Astro.url.searchParams.get('message');
let messageType = Astro.url.searchParams.get('type');
let clientes: Cliente[] = [];

try {
    const response = await strapiGet('/api/clientes?sort=nombre:asc');
    clientes = response.data || [];
} catch (error: any) {
    console.error('Error fetching clients:', error);
    message = 'Error al cargar la lista de clientes. ' + error.message;
    messageType = 'error';
}


if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const clienteId = formData.get('cliente');
    const patente = formData.get('patente');
    const marca = formData.get('marca');
    const modelo = formData.get('modelo');
    const anio = formData.get('anio');
    const vin = formData.get('vin');

    // Basic validation
    if (!clienteId || !patente || !marca || !modelo || !anio) {
        return Astro.redirect(`/recepcion/crear_vehiculo?message=${encodeURIComponent('Todos los campos obligatorios deben ser completados.')}&type=error`);
    }

    const result = await strapiPost('/api/vehiculos', {
      patente,
      marca,
      modelo,
      ano: parseInt(anio as string, 10),
      numero_de_chasis: vin || null,
      cliente: parseInt(clienteId as string, 10)
    });

    const successMessage = `Vehículo con patente "${patente}" creado y asociado exitosamente.`;
    return Astro.redirect(`/recepcion/crear_vehiculo?message=${encodeURIComponent(successMessage)}&type=success`);

  } catch (error: any) {
    const errorMessage = error.message || 'Error al crear el vehículo.';
    return Astro.redirect(`/recepcion/crear_vehiculo?message=${encodeURIComponent(errorMessage)}&type=error`);
  }
}
---

<DashboardLayout title="Añadir Nuevo Vehículo" role="recepcionista" currentPath={Astro.url.pathname}>
    <div class="w-full max-w-3xl mx-auto" x-data={`{ message: ${JSON.stringify(message || '')}, messageType: ${JSON.stringify(messageType || '')} }`}>
        <div class="flex flex-col gap-2 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Añadir Nuevo Vehículo</h1>
            <p class="text-gray-500 dark:text-gray-400">Seleccione un cliente y complete los detalles para registrar un nuevo vehículo.</p>
        </div>

        <template x-if="message">
            <div x-show="message" x-transition class="p-4 mb-6 rounded-lg text-sm flex items-center gap-2" :class="{ 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300': messageType === 'success', 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300': messageType === 'error' }" role="alert">
                <span class="material-symbols-outlined text-lg" x-text="messageType === 'success' ? 'check_circle' : 'error'"></span>
                <span x-text="message"></span>
            </div>
        </template>

        <Card>
            <form method="POST" class="space-y-8">
                <!-- Client Selection -->
                <div>
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 text-xs">1</span>
                        Selección de Cliente
                    </h2>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Cliente Existente</label>
                        <select name="cliente" class="form-select w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200" required>
                            <option value="" disabled selected>Seleccione un cliente...</option>
                            {clientes.map((cliente: any) => (
                                <option value={cliente.id}>{cliente.nombre} {cliente.apellido} ({cliente.rut})</option>
                            ))}
                        </select>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">El vehículo se asociará a este cliente. Si el cliente no existe, <a href="/recepcion/crear_cliente" class="text-primary-600 hover:underline">créelo aquí</a>.</p>
                    </div>
                </div>

                <div class="border-t border-gray-100 dark:border-gray-800"></div>

                <!-- Vehicle Details -->
                <div>
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-600 text-xs">2</span>
                        Detalles del Vehículo
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <Input 
                            name="patente" 
                            id="patente" 
                            label="Patente" 
                            placeholder="ABCD12" 
                            required 
                        />
                        
                        <Input 
                            name="marca" 
                            id="marca" 
                            label="Marca" 
                            placeholder="Ej: Toyota" 
                            required 
                        />
                        
                        <Input 
                            name="modelo" 
                            id="modelo" 
                            label="Modelo" 
                            placeholder="Ej: Yaris" 
                            required 
                        />
                        
                        <Input 
                            name="anio" 
                            id="anio" 
                            label="Año" 
                            type="number"
                            placeholder="Ej: 2022" 
                            min="1900" 
                            max={new Date().getFullYear() + 1}
                            required 
                        />
                        
                        <Input 
                            name="vin" 
                            id="vin" 
                            label="Nº de Chasis (VIN)" 
                            placeholder="Opcional" 
                            class="sm:col-span-2"
                        />
                    </div>
                </div>

                <div class="border-t border-gray-100 dark:border-gray-800"></div>

                <!-- Action Area -->
                <div class="flex justify-end gap-3 pt-2">
                    <a href="/recepcion/dash_recep">
                        <Button type="button" variant="secondary">
                            Cancelar
                        </Button>
                    </a>
                    <Button type="submit" icon="add_circle">
                        Guardar Vehículo
                    </Button>
                </div>
            </form>
        </Card>
    </div>
    <script src="//unpkg.com/alpinejs" defer></script>
</DashboardLayout>