---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
const userName = Astro.cookies.get('user_name')?.value || 'Recepcionista';
const apiBase = import.meta.env.PUBLIC_STRAPI_URL || 'http://localhost:1337';

if (!userRole) {
  return Astro.redirect('/login');
}

const currentHour = new Date().getHours();
const getGreeting = () => {
  if (currentHour < 12) return '¡Buenos días';
  if (currentHour < 18) return '¡Buenas tardes';
  return '¡Buenas noches';
};
---

<DashboardLayout title="Dashboard Recepción" role="recepcionista" currentPath={Astro.url.pathname}>
  <div class="max-w-7xl mx-auto"
    x-data=`{
      apiBase: '${apiBase}',
      loading: true,
      lastUpdate: null,
      
      // KPIs
      ordersTodayCount: 0,
      activeOrdersCount: 0,
      readyForDeliveryCount: 0,
      totalClientes: 0,
      totalVehiculos: 0,
      
      // Data
      recentOrders: [],
      vehiculosListos: [],
      ordenesPorEstado: { ingresado: 0, en_diagnostico: 0, en_reparacion: 0, finalizado: 0 },

      get totalOrdenesTaller() {
        return Object.values(this.ordenesPorEstado).reduce((a, b) => a + b, 0);
      },

      getStatusColor(status) {
        const colors = { ingresado: 'bg-amber-500', en_diagnostico: 'bg-blue-500', en_reparacion: 'bg-purple-500', finalizado: 'bg-green-500' };
        return colors[status] || 'bg-gray-500';
      },

      formatStatus(status) {
        const map = { ingresado: 'Ingresado', en_diagnostico: 'En Diagnóstico', en_reparacion: 'En Reparación', finalizado: 'Listo', facturado: 'Facturado', entregado: 'Entregado' };
        return map[status] || status;
      },

      getStatusBg(status) {
        const bg = { ingresado: 'bg-amber-100 text-amber-700', en_diagnostico: 'bg-blue-100 text-blue-700', en_reparacion: 'bg-purple-100 text-purple-700', finalizado: 'bg-green-100 text-green-700' };
        return bg[status] || 'bg-gray-100 text-gray-700';
      },

      formatTimeAgo(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        if (diffMins < 60) return 'hace ' + diffMins + ' min';
        if (diffHours < 24) return 'hace ' + diffHours + 'h';
        return 'hace ' + Math.floor(diffMs / 86400000) + ' días';
      },

      getTimeSinceUpdate() {
        if (!this.lastUpdate) return '';
        const s = Math.floor((new Date() - this.lastUpdate) / 1000);
        return s < 60 ? 'hace ' + s + 's' : 'hace ' + Math.floor(s/60) + 'm';
      },

      async fetchData() {
        const today = new Date().toISOString().split('T')[0];
        try {
          const [todayRes, activeRes, readyRes, recentRes, clientesRes, vehiculosRes, ingRes, diagRes, repRes, finRes, listosRes] = await Promise.all([
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[createdAt][$gte]=' + today + '&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$notIn][0]=entregado&filters[estado][$notIn][1]=facturado&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=finalizado&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?sort[0]=createdAt:desc&pagination[limit]=8&populate=vehiculo&populate=vehiculo.cliente'),
            fetch(this.apiBase + '/api/clientes?pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/vehiculos?pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=ingresado&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=en_diagnostico&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=en_reparacion&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=finalizado&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=finalizado&populate=vehiculo&populate=vehiculo.cliente&pagination[limit]=5')
          ]);

          const [todayData, activeData, readyData, recentData, clientesData, vehiculosData, ingData, diagData, repData, finData, listosData] = await Promise.all([
            todayRes.json(), activeRes.json(), readyRes.json(), recentRes.json(), clientesRes.json(), vehiculosRes.json(), ingData = ingRes.json(), diagRes.json(), repRes.json(), finRes.json(), listosRes.json()
          ]);

          this.ordersTodayCount = todayData.meta?.pagination?.total || 0;
          this.activeOrdersCount = activeData.meta?.pagination?.total || 0;
          this.readyForDeliveryCount = readyData.meta?.pagination?.total || 0;
          this.recentOrders = recentData.data || [];
          this.totalClientes = clientesData.meta?.pagination?.total || 0;
          this.totalVehiculos = vehiculosData.meta?.pagination?.total || 0;
          this.vehiculosListos = listosData.data || [];
          
          this.ordenesPorEstado = {
            ingresado: ingData.meta?.pagination?.total || 0,
            en_diagnostico: diagData.meta?.pagination?.total || 0,
            en_reparacion: repData.meta?.pagination?.total || 0,
            finalizado: finData.meta?.pagination?.total || 0
          };

          this.lastUpdate = new Date();
          this.loading = false;
        } catch(e) {
          console.error('Error:', e);
          this.loading = false;
        }
      },

      init() {
        this.fetchData();
        setInterval(() => this.fetchData(), 15000);
      }
    }`
  >
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">
          {getGreeting()}, {userName}!
        </h1>
        <p class="text-gray-500 dark:text-gray-400 flex items-center gap-2 mt-1">
          <span class="material-symbols-outlined text-sm">calendar_today</span>
          {new Date().toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
        </p>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 text-sm text-gray-500 bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700">
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
          <span>Actualizado <span x-text="getTimeSinceUpdate()"></span></span>
          <button @click="fetchData()" class="text-primary-600 hover:text-primary-700 ml-1">
            <span class="material-symbols-outlined text-sm" :class="loading && 'animate-spin'">refresh</span>
          </button>
        </div>
        <a href="/recepcion/crear_orden" class="inline-flex items-center gap-2 px-4 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium shadow-lg shadow-primary-600/20">
          <span class="material-symbols-outlined">add</span>
          Nueva Orden
        </a>
      </div>
    </div>

    <!-- Loading -->
    <template x-if="loading">
      <div class="flex items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
      </div>
    </template>

    <template x-if="!loading">
      <div>
        <!-- KPIs -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/20">
            <div class="flex items-center justify-between mb-3">
              <span class="text-blue-100 text-sm font-medium">Órdenes Hoy</span>
              <div class="p-2 bg-white/20 rounded-lg"><span class="material-symbols-outlined text-xl">today</span></div>
            </div>
            <p class="text-4xl font-bold" x-text="ordersTodayCount">0</p>
            <p class="text-blue-100 text-sm mt-1">nuevas este día</p>
          </div>
          
          <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-5 text-white shadow-lg shadow-purple-500/20">
            <div class="flex items-center justify-between mb-3">
              <span class="text-purple-100 text-sm font-medium">En Taller</span>
              <div class="p-2 bg-white/20 rounded-lg"><span class="material-symbols-outlined text-xl">garage</span></div>
            </div>
            <p class="text-4xl font-bold" x-text="activeOrdersCount">0</p>
            <p class="text-purple-100 text-sm mt-1">vehículos activos</p>
          </div>
          
          <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-green-500/20 relative overflow-hidden">
            <div x-show="readyForDeliveryCount > 0" class="absolute top-2 right-2 w-3 h-3 bg-white rounded-full animate-ping"></div>
            <div class="flex items-center justify-between mb-3">
              <span class="text-green-100 text-sm font-medium">Listos para Entrega</span>
              <div class="p-2 bg-white/20 rounded-lg"><span class="material-symbols-outlined text-xl">key</span></div>
            </div>
            <p class="text-4xl font-bold" x-text="readyForDeliveryCount">0</p>
            <p class="text-green-100 text-sm mt-1">esperando cliente</p>
          </div>
          
          <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-5 text-white shadow-lg shadow-orange-500/20">
            <div class="flex items-center justify-between mb-3">
              <span class="text-amber-100 text-sm font-medium">Clientes / Vehículos</span>
              <div class="p-2 bg-white/20 rounded-lg"><span class="material-symbols-outlined text-xl">groups</span></div>
            </div>
            <p class="text-4xl font-bold"><span x-text="totalClientes">0</span> / <span x-text="totalVehiculos">0</span></p>
            <p class="text-amber-100 text-sm mt-1">registrados</p>
          </div>
        </div>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Órdenes Recientes -->
          <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
              <h2 class="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary-600">list_alt</span>
                Órdenes Recientes
              </h2>
              <a href="/recepcion/ver_estado_orden" class="text-primary-600 hover:underline text-sm">Ver todas</a>
            </div>
            <div class="divide-y divide-gray-100 dark:divide-gray-700">
              <template x-for="order in recentOrders" :key="order.id">
                <a :href="'/recepcion/ver_estado_orden?type=orden&q=' + order.id" class="block p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-lg flex items-center justify-center" :class="getStatusBg(order.estado)">
                        <span class="material-symbols-outlined text-lg">directions_car</span>
                      </div>
                      <div>
                        <div class="flex items-center gap-2">
                          <span class="font-bold text-gray-900 dark:text-white" x-text="'OT-' + order.id"></span>
                          <span class="text-xs px-2 py-0.5 rounded-full" :class="getStatusBg(order.estado)" x-text="formatStatus(order.estado)"></span>
                        </div>
                        <p class="text-sm text-gray-500" x-text="(order.vehiculo?.marca || '') + ' ' + (order.vehiculo?.modelo || '') + ' - ' + (order.vehiculo?.patente || '')"></p>
                      </div>
                    </div>
                    <div class="text-right">
                      <p class="text-xs text-gray-400" x-text="formatTimeAgo(order.createdAt)"></p>
                      <p class="text-sm text-gray-600 dark:text-gray-300" x-text="(order.vehiculo?.cliente?.nombre || '') + ' ' + (order.vehiculo?.cliente?.apellido || '')"></p>
                    </div>
                  </div>
                </a>
              </template>
              <template x-if="recentOrders.length === 0">
                <div class="p-8 text-center text-gray-500">
                  <span class="material-symbols-outlined text-4xl mb-2">inbox</span>
                  <p>No hay órdenes recientes</p>
                </div>
              </template>
            </div>
          </div>

          <!-- Panel derecho -->
          <div class="space-y-6">
            <!-- Estado del Taller -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary-600">analytics</span>
                Estado del Taller
              </h3>
              <div class="space-y-3">
                <template x-for="(count, estado) in ordenesPorEstado" :key="estado">
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-gray-600 dark:text-gray-300" x-text="formatStatus(estado)"></span>
                      <span class="font-bold" x-text="count"></span>
                    </div>
                    <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                      <div class="h-full rounded-full transition-all" :class="getStatusColor(estado)" :style="'width: ' + (totalOrdenesTaller > 0 ? (count / totalOrdenesTaller * 100) : 0) + '%'"></div>
                    </div>
                  </div>
                </template>
              </div>
              <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 text-center">
                <span class="text-2xl font-bold text-gray-900 dark:text-white" x-text="totalOrdenesTaller"></span>
                <span class="text-gray-500 text-sm ml-2">órdenes en taller</span>
              </div>
            </div>

            <!-- Listos para Entrega -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-green-600">key</span>
                Listos para Entrega
              </h3>
              <div class="space-y-3">
                <template x-for="orden in vehiculosListos" :key="orden.id">
                  <a :href="'/recepcion/confirmar_pago'" class="block p-3 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30">
                    <div class="flex items-center gap-3">
                      <span class="material-symbols-outlined text-green-600">check_circle</span>
                      <div>
                        <p class="font-medium text-gray-900 dark:text-white" x-text="'OT-' + orden.id"></p>
                        <p class="text-xs text-gray-500" x-text="(orden.vehiculo?.marca || '') + ' ' + (orden.vehiculo?.patente || '')"></p>
                      </div>
                    </div>
                  </a>
                </template>
                <template x-if="vehiculosListos.length === 0">
                  <p class="text-center text-gray-500 text-sm py-4">No hay vehículos listos</p>
                </template>
              </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4">Acciones Rápidas</h3>
              <div class="grid grid-cols-2 gap-2">
                <a href="/recepcion/crear_cliente" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 text-center">
                  <span class="material-symbols-outlined text-primary-600 block mb-1">person_add</span>
                  <span class="text-xs text-gray-600 dark:text-gray-300">Nuevo Cliente</span>
                </a>
                <a href="/recepcion/crear_vehiculo" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 text-center">
                  <span class="material-symbols-outlined text-primary-600 block mb-1">directions_car</span>
                  <span class="text-xs text-gray-600 dark:text-gray-300">Nuevo Vehículo</span>
                </a>
                <a href="/recepcion/agenda" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 text-center">
                  <span class="material-symbols-outlined text-primary-600 block mb-1">calendar_month</span>
                  <span class="text-xs text-gray-600 dark:text-gray-300">Agenda</span>
                </a>
                <a href="/recepcion/confirmar_pago" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 text-center">
                  <span class="material-symbols-outlined text-primary-600 block mb-1">payments</span>
                  <span class="text-xs text-gray-600 dark:text-gray-300">Cobrar</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>
</DashboardLayout>