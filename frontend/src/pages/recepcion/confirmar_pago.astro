---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { strapiGet, strapiPut } from '../../lib/strapi';
import { validateRequired } from '../../lib/validations';

const userRole = Astro.cookies.get('user_role')?.value as 'recepcionista' | 'encargado' | 'mecanico' | undefined;
if (!userRole) {
  return Astro.redirect('/login');
}

interface Factura {
  id: number;
  documentId: string;
  numero_factura: string;
  total: number;
  estado: string;
  metodo_pago?: string;
  fecha_pago?: string;
  fecha_emision: string;
  orden_de_trabajo?: {
    id: number;
    documentId: string;
    descripcion: string;
    vehiculo?: {
      marca: string;
      modelo: string;
      patente: string;
      color?: string;
      cliente?: {
        nombre: string;
        apellido: string;
        telefono?: string;
        email?: string;
      };
    };
  };
  createdAt: string;
}

let facturasPendientes: Factura[] = [];
let pagosRecientes: Factura[] = [];
let error = '';
let successMessage = '';

// Procesar confirmaci√≥n de pago
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const facturaId = formData.get('factura_id')?.toString().trim() || '';
    const metodoPago = formData.get('metodo_pago')?.toString().trim() || '';
    const referencia = formData.get('referencia')?.toString().trim() || '';
    
    const facturaVal = validateRequired(facturaId, 'ID de factura');
    const metodoVal = validateRequired(metodoPago, 'M√©todo de pago');
    
    if (!facturaVal.valid) {
      error = facturaVal.message;
    } else if (!metodoVal.valid) {
      error = metodoVal.message;
    } else {
      await strapiPut(`/api/facturas/${facturaId}`, {
        estado: 'pagado',
        metodo_pago: metodoPago,
        referencia_pago: referencia || null,
        fecha_pago: new Date().toISOString(),
      });
      
      successMessage = '¬°Pago confirmado exitosamente! El veh√≠culo est√° listo para entrega.';
    }
  } catch (e: any) {
    error = 'Error al confirmar pago: ' + e.message;
  }
}

try {
  // Obtener facturas pendientes
  const pendientesResponse = await strapiGet('/api/facturas?filters[estado][$eq]=pendiente&populate[orden_de_trabajo][populate][vehiculo][populate]=cliente&pagination[pageSize]=100&sort=createdAt:desc');
  facturasPendientes = pendientesResponse.data || [];

  // Obtener pagos recientes (√∫ltimos 5)
  const recientesResponse = await strapiGet('/api/facturas?filters[estado][$eq]=pagado&populate[orden_de_trabajo][populate][vehiculo][populate]=cliente&pagination[limit]=5&sort=fecha_pago:desc');
  pagosRecientes = recientesResponse.data || [];
} catch (e: any) {
  console.error('Error fetching facturas:', e);
  facturasPendientes = [];
}

const formatMoney = (amount: number) => `$${(amount || 0).toLocaleString('es-CL')}`;

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('es-CL', { day: '2-digit', month: 'short', year: 'numeric' });
};

const getTimeAgo = (dateString: string) => {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 60) return `hace ${diffMins} min`;
  if (diffHours < 24) return `hace ${diffHours}h`;
  if (diffDays === 1) return 'ayer';
  return `hace ${diffDays} d√≠as`;
};

const metodoPagoIcons: Record<string, string> = {
  efectivo: 'üíµ',
  tarjeta_debito: 'üí≥',
  tarjeta_credito: 'üí≥',
  transferencia: 'üè¶',
  cheque: 'üìù'
};

// Stats
const totalPendiente = facturasPendientes.reduce((acc, f) => acc + (f.total || 0), 0);
const cantidadPendiente = facturasPendientes.length;
const totalRecaudadoHoy = pagosRecientes.filter(f => {
  const today = new Date().toISOString().split('T')[0];
  return f.fecha_pago?.startsWith(today);
}).reduce((acc, f) => acc + (f.total || 0), 0);
---

<DashboardLayout title="Confirmar Pago" role="recepcionista" currentPath="/recepcion/confirmar_pago">
  <div class="max-w-6xl mx-auto" x-data="{ selectedFactura: null }">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Confirmar Pago</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1">Registra el pago de las facturas para autorizar la entrega de veh√≠culos</p>
      </div>
      <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2">
        <span class="material-symbols-outlined">payments</span>
        {cantidadPendiente} facturas pendientes
      </div>
    </div>

    {error && (
      <div class="bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 text-red-800 dark:text-red-200 px-4 py-3 rounded-xl mb-6 flex items-center gap-2">
        <span class="material-symbols-outlined">error</span>
        {error}
      </div>
    )}

    {successMessage && (
      <div class="bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 text-green-800 dark:text-green-200 px-4 py-3 rounded-xl mb-6 flex items-center gap-3">
        <div class="w-10 h-10 bg-green-200 dark:bg-green-800 rounded-full flex items-center justify-center">
          <span class="material-symbols-outlined text-green-700 dark:text-green-300">check_circle</span>
        </div>
        <div class="flex-1">
          <p class="font-medium">{successMessage}</p>
          <a href="/recepcion/entrega_vehiculo" class="text-sm text-green-600 dark:text-green-400 hover:underline">
            Ir a Entregar Veh√≠culo ‚Üí
          </a>
        </div>
      </div>
    )}

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-amber-100 text-sm">Pendiente por Cobrar</p>
            <p class="text-2xl font-bold">{formatMoney(totalPendiente)}</p>
            <p class="text-amber-200 text-sm mt-1">{cantidadPendiente} facturas</p>
          </div>
          <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
            <span class="material-symbols-outlined text-3xl">receipt_long</span>
          </div>
        </div>
      </div>
      
      <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-100 text-sm">Recaudado Hoy</p>
            <p class="text-2xl font-bold">{formatMoney(totalRecaudadoHoy)}</p>
            <p class="text-green-200 text-sm mt-1">En pagos confirmados</p>
          </div>
          <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
            <span class="material-symbols-outlined text-3xl">payments</span>
          </div>
        </div>
      </div>
      
      <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-100 text-sm">Promedio por Factura</p>
            <p class="text-2xl font-bold">{cantidadPendiente > 0 ? formatMoney(totalPendiente / cantidadPendiente) : '$0'}</p>
            <p class="text-blue-200 text-sm mt-1">De las pendientes</p>
          </div>
          <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
            <span class="material-symbols-outlined text-3xl">analytics</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Facturas Pendientes -->
    <div class="mb-8">
      <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-amber-600">pending</span>
        Facturas Pendientes de Pago
      </h2>

      {facturasPendientes.length === 0 ? (
        <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-2xl border-2 border-dashed border-gray-200 dark:border-gray-700">
          <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="material-symbols-outlined text-3xl text-gray-400">payments</span>
          </div>
          <h3 class="text-lg font-medium text-gray-900 dark:text-white">No hay facturas pendientes</h3>
          <p class="text-gray-500 dark:text-gray-400 mt-1">Las facturas aparecen cuando el encargado factura una orden finalizada.</p>
        </div>
      ) : (
        <div class="space-y-4">
          {facturasPendientes.map((factura: Factura) => {
            const orden = factura.orden_de_trabajo;
            const vehiculo = orden?.vehiculo;
            const cliente = vehiculo?.cliente;
            
            return (
              <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg transition-shadow">
                <div class="p-5 flex flex-col lg:flex-row gap-4">
                  <!-- Icon -->
                  <div class="w-14 h-14 bg-amber-100 dark:bg-amber-900/30 rounded-xl flex items-center justify-center shrink-0">
                    <span class="material-symbols-outlined text-2xl text-amber-600 dark:text-amber-400">receipt_long</span>
                  </div>
                  
                  <!-- Info -->
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-3">
                      <span class="text-xl font-bold text-gray-900 dark:text-white">
                        {factura.numero_factura || `F-${factura.id}`}
                      </span>
                      <span class="px-2 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300 text-xs font-bold rounded-full">
                        PENDIENTE
                      </span>
                      <span class="text-xs text-gray-400">
                        Emitida {formatDate(factura.fecha_emision || factura.createdAt)}
                      </span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                      <div>
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Cliente</p>
                        <p class="font-medium text-gray-900 dark:text-white">
                          {cliente ? `${cliente.nombre} ${cliente.apellido}` : 'N/A'}
                        </p>
                        {cliente?.telefono && (
                          <a href={`tel:${cliente.telefono}`} class="text-xs text-primary-600 hover:underline">{cliente.telefono}</a>
                        )}
                      </div>
                      <div>
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Veh√≠culo</p>
                        <p class="font-medium text-gray-900 dark:text-white">
                          {vehiculo ? `${vehiculo.marca} ${vehiculo.modelo}` : 'N/A'}
                        </p>
                        <p class="text-xs text-gray-500 font-mono">{vehiculo?.patente}</p>
                      </div>
                      <div>
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Orden</p>
                        <p class="font-medium text-gray-900 dark:text-white">OT-{orden?.id || 'N/A'}</p>
                      </div>
                      <div>
                        <p class="text-xs text-gray-400 uppercase tracking-wide">Total a Pagar</p>
                        <p class="font-bold text-2xl text-green-600">{formatMoney(factura.total)}</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Formulario de pago -->
                  <form method="POST" class="flex flex-col gap-2 min-w-[280px] shrink-0 bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl">
                    <input type="hidden" name="factura_id" value={factura.documentId} />
                    
                    <label class="text-xs font-medium text-gray-600 dark:text-gray-400">M√©todo de Pago *</label>
                    <select 
                      name="metodo_pago" 
                      required
                      class="px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800"
                    >
                      <option value="">Seleccionar...</option>
                      <option value="efectivo">üíµ Efectivo</option>
                      <option value="tarjeta_debito">üí≥ Tarjeta D√©bito</option>
                      <option value="tarjeta_credito">üí≥ Tarjeta Cr√©dito</option>
                      <option value="transferencia">üè¶ Transferencia</option>
                      <option value="cheque">üìù Cheque</option>
                    </select>
                    
                    <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Referencia (opcional)</label>
                    <input 
                      type="text" 
                      name="referencia"
                      placeholder="N¬∞ Voucher, comprobante..."
                      class="px-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-800"
                    />
                    
                    <button 
                      type="submit"
                      class="mt-2 px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2 font-medium shadow-lg shadow-green-600/20"
                    >
                      <span class="material-symbols-outlined text-sm">check_circle</span>
                      Confirmar Pago
                    </button>
                  </form>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>

    <!-- Pagos Recientes -->
    {pagosRecientes.length > 0 && (
      <div class="mb-8">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-green-600">history</span>
          Pagos Confirmados Recientemente
        </h2>
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 divide-y divide-gray-100 dark:divide-gray-700">
          {pagosRecientes.map((pago) => {
            const vehiculo = pago.orden_de_trabajo?.vehiculo;
            const cliente = vehiculo?.cliente;
            return (
              <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                    <span class="text-lg">{metodoPagoIcons[pago.metodo_pago || ''] || 'üí∞'}</span>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900 dark:text-white">
                      {pago.numero_factura} ‚Ä¢ {cliente ? `${cliente.nombre} ${cliente.apellido}` : 'Cliente'}
                    </p>
                    <p class="text-sm text-gray-500">
                      {vehiculo?.patente} - {vehiculo?.marca} {vehiculo?.modelo}
                    </p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-bold text-green-600">{formatMoney(pago.total)}</p>
                  <p class="text-xs text-gray-400">{pago.fecha_pago ? getTimeAgo(pago.fecha_pago) : ''}</p>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    )}

    <!-- Quick Actions -->
    <div class="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
      <div class="flex flex-wrap items-center justify-center gap-4">
        <a href="/recepcion/entrega_vehiculo" class="inline-flex items-center gap-2 px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
          <span class="material-symbols-outlined">key</span>
          Entregar Veh√≠culos
        </a>
        <a href="/recepcion/ver_estado_orden" class="inline-flex items-center gap-2 px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
          <span class="material-symbols-outlined">search</span>
          Buscar Orden
        </a>
        <a href="/recepcion/comprobante" class="inline-flex items-center gap-2 px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
          <span class="material-symbols-outlined">print</span>
          Imprimir Comprobante
        </a>
      </div>
    </div>

    <!-- Info adicional -->
    <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
      <div class="flex gap-3">
        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">info</span>
        <div class="text-sm text-blue-700 dark:text-blue-300">
          <p class="font-medium mb-1">Informaci√≥n importante:</p>
          <ul class="space-y-1 text-blue-600 dark:text-blue-400">
            <li>‚Ä¢ Al confirmar el pago, el veh√≠culo quedar√° listo para ser entregado al cliente.</li>
            <li>‚Ä¢ Verifique el monto y m√©todo de pago antes de confirmar.</li>
            <li>‚Ä¢ Para pagos electr√≥nicos, registre el n√∫mero de referencia o voucher.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
