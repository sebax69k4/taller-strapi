---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import VehicleInspection from '../../components/recepcion/VehicleInspection.astro';
import { strapiGet, strapiPost } from '../../lib/strapi';
import '../../styles/global.css';

// TypeScript Interfaces
interface Cliente {
  id: number;
  documentId: string;
  nombre: string;
  apellido: string;
  rut: string;
  telefono?: string;
}

interface Vehiculo {
  id: number;
  documentId: string;
  patente: string;
  marca: string;
  modelo: string;
  ano?: number;
  color?: string;
  kilometraje?: number;
  cliente: Cliente | null;
}

interface Mecanico {
  id: number;
  documentId: string;
  nombre: string;
  apellido: string;
  especialidad?: string;
  estado?: string;
}

interface Zona {
  id: number;
  documentId: string;
  nombre: string;
}

interface Servicio {
  id: number;
  documentId: string;
  nombre: string;
  descripcion?: string;
  precio_base: number;
  tiempo_estimado?: number;
  categoria?: string;
}

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

let message = Astro.url.searchParams.get('message');
let messageType = Astro.url.searchParams.get('type');

// Par√°metros preseleccionados
const preselectedClienteId = Astro.url.searchParams.get('clienteId') || '';
const preselectedVehiculoId = Astro.url.searchParams.get('vehiculoId') || Astro.url.searchParams.get('vehiculo') || '';

let clientes: Cliente[] = [];
let vehiculos: Vehiculo[] = [];
let mecanicos: Mecanico[] = [];
let zonas: Zona[] = [];
let servicios: Servicio[] = [];
let preselectedCliente: Cliente | null = null;
let preselectedVehiculo: Vehiculo | null = null;

try {
  const [clientesResponse, vehiculosResponse, mecanicosResponse, zonasResponse, serviciosResponse] = await Promise.all([
    strapiGet('/api/clientes?sort=nombre:asc'),
    strapiGet('/api/vehiculos?populate=cliente&sort=marca:asc'),
    strapiGet('/api/mecenicos?filters[estado][$eq]=disponible&sort=nombre:asc'),
    strapiGet('/api/zonas?sort=nombre:asc'),
    strapiGet('/api/servicios?filters[activo][$eq]=true&sort=categoria:asc,nombre:asc')
  ]);

  clientes = clientesResponse.data || [];
  vehiculos = vehiculosResponse.data || [];
  mecanicos = mecanicosResponse.data || [];
  zonas = zonasResponse.data || [];
  servicios = serviciosResponse.data || [];

  // Buscar cliente y veh√≠culo preseleccionados
  if (preselectedVehiculoId) {
    preselectedVehiculo = vehiculos.find((v: Vehiculo) => v.documentId === preselectedVehiculoId) || null;
    if (preselectedVehiculo?.cliente) {
      preselectedCliente = preselectedVehiculo.cliente;
    }
  } else if (preselectedClienteId) {
    preselectedCliente = clientes.find((c: Cliente) => c.documentId === preselectedClienteId) || null;
  }

} catch (error: any) {
  console.error('Error fetching data:', error);
  message = error.message;
  messageType = 'error';
}

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const vehiculoDocumentId = formData.get('vehiculo');
    const fechaEntrada = formData.get('fecha_entrada');
    const fechaEstimada = formData.get('fecha_estimada');
    const descripcion = formData.get('descripcion');
    const prioridad = formData.get('prioridad') || 'normal';
    const mecanicoId = formData.get('mecanico');
    const zonaId = formData.get('zona');
    const kilometrajeIngreso = formData.get('kilometraje_ingreso');
    const nivelCombustible = formData.get('nivel_combustible');
    const serviciosSeleccionados = formData.getAll('servicios[]');
    const danosStr = formData.get('danos_previos');

    if (!vehiculoDocumentId || !fechaEntrada || !descripcion) {
        return Astro.redirect(`/recepcion/crear_orden?message=${encodeURIComponent('Veh√≠culo, fecha y descripci√≥n son obligatorios.')}&type=error`);
    }

    // Construir objeto de orden
    const ordenData: any = {
      vehiculo: vehiculoDocumentId,
      fecha_ingreso: fechaEntrada,
      descripcion: descripcion,
      estado: 'ingresado',
      prioridad: prioridad
    };

    // Campos opcionales
    if (fechaEstimada) ordenData.fecha_estimada = fechaEstimada;
    if (mecanicoId) ordenData.mecanico = mecanicoId;
    if (zonaId) ordenData.zona = zonaId;
    if (kilometrajeIngreso) ordenData.kilometraje_ingreso = parseInt(kilometrajeIngreso.toString());
    if (nivelCombustible) ordenData.nivel_combustible = nivelCombustible;
    if (serviciosSeleccionados.length > 0) ordenData.servicios = serviciosSeleccionados;
    if (danosStr) {
      try {
        ordenData.danos_previos = JSON.parse(danosStr.toString());
      } catch (e) {}
    }

    const result = await strapiPost('/api/orden-de-trabajos', ordenData);

    return Astro.redirect(`/recepcion/dash_recep?message=${encodeURIComponent('Orden de trabajo creada exitosamente.')}&type=success`);

  } catch (error: any) {
    console.error('Error creating order:', error);
    message = 'Error al crear la orden. ' + error.message;
    messageType = 'error';
  }
}

// Agrupar servicios por categor√≠a
const serviciosPorCategoria = servicios.reduce((acc: Record<string, Servicio[]>, s: Servicio) => {
  const cat = s.categoria || 'otros';
  if (!acc[cat]) acc[cat] = [];
  acc[cat].push(s);
  return acc;
}, {});

const categoriasOrden = ['mantencion', 'reparacion', 'diagnostico', 'electrico', 'pintura', 'neumaticos', 'otros'];
const categoriasNombres: Record<string, string> = {
  mantencion: 'üîß Mantenci√≥n',
  reparacion: 'üõ†Ô∏è Reparaci√≥n',
  diagnostico: 'üîç Diagn√≥stico',
  electrico: '‚ö° El√©ctrico',
  pintura: 'üé® Pintura',
  neumaticos: 'üõû Neum√°ticos',
  otros: 'üì¶ Otros'
};
---

<DashboardLayout title="Crear Orden de Trabajo" role="recepcionista" currentPath="/recepcion/crear_orden">
    <div class="max-w-5xl mx-auto" x-data="ordenFormController()">
        <!-- Page Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Nueva Orden de Trabajo</h1>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Complete la informaci√≥n para ingresar un veh√≠culo al taller</p>
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                <span class="material-symbols-outlined text-lg">schedule</span>
                {new Date().toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' })}
            </div>
        </div>

        <!-- Alert Messages -->
        {message && (
            <div class={`p-4 mb-6 rounded-xl border flex items-center gap-3 ${messageType === 'success' ? 'bg-green-50 border-green-200 text-green-800 dark:bg-green-900/30 dark:border-green-800 dark:text-green-300' : 'bg-red-50 border-red-200 text-red-800 dark:bg-red-900/30 dark:border-red-800 dark:text-red-300'}`}>
                <span class="material-symbols-outlined">{messageType === 'success' ? 'check_circle' : 'error'}</span>
                <p class="text-sm font-medium">{message}</p>
            </div>
        )}

        <form method="POST" class="space-y-6">
            
            <!-- Preselection Alert -->
            {(preselectedCliente || preselectedVehiculo) && (
                <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800 flex items-center gap-3">
                    <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">info</span>
                    <p class="text-sm text-blue-700 dark:text-blue-300">
                        {preselectedVehiculo 
                            ? `Creando orden para: ${preselectedVehiculo.marca} ${preselectedVehiculo.modelo} (${preselectedVehiculo.patente})`
                            : `Creando orden para: ${preselectedCliente?.nombre} ${preselectedCliente?.apellido}`
                        }
                    </p>
                </div>
            )}
            
            <!-- Section 1: Cliente y Veh√≠culo -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                    <span class="flex items-center justify-center w-7 h-7 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 text-sm font-bold">1</span>
                    Cliente y Veh√≠culo
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="cliente">
                            Cliente <span class="text-red-500">*</span>
                        </label>
                        <select name="cliente" id="cliente" @change="filterVehiculos($event.target.value)" class="form-select w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200" required>
                            <option value="" disabled selected>Seleccione un cliente...</option>
                            {clientes.map((cliente: any) => (
                                <option value={cliente.id} selected={preselectedCliente?.id === cliente.id}>
                                    {cliente.nombre} {cliente.apellido} ({cliente.rut})
                                </option>
                            ))}
                        </select>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="vehiculo">
                            Veh√≠culo <span class="text-red-500">*</span>
                        </label>
                        <select name="vehiculo" id="vehiculo" @change="selectVehiculo($event.target.value)" class="form-select w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200" required :disabled="filteredVehiculos.length === 0">
                            <option value="" disabled selected>Seleccione un veh√≠culo...</option>
                            <template x-for="vehiculo in filteredVehiculos" :key="vehiculo.documentId">
                                <option :value="vehiculo.documentId" x-text="`${vehiculo.patente} - ${vehiculo.marca} ${vehiculo.modelo} ${vehiculo.ano ? '(' + vehiculo.ano + ')' : ''}`"></option>
                            </template>
                        </select>
                        <p x-show="selectedClientId && filteredVehiculos.length === 0" class="text-xs text-amber-600 dark:text-amber-400 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">warning</span>
                            Sin veh√≠culos. <a href="/recepcion/crear_vehiculo" class="font-medium hover:underline">A√±adir uno</a>
                        </p>
                    </div>
                </div>
                
                <!-- Vehicle Info Card -->
                <template x-if="selectedVehiculo">
                    <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-xl bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
                                <span class="material-symbols-outlined text-2xl text-primary-600 dark:text-primary-400">directions_car</span>
                            </div>
                            <div class="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Patente</p>
                                    <p class="font-bold text-gray-900 dark:text-white font-mono" x-text="selectedVehiculo.patente"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Marca/Modelo</p>
                                    <p class="font-semibold text-gray-900 dark:text-white" x-text="`${selectedVehiculo.marca} ${selectedVehiculo.modelo}`"></p>
                                </div>
                                <div x-show="selectedVehiculo.ano">
                                    <p class="text-xs text-gray-500 dark:text-gray-400">A√±o</p>
                                    <p class="font-semibold text-gray-900 dark:text-white" x-text="selectedVehiculo.ano"></p>
                                </div>
                                <div x-show="selectedVehiculo.color">
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Color</p>
                                    <p class="font-semibold text-gray-900 dark:text-white" x-text="selectedVehiculo.color"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Section 2: Detalles del Servicio -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                    <span class="flex items-center justify-center w-7 h-7 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-600 text-sm font-bold">2</span>
                    Detalles del Servicio
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- Fecha de entrada -->
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="fecha_entrada">
                            Fecha de Ingreso <span class="text-red-500">*</span>
                        </label>
                        <input name="fecha_entrada" id="fecha_entrada" type="date" value={new Date().toISOString().split('T')[0]} class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200" required/>
                    </div>
                    
                    <!-- Fecha estimada -->
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="fecha_estimada">
                            Fecha Estimada Entrega
                        </label>
                        <input name="fecha_estimada" id="fecha_estimada" type="date" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200"/>
                    </div>
                    
                    <!-- Prioridad -->
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="prioridad">
                            Prioridad
                        </label>
                        <select name="prioridad" id="prioridad" class="form-select w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200">
                            <option value="baja">üü¢ Baja</option>
                            <option value="normal" selected>üü° Normal</option>
                            <option value="alta">üü† Alta</option>
                            <option value="urgente">üî¥ Urgente</option>
                        </select>
                    </div>
                </div>

                <!-- Descripci√≥n del problema -->
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="descripcion">
                        Descripci√≥n del Problema / Motivo de Ingreso <span class="text-red-500">*</span>
                    </label>
                    <textarea name="descripcion" id="descripcion" class="form-textarea w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200" placeholder="Describa detalladamente el problema reportado por el cliente, s√≠ntomas observados, o los servicios solicitados..." rows="4" required></textarea>
                </div>
            </div>

            <!-- Section 3: Estado del Veh√≠culo -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                    <span class="flex items-center justify-center w-7 h-7 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 text-sm font-bold">3</span>
                    Estado del Veh√≠culo al Ingreso
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Kilometraje -->
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="kilometraje_ingreso">
                            Kilometraje Actual
                        </label>
                        <div class="relative">
                            <input name="kilometraje_ingreso" id="kilometraje_ingreso" type="number" min="0" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200 pr-12" placeholder="Ej: 45000"/>
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">km</span>
                        </div>
                    </div>
                    
                    <!-- Nivel de combustible -->
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                            Nivel de Combustible
                        </label>
                        <div class="flex gap-2">
                            {[
                                { value: 'vacio', label: 'E', color: 'red' },
                                { value: 'cuarto', label: '¬º', color: 'orange' },
                                { value: 'medio', label: '¬Ω', color: 'yellow' },
                                { value: 'tres_cuartos', label: '¬æ', color: 'lime' },
                                { value: 'lleno', label: 'F', color: 'green' }
                            ].map(nivel => (
                                <label class="flex-1">
                                    <input type="radio" name="nivel_combustible" value={nivel.value} class="sr-only peer"/>
                                    <div class={`text-center py-3 rounded-lg border-2 cursor-pointer transition-all peer-checked:border-${nivel.color}-500 peer-checked:bg-${nivel.color}-50 dark:peer-checked:bg-${nivel.color}-900/20 border-gray-200 dark:border-gray-700 hover:border-gray-300`}>
                                        <span class="font-bold text-gray-700 dark:text-gray-300">{nivel.label}</span>
                                    </div>
                                </label>
                            ))}
                        </div>
                    </div>
                </div>

                <!-- Da√±os previos (checklist visual) -->
                <div>
                    <VehicleInspection />
                </div>
            </div>

            <!-- Section 4: Asignaci√≥n -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                    <span class="flex items-center justify-center w-7 h-7 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 text-sm font-bold">4</span>
                    Asignaci√≥n
                    <span class="text-sm font-normal text-gray-400">(opcional)</span>
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Mec√°nico -->
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="mecanico">
                            Mec√°nico Asignado
                        </label>
                        <select name="mecanico" id="mecanico" class="form-select w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200">
                            <option value="">Sin asignar (se asignar√° despu√©s)</option>
                            {mecanicos.map((mec: any) => (
                                <option value={mec.documentId}>
                                    {mec.nombre} {mec.apellido} {mec.especialidad ? `- ${mec.especialidad}` : ''}
                                </option>
                            ))}
                        </select>
                        {mecanicos.length === 0 && (
                            <p class="text-xs text-gray-500 dark:text-gray-400">No hay mec√°nicos disponibles</p>
                        )}
                    </div>
                    
                    <!-- Zona -->
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300" for="zona">
                            Zona de Trabajo
                        </label>
                        <select name="zona" id="zona" class="form-select w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:text-gray-200">
                            <option value="">Sin asignar</option>
                            {zonas.map((zona: any) => (
                                <option value={zona.documentId}>{zona.nombre}</option>
                            ))}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section 5: Servicios -->
            {servicios.length > 0 && (
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-teal-100 dark:bg-teal-900/30 text-teal-600 text-sm font-bold">5</span>
                            Servicios Solicitados
                            <span class="text-sm font-normal text-gray-400">(opcional)</span>
                        </div>
                        <div class="text-right" x-show="estimatedTotal > 0">
                            <p class="text-xs text-gray-500 uppercase">Presupuesto Estimado</p>
                            <p class="text-xl font-bold text-primary-600" x-text="'$' + estimatedTotal.toLocaleString('es-CL')"></p>
                        </div>
                    </h2>
                    
                    <div class="space-y-6">
                        {categoriasOrden.filter(cat => serviciosPorCategoria[cat]?.length > 0).map(cat => (
                            <div>
                                <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-3">{categoriasNombres[cat]}</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {serviciosPorCategoria[cat].map((servicio: Servicio) => (
                                        <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors has-[:checked]:border-teal-500 has-[:checked]:bg-teal-50 dark:has-[:checked]:bg-teal-900/20">
                                            <input type="checkbox" name="servicios[]" value={servicio.documentId} @change="toggleService(servicio.precio_base)" class="rounded border-gray-300 text-teal-600 focus:ring-teal-500"/>
                                            <div class="flex-1">
                                                <p class="font-medium text-gray-900 dark:text-white">{servicio.nombre}</p>
                                                {servicio.descripcion && (
                                                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{servicio.descripcion}</p>
                                                )}
                                            </div>
                                            <div class="text-right">
                                                <p class="font-bold text-gray-900 dark:text-white">${servicio.precio_base.toLocaleString('es-CL')}</p>
                                                {servicio.tiempo_estimado && (
                                                    <p class="text-xs text-gray-500 dark:text-gray-400">{servicio.tiempo_estimado} min</p>
                                                )}
                                            </div>
                                        </label>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            <!-- Action Area -->
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 pt-4">
                <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">info</span>
                    Los campos marcados con <span class="text-red-500">*</span> son obligatorios
                </div>
                <div class="flex gap-3">
                    <a href="/recepcion/dash_recep">
                        <Button type="button" variant="secondary">
                            Cancelar
                        </Button>
                    </a>
                    <button type="submit" class="inline-flex items-center gap-2 px-6 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium shadow-lg shadow-primary-600/20">
                        <span class="material-symbols-outlined">add_task</span>
                        Crear Orden de Trabajo
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script define:vars={{ vehiculos, preselectedCliente, preselectedVehiculo, servicios }}>
        document.addEventListener('alpine:init', () => {
            Alpine.data('ordenFormController', () => ({
                selectedClientId: preselectedCliente ? preselectedCliente.id : null,
                allVehiculos: vehiculos,
                filteredVehiculos: [],
                selectedVehiculo: preselectedVehiculo || null,
                danosSeleccionados: [],
                preselectedVehiculoId: preselectedVehiculo ? preselectedVehiculo.documentId : null,
                estimatedTotal: 0,
                allServices: servicios,
                
                init() {
                    // Si hay cliente preseleccionado, filtrar veh√≠culos
                    if (this.selectedClientId) {
                        this.filterVehiculos(this.selectedClientId);
                        const clienteSelect = document.getElementById('cliente');
                        if (clienteSelect) clienteSelect.value = this.selectedClientId;
                    }
                    // Si hay veh√≠culo preseleccionado
                    if (this.preselectedVehiculoId) {
                        this.$nextTick(() => {
                            const vehiculoSelect = document.getElementById('vehiculo');
                            if (vehiculoSelect) vehiculoSelect.value = this.preselectedVehiculoId;
                        });
                    }
                },
                
                filterVehiculos(clientId) {
                    this.selectedClientId = clientId;
                    this.selectedVehiculo = null;
                    if (!clientId) {
                        this.filteredVehiculos = [];
                        return;
                    }
                    this.filteredVehiculos = this.allVehiculos.filter(
                        (vehiculo) => vehiculo.cliente && vehiculo.cliente.id == clientId
                    );
                },
                
                selectVehiculo(documentId) {
                    this.selectedVehiculo = this.allVehiculos.find(v => v.documentId === documentId) || null;
                },

                toggleService(price) {
                    this.$nextTick(() => {
                        const checkedBoxes = document.querySelectorAll('input[name="servicios[]"]:checked');
                        let total = 0;
                        checkedBoxes.forEach(box => {
                            const service = this.allServices.find(s => s.documentId === box.value);
                            if (service) total += service.precio_base;
                        });
                        this.estimatedTotal = total;
                    });
                }
            }));
        });
    </script>
</DashboardLayout>