---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import { strapiGet } from '../../lib/strapi';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) return Astro.redirect('/login');

let query = Astro.url.searchParams.get('q') || '';
let historial: any[] = [];
let error = '';

if (query) {
    try {
        // Search by Client Name, RUT or Vehicle Plate
        // This is a complex query, simplifying to search by RUT or Plate for now
        const endpoint = `/api/orden-de-trabajos?populate[vehiculo][populate][cliente]=*&populate[factura]=*&sort=createdAt:desc&filters[$or][0][vehiculo][patente][$contains]=${query}&filters[$or][1][vehiculo][cliente][rut][$contains]=${query}`;
        const res = await strapiGet(endpoint);
        historial = res.data || [];
    } catch (e: any) {
        error = 'Error al buscar historial: ' + e.message;
    }
}
---

<DashboardLayout title="Historial de Cliente" role="recepcionista" currentPath={Astro.url.pathname}>
    <div class="max-w-4xl mx-auto">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Historial de Cliente</h1>
            <p class="text-gray-500 dark:text-gray-400">Busca por RUT del cliente o Patente del vehículo para ver reparaciones anteriores.</p>
        </div>

        <Card class="mb-8">
            <form class="flex gap-4">
                <input 
                    type="text" 
                    name="q" 
                    value={query}
                    placeholder="Ej: 12.345.678-9 o ABCD12"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                />
                <button type="submit" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium">
                    Buscar
                </button>
            </form>
        </Card>

        {error && (
            <div class="p-4 mb-6 text-red-700 bg-red-100 rounded-lg">
                {error}
            </div>
        )}

        {historial.length > 0 ? (
            <div class="space-y-6">
                {historial.map((orden: any) => (
                    <Card>
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white">
                                    OT-{orden.id} - {orden.vehiculo?.marca} {orden.vehiculo?.modelo}
                                </h3>
                                <p class="text-sm text-gray-500">
                                    {new Date(orden.createdAt).toLocaleDateString('es-CL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                </p>
                            </div>
                            <span class={`px-3 py-1 rounded-full text-xs font-bold ${
                                orden.estado === 'finalizado' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                            }`}>
                                {orden.estado.toUpperCase()}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm">
                            <div>
                                <p class="text-gray-500">Cliente</p>
                                <p class="font-medium text-gray-900 dark:text-white">
                                    {orden.vehiculo?.cliente?.nombre} {orden.vehiculo?.cliente?.apellido}
                                </p>
                            </div>
                            <div>
                                <p class="text-gray-500">Patente</p>
                                <p class="font-medium text-gray-900 dark:text-white">{orden.vehiculo?.patente}</p>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-4">
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                <span class="font-bold">Descripción:</span> {orden.descripcion}
                            </p>
                            {orden.diagnostico && (
                                <p class="text-sm text-gray-700 dark:text-gray-300 mt-2">
                                    <span class="font-bold">Diagnóstico:</span> {orden.diagnostico}
                                </p>
                            )}
                        </div>

                        {orden.factura && (
                            <div class="flex justify-end">
                                <a href={`/encargado/ver_factura?id=${orden.factura.id}`} class="text-primary-600 hover:underline text-sm font-medium flex items-center gap-1">
                                    <span class="material-symbols-outlined text-base">receipt_long</span>
                                    Ver Factura
                                </a>
                            </div>
                        )}
                    </Card>
                ))}
            </div>
        ) : query ? (
            <div class="text-center py-12 text-gray-500">
                <span class="material-symbols-outlined text-4xl mb-2 opacity-50">search_off</span>
                <p>No se encontraron registros para "{query}"</p>
            </div>
        ) : null}
    </div>
</DashboardLayout>
