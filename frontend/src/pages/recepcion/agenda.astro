---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Badge from '../../components/ui/Badge.astro';
import { strapiGet } from '../../lib/strapi';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) return Astro.redirect('/login');

// Get current week start (Monday)
const today = new Date();
const dayOfWeek = today.getDay(); // 0 (Sun) - 6 (Sat)
const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust when day is Sunday
const startOfWeek = new Date(today.setDate(diff));
startOfWeek.setHours(0, 0, 0, 0);

// Generate week days
const weekDays = [];
for (let i = 0; i < 5; i++) { // Mon-Fri
    const d = new Date(startOfWeek);
    d.setDate(startOfWeek.getDate() + i);
    weekDays.push(d);
}

let orders: any[] = [];
let error = '';

try {
    // Fetch orders for this week (or all active orders to simplify)
    // Ideally filter by date range in Strapi
    const res = await strapiGet('/api/orden-de-trabajos?populate=vehiculo&sort=fecha_ingreso:asc');
    orders = res.data || [];
} catch (e: any) {
    error = 'Error al cargar agenda: ' + e.message;
}

const getOrdersForDay = (date: Date) => {
    const dateStr = date.toISOString().split('T')[0];
    return orders.filter((o: any) => o.fecha_ingreso === dateStr);
};

const formatStatus = (status: string) => {
    const map: Record<string, string> = {
        ingresado: 'Ingresado',
        en_diagnostico: 'Diagnóstico',
        en_reparacion: 'Reparación',
        finalizado: 'Finalizado',
        entregado: 'Entregado'
    };
    return map[status] || status;
};

const getStatusColor = (status: string) => {
    switch(status) {
        case 'ingresado': return 'bg-blue-100 text-blue-800 border-blue-200';
        case 'en_diagnostico': return 'bg-purple-100 text-purple-800 border-purple-200';
        case 'en_reparacion': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
        case 'finalizado': return 'bg-green-100 text-green-800 border-green-200';
        default: return 'bg-gray-100 text-gray-800 border-gray-200';
    }
};
---

<DashboardLayout title="Agenda Semanal" role="recepcionista" currentPath={Astro.url.pathname}>
    <div class="flex flex-col h-full">
        <div class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Agenda Semanal</h1>
                <p class="text-gray-500 dark:text-gray-400">
                    Semana del {weekDays[0].toLocaleDateString('es-CL')} al {weekDays[4].toLocaleDateString('es-CL')}
                </p>
            </div>
            <div class="flex gap-2">
                <button class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <button class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm">
                    Hoy
                </button>
                <button class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
            </div>
        </div>

        {error && (
            <div class="p-4 mb-4 text-red-700 bg-red-100 rounded-lg">
                {error}
            </div>
        )}

        <div class="grid grid-cols-5 gap-4 flex-1 min-h-[600px]">
            {weekDays.map((day) => {
                const dayOrders = getOrdersForDay(day);
                const isToday = day.toDateString() === new Date().toDateString();
                
                return (
                    <div class={`flex flex-col h-full rounded-xl border ${isToday ? 'border-primary-500 bg-primary-50/30 dark:bg-primary-900/10' : 'border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50'}`}>
                        <!-- Day Header -->
                        <div class={`p-3 text-center border-b ${isToday ? 'border-primary-200 dark:border-primary-800' : 'border-gray-200 dark:border-gray-700'}`}>
                            <p class={`text-sm font-medium ${isToday ? 'text-primary-700 dark:text-primary-400' : 'text-gray-500 dark:text-gray-400'}`}>
                                {day.toLocaleDateString('es-CL', { weekday: 'long' })}
                            </p>
                            <p class={`text-2xl font-bold ${isToday ? 'text-primary-800 dark:text-primary-300' : 'text-gray-900 dark:text-white'}`}>
                                {day.getDate()}
                            </p>
                        </div>

                        <!-- Slots -->
                        <div class="flex-1 p-2 space-y-2 overflow-y-auto">
                            {dayOrders.length > 0 ? (
                                dayOrders.map((order: any) => (
                                    <a href={`/recepcion/ver_estado_orden?id=${order.documentId}`} class="block">
                                        <div class={`p-3 rounded-lg border shadow-sm hover:shadow-md transition-shadow cursor-pointer bg-white dark:bg-gray-800 ${getStatusColor(order.estado)}`}>
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="font-bold text-xs">OT-{order.id}</span>
                                                <span class="text-[10px] uppercase font-bold opacity-75">{formatStatus(order.estado)}</span>
                                            </div>
                                            <p class="font-medium text-sm truncate text-gray-900 dark:text-white">
                                                {order.vehiculo?.marca} {order.vehiculo?.modelo}
                                            </p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate mt-1">
                                                {order.vehiculo?.patente}
                                            </p>
                                        </div>
                                    </a>
                                ))
                            ) : (
                                <div class="h-full flex items-center justify-center opacity-30">
                                    <span class="material-symbols-outlined text-4xl">calendar_today</span>
                                </div>
                            )}
                        </div>
                        
                        <!-- Add Button -->
                        <div class="p-2 border-t border-gray-200 dark:border-gray-700">
                            <a href={`/recepcion/crear_orden?date=${day.toISOString().split('T')[0]}`} class="flex items-center justify-center w-full py-2 rounded-lg border border-dashed border-gray-300 dark:border-gray-600 text-gray-500 hover:bg-white dark:hover:bg-gray-700 hover:text-primary-600 hover:border-primary-300 transition-colors text-sm">
                                <span class="material-symbols-outlined text-lg mr-1">add</span>
                                Agendar
                            </a>
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
</DashboardLayout>
