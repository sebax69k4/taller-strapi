---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

const apiBase = import.meta.env.PUBLIC_STRAPI_URL || 'http://localhost:1337';
---

<DashboardLayout title="Consultar Estado de Orden" role="recepcionista" currentPath="/recepcion/ver_estado_orden">
  <div class="max-w-6xl mx-auto"
    x-data=`{
      apiBase: '${apiBase}',
      recentOrders: [],
      searchResults: [],
      searchQuery: '',
      searchType: 'patente',
      loading: true,
      searching: false,
      lastUpdate: null,
      searchPerformed: false,

      estadoSteps: { ingresado: 1, en_diagnostico: 2, en_reparacion: 3, finalizado: 4, facturado: 5, entregado: 6 },

      estadoInfo: {
        ingresado: { label: 'Ingresado', color: 'text-gray-700', bgColor: 'bg-gray-100', icon: 'login' },
        en_diagnostico: { label: 'En DiagnÃ³stico', color: 'text-amber-700', bgColor: 'bg-amber-100', icon: 'search' },
        en_reparacion: { label: 'En ReparaciÃ³n', color: 'text-blue-700', bgColor: 'bg-blue-100', icon: 'build' },
        finalizado: { label: 'Finalizado', color: 'text-purple-700', bgColor: 'bg-purple-100', icon: 'check_circle' },
        facturado: { label: 'Listo para Entrega', color: 'text-green-700', bgColor: 'bg-green-100', icon: 'key' },
        entregado: { label: 'Entregado', color: 'text-emerald-700', bgColor: 'bg-emerald-100', icon: 'task_alt' }
      },

      get ingresadosCount() { return this.recentOrders.filter(o => o.estado === 'ingresado').length; },
      get diagnosticoCount() { return this.recentOrders.filter(o => o.estado === 'en_diagnostico').length; },
      get reparacionCount() { return this.recentOrders.filter(o => o.estado === 'en_reparacion').length; },
      get finalizadosCount() { return this.recentOrders.filter(o => ['finalizado', 'facturado'].includes(o.estado)).length; },

      getEstado(estado) {
        return this.estadoInfo[estado] || { label: estado, color: 'text-gray-700', bgColor: 'bg-gray-100', icon: 'help' };
      },

      formatTimeAgo(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        if (diffMins < 60) return 'hace ' + diffMins + ' min';
        if (diffHours < 24) return 'hace ' + diffHours + 'h';
        if (diffDays === 1) return 'ayer';
        return 'hace ' + diffDays + ' dÃ­as';
      },

      getTimeSinceUpdate() {
        if (!this.lastUpdate) return '';
        const s = Math.floor((new Date() - this.lastUpdate) / 1000);
        return s < 60 ? 'hace ' + s + 's' : 'hace ' + Math.floor(s/60) + 'm';
      },

      async fetchRecent() {
        try {
          const res = await fetch(this.apiBase + '/api/orden-de-trabajos?sort=updatedAt:desc&pagination[limit]=6&populate[vehiculo][populate]=cliente&populate=mecanico&filters[estado][$notIn][0]=entregado');
          const data = await res.json();
          if (data.data) this.recentOrders = data.data;
          this.lastUpdate = new Date();
          this.loading = false;
        } catch(e) { console.error(e); this.loading = false; }
      },

      async search() {
        if (!this.searchQuery.trim()) return;
        this.searching = true;
        this.searchPerformed = true;
        try {
          let url = this.apiBase + '/api/orden-de-trabajos?';
          if (this.searchType === 'patente') url += 'filters[vehiculo][patente][$containsi]=' + this.searchQuery;
          else if (this.searchType === 'orden') url += 'filters[id][$eq]=' + this.searchQuery;
          else if (this.searchType === 'cliente') url += 'filters[$or][0][vehiculo][cliente][nombre][$containsi]=' + this.searchQuery + '&filters[$or][1][vehiculo][cliente][apellido][$containsi]=' + this.searchQuery;
          url += '&populate[vehiculo][populate]=cliente&populate=mecanico&sort=updatedAt:desc&pagination[limit]=10';
          const res = await fetch(url);
          const data = await res.json();
          this.searchResults = data.data || [];
        } catch(e) { console.error(e); }
        this.searching = false;
      },

      clearSearch() {
        this.searchQuery = '';
        this.searchResults = [];
        this.searchPerformed = false;
      },

      init() {
        this.fetchRecent();
        setInterval(() => this.fetchRecent(), 15000);
      }
    }`
  >
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Consultar Estado de Orden</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1">Busca y rastrea el estado de las Ã³rdenes de trabajo</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 text-sm text-gray-500 bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700">
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
          <span>Actualizado <span x-text="getTimeSinceUpdate()"></span></span>
          <button @click="fetchRecent()" class="text-primary-600 hover:text-primary-700 ml-1">
            <span class="material-symbols-outlined text-sm" :class="loading && 'animate-spin'">refresh</span>
          </button>
        </div>
        <a href="/recepcion/crear_orden" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
          <span class="material-symbols-outlined">add</span>
          Nueva Orden
        </a>
      </div>
    </div>

    <!-- Search Form -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-6 mb-8 shadow-sm">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="md:w-48">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buscar por</label>
          <select x-model="searchType" class="w-full px-3 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900">
            <option value="patente">ðŸš— Patente</option>
            <option value="orden">ðŸ“‹ NÂ° Orden</option>
            <option value="cliente">ðŸ‘¤ Cliente</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Valor a buscar</label>
          <div class="relative">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
            <input type="text" x-model="searchQuery" @keyup.enter="search()" placeholder="Ej: ABC123, 45, Juan..."
              class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900" />
          </div>
        </div>
        <div class="flex items-end gap-2">
          <button @click="search()" :disabled="searching" class="px-6 py-2.5 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 flex items-center gap-2">
            <span class="material-symbols-outlined" :class="searching && 'animate-spin'">search</span>
            Buscar
          </button>
          <button x-show="searchPerformed" @click="clearSearch()" class="px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <template x-if="loading">
      <div class="flex items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
      </div>
    </template>

    <template x-if="!loading">
      <div>
        <!-- Search Results -->
        <template x-if="searchPerformed && searchResults.length > 0">
          <div class="mb-8">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-primary-600">fact_check</span>
              Resultados (<span x-text="searchResults.length"></span>)
            </h2>
            <div class="grid gap-4">
              <template x-for="order in searchResults" :key="order.id">
                <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg">
                  <div class="p-5 flex flex-col md:flex-row md:items-center gap-4">
                    <div class="flex items-center gap-4 flex-1">
                      <div class="w-14 h-14 rounded-xl flex items-center justify-center" :class="getEstado(order.estado).bgColor">
                        <span class="material-symbols-outlined text-2xl" :class="getEstado(order.estado).color" x-text="getEstado(order.estado).icon"></span>
                      </div>
                      <div class="flex-1">
                        <div class="flex items-center gap-2 flex-wrap">
                          <span class="font-bold text-lg text-gray-900 dark:text-white" x-text="'OT-' + order.id"></span>
                          <span class="text-xs px-2 py-0.5 rounded-full font-medium" :class="getEstado(order.estado).bgColor + ' ' + getEstado(order.estado).color" x-text="getEstado(order.estado).label"></span>
                        </div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">
                          <span x-text="(order.vehiculo?.marca || '') + ' ' + (order.vehiculo?.modelo || '')"></span> â€¢ 
                          <span class="font-mono font-bold" x-text="order.vehiculo?.patente"></span>
                        </p>
                      </div>
                    </div>
                    <div class="flex items-center gap-6 text-sm">
                      <div class="text-center">
                        <p class="text-gray-400 text-xs">Cliente</p>
                        <p class="font-medium text-gray-900 dark:text-white" x-text="(order.vehiculo?.cliente?.nombre || '') + ' ' + (order.vehiculo?.cliente?.apellido || '')"></p>
                      </div>
                    </div>
                  </div>
                  <!-- Progress bar -->
                  <div class="px-5 pb-5">
                    <div class="flex items-center gap-2">
                      <template x-for="step in [1,2,3,4,5,6]" :key="step">
                        <div class="flex-1 h-2 rounded-full" :class="estadoSteps[order.estado] >= step ? 'bg-primary-500' : 'bg-gray-200 dark:bg-gray-700'"></div>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>

        <template x-if="searchPerformed && searchResults.length === 0">
          <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-12 text-center mb-8">
            <span class="material-symbols-outlined text-5xl text-gray-300 mb-4">search_off</span>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">No se encontraron Ã³rdenes</h3>
            <p class="text-gray-500">Verifica los datos ingresados e intenta nuevamente.</p>
          </div>
        </template>

        <!-- Recent Orders -->
        <template x-if="!searchPerformed && recentOrders.length > 0">
          <div>
            <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-primary-600">schedule</span>
              Ã“rdenes Recientes en Taller
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <template x-for="order in recentOrders" :key="order.id">
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 hover:shadow-lg hover:border-primary-300 transition-all cursor-pointer" @click="searchQuery = order.id; searchType = 'orden'; search();">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-lg flex items-center justify-center" :class="getEstado(order.estado).bgColor">
                        <span class="material-symbols-outlined" :class="getEstado(order.estado).color" x-text="getEstado(order.estado).icon"></span>
                      </div>
                      <div>
                        <p class="font-bold text-gray-900 dark:text-white" x-text="'OT-' + order.id"></p>
                        <p class="text-xs text-gray-500" x-text="formatTimeAgo(order.updatedAt)"></p>
                      </div>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full font-medium" :class="getEstado(order.estado).bgColor + ' ' + getEstado(order.estado).color" x-text="getEstado(order.estado).label"></span>
                  </div>
                  <div class="space-y-2">
                    <div class="flex items-center gap-2 text-sm">
                      <span class="material-symbols-outlined text-gray-400 text-sm">directions_car</span>
                      <span class="text-gray-600 dark:text-gray-300" x-text="(order.vehiculo?.marca || '') + ' ' + (order.vehiculo?.modelo || '')"></span>
                      <span class="font-mono text-xs bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded" x-text="order.vehiculo?.patente"></span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                      <span class="material-symbols-outlined text-gray-400 text-sm">person</span>
                      <span class="text-gray-600 dark:text-gray-300" x-text="(order.vehiculo?.cliente?.nombre || '') + ' ' + (order.vehiculo?.cliente?.apellido || '')"></span>
                    </div>
                  </div>
                  <!-- Mini progress -->
                  <div class="mt-4 flex items-center gap-1">
                    <template x-for="step in [1,2,3,4,5]" :key="step">
                      <div class="flex-1 h-1.5 rounded-full" :class="estadoSteps[order.estado] >= step ? 'bg-primary-500' : 'bg-gray-200 dark:bg-gray-700'"></div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>

        <!-- Stats -->
        <template x-if="!searchPerformed">
          <div class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-100 dark:bg-gray-700 rounded-xl p-4">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-2xl text-gray-600">login</span>
                <div>
                  <p class="text-2xl font-bold text-gray-700 dark:text-gray-200" x-text="ingresadosCount">0</p>
                  <p class="text-sm text-gray-500">Ingresados</p>
                </div>
              </div>
            </div>
            <div class="bg-amber-100 dark:bg-amber-900/30 rounded-xl p-4">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-2xl text-amber-600">search</span>
                <div>
                  <p class="text-2xl font-bold text-amber-700" x-text="diagnosticoCount">0</p>
                  <p class="text-sm text-amber-600">En DiagnÃ³stico</p>
                </div>
              </div>
            </div>
            <div class="bg-blue-100 dark:bg-blue-900/30 rounded-xl p-4">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-2xl text-blue-600">build</span>
                <div>
                  <p class="text-2xl font-bold text-blue-700" x-text="reparacionCount">0</p>
                  <p class="text-sm text-blue-600">En ReparaciÃ³n</p>
                </div>
              </div>
            </div>
            <div class="bg-green-100 dark:bg-green-900/30 rounded-xl p-4">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-2xl text-green-600">check_circle</span>
                <div>
                  <p class="text-2xl font-bold text-green-700" x-text="finalizadosCount">0</p>
                  <p class="text-sm text-green-600">Finalizados</p>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
    </template>
  </div>
</DashboardLayout>
