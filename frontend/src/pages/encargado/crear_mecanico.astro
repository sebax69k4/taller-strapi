---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import { strapiGet, strapiPost, strapiPut, strapiDelete } from '../../lib/strapi';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

// Obtener mecánico para editar (si hay ID)
const editId = Astro.url.searchParams.get('edit');
let mecanicoToEdit: any = null;
let zonas: any[] = [];
let error = '';
let successMessage = '';

// Cargar zonas disponibles
try {
  const zonasRes = await strapiGet('/api/zonas');
  zonas = zonasRes.data || [];
} catch (e) {
  console.error('Error loading zones:', e);
}

// Cargar mecánico si está en modo edición
if (editId) {
  try {
    const res = await strapiGet(`/api/mecenicos/${editId}?populate=zona`);
    mecanicoToEdit = res.data;
  } catch (e: any) {
    error = 'No se encontró el mecánico';
  }
}

// Manejar POST
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    
    if (action === 'delete') {
      const deleteId = formData.get('deleteId') as string;
      await strapiDelete(`/api/mecenicos/${deleteId}`);
      return Astro.redirect('/encargado/gestion_mecanicos?message=' + encodeURIComponent('Mecánico eliminado correctamente') + '&type=success');
    }
    
    const nombre = formData.get('nombre') as string;
    const apellido = formData.get('apellido') as string;
    const especialidad = formData.get('especialidad') as string;
    const email = formData.get('email') as string;
    const estado = formData.get('estado') as string;
    const zonaId = formData.get('zona') as string;

    // Validar campos requeridos
    if (!nombre || !nombre.trim()) {
      error = 'El nombre es requerido';
    } else {
      const data: any = {
        nombre: nombre.trim(),
        apellido: apellido?.trim() || '',
        especialidad: especialidad?.trim() || 'General',
        email: email?.trim() || null,
        estado: estado || 'disponible',
        ordenes_activas: 0
      };
      
      if (zonaId && zonaId !== '') {
        data.zona = zonaId;
      }

      if (editId) {
        // Actualizar
        await strapiPut(`/api/mecenicos/${editId}`, data);
        return Astro.redirect('/encargado/gestion_mecanicos?message=' + encodeURIComponent('Mecánico actualizado correctamente') + '&type=success');
      } else {
        // Crear nuevo
        await strapiPost('/api/mecenicos', data);
        return Astro.redirect('/encargado/gestion_mecanicos?message=' + encodeURIComponent('Mecánico creado correctamente') + '&type=success');
      }
    }
  } catch (e: any) {
    console.error('Error:', e);
    error = e.message || 'Error al guardar el mecánico';
  }
}

const especialidades = [
  'General',
  'Motor',
  'Transmisión',
  'Frenos',
  'Suspensión',
  'Electricidad',
  'Aire Acondicionado',
  'Pintura',
  'Carrocería',
  'Diagnóstico Electrónico',
  'Neumáticos'
];

const estados = [
  { value: 'disponible', label: 'Disponible', color: 'text-green-600' },
  { value: 'ocupado', label: 'Ocupado', color: 'text-blue-600' },
  { value: 'descanso', label: 'En Descanso', color: 'text-amber-600' },
  { value: 'ausente', label: 'Ausente', color: 'text-red-600' }
];
---

<DashboardLayout title={editId ? 'Editar Mecánico' : 'Agregar Mecánico'} role="encargado" currentPath="/encargado/crear_mecanico">
  <div class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="flex items-center gap-4 mb-6">
      <a href="/encargado/gestion_mecanicos" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
        <span class="material-symbols-outlined">arrow_back</span>
      </a>
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">
          {editId ? 'Editar Mecánico' : 'Agregar Mecánico'}
        </h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1">
          {editId ? 'Actualiza la información del mecánico' : 'Registra un nuevo mecánico en el sistema'}
        </p>
      </div>
    </div>

    <!-- Error Message -->
    {error && (
      <div class="p-4 mb-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-800 dark:text-red-200 flex items-center gap-2">
        <span class="material-symbols-outlined">error</span>
        <span>{error}</span>
      </div>
    )}

    <!-- Form -->
    <Card>
      <form method="POST" class="space-y-6">
        <!-- Información Personal -->
        <div>
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-primary-500">person</span>
            Información Personal
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Nombre <span class="text-red-500">*</span>
              </label>
              <input 
                type="text" 
                name="nombre"
                value={mecanicoToEdit?.nombre || ''}
                required
                placeholder="Ej: Juan"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Apellido
              </label>
              <input 
                type="text" 
                name="apellido"
                value={mecanicoToEdit?.apellido || ''}
                placeholder="Ej: Pérez"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              />
            </div>
          </div>
        </div>

        <!-- Contacto -->
        <div>
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-primary-500">contact_mail</span>
            Contacto
          </h3>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Email
            </label>
            <input 
              type="email" 
              name="email"
              value={mecanicoToEdit?.email || ''}
              placeholder="juan.perez@taller.com"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            />
          </div>
        </div>

        <!-- Trabajo -->
        <div>
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-primary-500">work</span>
            Información Laboral
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Especialidad
              </label>
              <select 
                name="especialidad"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              >
                {especialidades.map(esp => (
                  <option value={esp} selected={mecanicoToEdit?.especialidad === esp}>{esp}</option>
                ))}
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Estado
              </label>
              <select 
                name="estado"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              >
                {estados.map(est => (
                  <option value={est.value} selected={mecanicoToEdit?.estado === est.value}>{est.label}</option>
                ))}
              </select>
            </div>
          </div>
          
          {zonas.length > 0 && (
            <div class="mt-4">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Zona Asignada
              </label>
              <select 
                name="zona"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent"
              >
                <option value="">Sin zona asignada</option>
                {zonas.map((zona: any) => (
                  <option value={zona.documentId} selected={mecanicoToEdit?.zona?.documentId === zona.documentId}>
                    {zona.nombre}
                  </option>
                ))}
              </select>
            </div>
          )}
        </div>

        <!-- Preview Card -->
        <div class="pt-6 border-t border-gray-100 dark:border-gray-700">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Vista previa</h3>
          <div class="bg-gray-50 dark:bg-gray-900/50 rounded-xl p-4 flex items-center gap-4" x-data>
            <div class="w-14 h-14 rounded-full bg-primary-500 flex items-center justify-center text-white text-xl font-bold">
              <span x-text="($refs.nombre?.value || 'M').charAt(0).toUpperCase()">M</span>
            </div>
            <div class="flex-1">
              <p class="font-bold text-gray-900 dark:text-white" x-text="($refs.nombre?.value || 'Nombre') + ' ' + ($refs.apellido?.value || '')">
                {mecanicoToEdit ? `${mecanicoToEdit.nombre} ${mecanicoToEdit.apellido || ''}` : 'Nombre del Mecánico'}
              </p>
              <p class="text-sm text-gray-500" x-text="$refs.especialidad?.value || 'General'">
                {mecanicoToEdit?.especialidad || 'General'}
              </p>
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300">
              Disponible
            </span>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-4 pt-4">
          <button 
            type="submit"
            class="flex-1 px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center justify-center gap-2"
          >
            <span class="material-symbols-outlined">{editId ? 'save' : 'person_add'}</span>
            {editId ? 'Guardar Cambios' : 'Crear Mecánico'}
          </button>
          <a 
            href="/encargado/gestion_mecanicos"
            class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
          >
            Cancelar
          </a>
        </div>
      </form>
    </Card>

    <!-- Danger Zone (solo en edición) -->
    {editId && mecanicoToEdit && (
      <Card class="mt-6 border-red-200 dark:border-red-800">
        <h3 class="text-lg font-bold text-red-600 dark:text-red-400 mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined">warning</span>
          Zona de Peligro
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Esta acción eliminará permanentemente al mecánico y no se puede deshacer.
        </p>
        <form method="POST" onsubmit="return confirm('¿Estás seguro de eliminar este mecánico? Esta acción no se puede deshacer.')">
          <input type="hidden" name="action" value="delete" />
          <input type="hidden" name="deleteId" value={editId} />
          <button 
            type="submit"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2"
          >
            <span class="material-symbols-outlined">delete</span>
            Eliminar Mecánico
          </button>
        </form>
      </Card>
    )}
  </div>
</DashboardLayout>
