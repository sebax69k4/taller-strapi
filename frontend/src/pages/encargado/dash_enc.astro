---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
const userName = Astro.cookies.get('user_name')?.value || 'Encargado';
const apiBase = import.meta.env.PUBLIC_STRAPI_URL || 'http://localhost:1337';

if (!userRole) {
  return Astro.redirect('/login');
}

const getGreeting = () => {
  const hour = new Date().getHours();
  if (hour < 12) return '¡Buenos días';
  if (hour < 18) return '¡Buenas tardes';
  return '¡Buenas noches';
};
---

<DashboardLayout title="Dashboard Encargado" role="encargado" currentPath={Astro.url.pathname}>
  <div class="max-w-7xl mx-auto"
    x-data=`{
      apiBase: '${apiBase}',
      loading: true,
      lastUpdate: null,

      // KPIs
      activeOrdersCount: 0,
      completedTodayCount: 0,
      lowStockCount: 0,
      pendingInvoices: 0,
      ingresosSemana: 0,
      ordenesHoy: 0,

      // Data
      recentOrders: [],
      lowStockItems: [],
      mecanicosDisponibles: [],
      ordenesUrgentes: [],
      ordenesPorEstado: {},

      get totalOrdenesTaller() {
        return Object.values(this.ordenesPorEstado).reduce((a, b) => a + b, 0);
      },

      formatCurrency(amount) {
        return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(amount);
      },

      formatStatus(status) {
        const map = { ingresado: 'Ingresado', en_diagnostico: 'Diagnóstico', en_reparacion: 'Reparación', finalizado: 'Finalizado', facturado: 'Facturado', entregado: 'Entregado' };
        return map[status] || status;
      },

      getStatusColor(status) {
        const colors = { ingresado: 'bg-red-500', en_diagnostico: 'bg-purple-500', en_reparacion: 'bg-amber-500', finalizado: 'bg-green-500', facturado: 'bg-blue-500' };
        return colors[status] || 'bg-gray-500';
      },

      getStatusBg(status) {
        const bg = { ingresado: 'bg-amber-100 text-amber-700', en_diagnostico: 'bg-blue-100 text-blue-700', en_reparacion: 'bg-purple-100 text-purple-700', finalizado: 'bg-green-100 text-green-700', facturado: 'bg-blue-100 text-blue-700' };
        return bg[status] || 'bg-gray-100 text-gray-700';
      },

      formatTimeAgo(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 60) return 'hace ' + diffMins + ' min';
        if (diffMins < 1440) return 'hace ' + Math.floor(diffMins / 60) + 'h';
        return 'hace ' + Math.floor(diffMins / 1440) + ' días';
      },

      getTimeSinceUpdate() {
        if (!this.lastUpdate) return '';
        const s = Math.floor((new Date() - this.lastUpdate) / 1000);
        return s < 60 ? 'hace ' + s + 's' : 'hace ' + Math.floor(s/60) + 'm';
      },

      async fetchData() {
        const today = new Date().toISOString().split('T')[0];
        const weekStart = new Date();
        weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
        const weekStartStr = weekStart.toISOString().split('T')[0];

        try {
          const [activeRes, completedRes, repuestosRes, recentRes, mecanicosRes, urgentesRes, facturasRes, pendingRes, ingRes, diagRes, repRes, finRes, factRes, hoyRes] = await Promise.all([
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$notIn][0]=entregado&filters[estado][$notIn][1]=facturado'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=entregado&filters[updatedAt][$gte]=' + today),
            fetch(this.apiBase + '/api/repuestos?pagination[limit]=100'),
            fetch(this.apiBase + '/api/orden-de-trabajos?sort=updatedAt:desc&pagination[limit]=8&populate[vehiculo][populate]=cliente&populate=mecanico'),
            fetch(this.apiBase + '/api/mecenicos?populate[orden_de_trabajos][filters][estado][$notIn][0]=entregado&populate[orden_de_trabajos][filters][estado][$notIn][1]=facturado'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[prioridad][$eq]=urgente&filters[estado][$notIn][0]=entregado&filters[estado][$notIn][1]=facturado&populate=vehiculo'),
            fetch(this.apiBase + '/api/facturas?filters[fecha_emision][$gte]=' + weekStartStr + '&filters[estado][$eq]=pagado'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=finalizado'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=ingresado&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=en_diagnostico&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=en_reparacion&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=finalizado&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[estado][$eq]=facturado&pagination[pageSize]=1'),
            fetch(this.apiBase + '/api/orden-de-trabajos?filters[createdAt][$gte]=' + today + '&pagination[pageSize]=1')
          ]);

          const [activeData, completedData, repuestosData, recentData, mecanicosData, urgentesData, facturasData, pendingData, ingData, diagData, repData, finData, factData, hoyData] = await Promise.all([
            activeRes.json(), completedRes.json(), repuestosRes.json(), recentRes.json(), mecanicosData = mecanicosRes.json(), urgentesRes.json(), facturasRes.json(), pendingRes.json(), ingRes.json(), diagRes.json(), repRes.json(), finRes.json(), factRes.json(), hoyRes.json()
          ]);

          this.activeOrdersCount = activeData.meta?.pagination?.total || 0;
          this.completedTodayCount = completedData.meta?.pagination?.total || 0;
          this.ordenesHoy = hoyData.meta?.pagination?.total || 0;
          this.pendingInvoices = pendingData.meta?.pagination?.total || 0;

          // Low stock
          const allRepuestos = repuestosData.data || [];
          this.lowStockItems = allRepuestos.filter(item => (item.stock || 0) <= (item.stock_minimo || 5)).slice(0, 5);
          this.lowStockCount = this.lowStockItems.length;

          // Recent orders
          this.recentOrders = recentData.data || [];

          // Mechanics
          this.mecanicosDisponibles = (mecanicosData.data || []).map(m => ({
            ...m,
            ordenesActivas: m.orden_de_trabajos?.length || 0
          })).sort((a, b) => a.ordenesActivas - b.ordenesActivas);

          // Urgent orders
          this.ordenesUrgentes = urgentesData.data || [];

          // Weekly income
          this.ingresosSemana = (facturasData.data || []).reduce((sum, f) => sum + (f.total || 0), 0);

          // Estados
          this.ordenesPorEstado = {
            ingresado: ingData.meta?.pagination?.total || 0,
            en_diagnostico: diagData.meta?.pagination?.total || 0,
            en_reparacion: repData.meta?.pagination?.total || 0,
            finalizado: finData.meta?.pagination?.total || 0,
            facturado: factData.meta?.pagination?.total || 0
          };

          this.lastUpdate = new Date();
          this.loading = false;
        } catch(e) {
          console.error('Error:', e);
          this.loading = false;
        }
      },

      init() {
        this.fetchData();
        setInterval(() => this.fetchData(), 15000);
      }
    }`
  >
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">
          {getGreeting()}, {userName}!
        </h1>
        <p class="text-gray-500 dark:text-gray-400 flex items-center gap-2 mt-1">
          <span class="material-symbols-outlined text-sm">calendar_today</span>
          {new Date().toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
        </p>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 text-sm text-gray-500 bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700">
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
          <span>Actualizado <span x-text="getTimeSinceUpdate()"></span></span>
          <button @click="fetchData()" class="text-primary-600 hover:text-primary-700 ml-1">
            <span class="material-symbols-outlined text-sm" :class="loading && 'animate-spin'">refresh</span>
          </button>
        </div>
        <a href="/encargado/asig_orden" class="px-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50">
          <span class="material-symbols-outlined">assignment_ind</span>
        </a>
        <a href="/encargado/gen_factura" class="px-4 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 flex items-center gap-2 shadow-lg shadow-primary-600/20">
          <span class="material-symbols-outlined">receipt_long</span>
          Facturar
        </a>
      </div>
    </div>

    <!-- Loading -->
    <template x-if="loading">
      <div class="flex items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
      </div>
    </template>

    <template x-if="!loading">
      <div>
        <!-- Alertas Urgentes -->
        <template x-if="ordenesUrgentes.length > 0 || lowStockCount > 3">
          <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <template x-if="ordenesUrgentes.length > 0">
              <a href="/encargado/trabajos_en_curso" class="bg-gradient-to-r from-red-500 to-rose-600 rounded-2xl p-4 text-white flex items-center gap-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <span class="material-symbols-outlined text-2xl">priority_high</span>
                </div>
                <div>
                  <p class="font-bold text-lg" x-text="ordenesUrgentes.length + ' ÓRDENES URGENTES'"></p>
                  <p class="text-red-100 text-sm">Requieren atención inmediata</p>
                </div>
              </a>
            </template>
            <template x-if="lowStockCount > 3">
              <a href="/encargado/alert_stock" class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-2xl p-4 text-white flex items-center gap-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <span class="material-symbols-outlined text-2xl">inventory_2</span>
                </div>
                <div>
                  <p class="font-bold text-lg" x-text="lowStockCount + ' REPUESTOS BAJO STOCK'"></p>
                  <p class="text-amber-100 text-sm">Es necesario reabastecer</p>
                </div>
              </a>
            </template>
          </div>
        </template>

        <!-- KPIs -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-5 text-white shadow-lg">
            <div class="flex items-center justify-between mb-3">
              <span class="text-blue-100 text-sm font-medium">Órdenes Activas</span>
              <div class="p-2 bg-white/20 rounded-lg"><span class="material-symbols-outlined">build</span></div>
            </div>
            <p class="text-4xl font-bold" x-text="activeOrdersCount">0</p>
            <p class="text-blue-100 text-sm mt-1">en el taller</p>
          </div>

          <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg">
            <div class="flex items-center justify-between mb-3">
              <span class="text-green-100 text-sm font-medium">Por Facturar</span>
              <div class="p-2 bg-white/20 rounded-lg"><span class="material-symbols-outlined">receipt</span></div>
            </div>
            <p class="text-4xl font-bold" x-text="pendingInvoices">0</p>
            <p class="text-green-100 text-sm mt-1">órdenes finalizadas</p>
          </div>

          <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-5 text-white shadow-lg">
            <div class="flex items-center justify-between mb-3">
              <span class="text-purple-100 text-sm font-medium">Ingresos Semana</span>
              <div class="p-2 bg-white/20 rounded-lg"><span class="material-symbols-outlined">payments</span></div>
            </div>
            <p class="text-2xl font-bold" x-text="formatCurrency(ingresosSemana)">$0</p>
            <p class="text-purple-100 text-sm mt-1">facturas pagadas</p>
          </div>

          <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-5 text-white shadow-lg relative">
            <template x-if="lowStockCount > 0">
              <div class="absolute top-2 right-2 w-3 h-3 bg-white rounded-full animate-ping"></div>
            </template>
            <div class="flex items-center justify-between mb-3">
              <span class="text-amber-100 text-sm font-medium">Alertas Stock</span>
              <div class="p-2 bg-white/20 rounded-lg"><span class="material-symbols-outlined">warning</span></div>
            </div>
            <p class="text-4xl font-bold" x-text="lowStockCount">0</p>
            <p class="text-amber-100 text-sm mt-1">repuestos bajos</p>
          </div>
        </div>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Órdenes Recientes -->
          <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
              <h2 class="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary-600">list_alt</span>
                Actividad Reciente
              </h2>
              <a href="/encargado/trabajos_en_curso" class="text-primary-600 hover:underline text-sm">Ver todos</a>
            </div>
            <div class="divide-y divide-gray-100 dark:divide-gray-700">
              <template x-for="order in recentOrders" :key="order.id">
                <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-lg flex items-center justify-center" :class="getStatusBg(order.estado)">
                        <span class="material-symbols-outlined">directions_car</span>
                      </div>
                      <div>
                        <div class="flex items-center gap-2">
                          <span class="font-bold text-gray-900 dark:text-white" x-text="'OT-' + order.id"></span>
                          <span class="text-xs px-2 py-0.5 rounded-full" :class="getStatusBg(order.estado)" x-text="formatStatus(order.estado)"></span>
                        </div>
                        <p class="text-sm text-gray-500" x-text="(order.vehiculo?.marca || '') + ' ' + (order.vehiculo?.modelo || '') + ' - ' + (order.vehiculo?.patente || '')"></p>
                      </div>
                    </div>
                    <div class="text-right">
                      <p class="text-xs text-gray-400" x-text="formatTimeAgo(order.updatedAt)"></p>
                      <p class="text-sm text-gray-600 dark:text-gray-300" x-text="order.mecanico ? (order.mecanico.nombre || '') : 'Sin asignar'"></p>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Panel Derecho -->
          <div class="space-y-6">
            <!-- Estado del Taller -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary-600">analytics</span>
                Pipeline del Taller
              </h3>
              <div class="space-y-3">
                <template x-for="(count, estado) in ordenesPorEstado" :key="estado">
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-gray-600 dark:text-gray-300" x-text="formatStatus(estado)"></span>
                      <span class="font-bold" x-text="count"></span>
                    </div>
                    <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                      <div class="h-full rounded-full transition-all" :class="getStatusColor(estado)" :style="'width: ' + (totalOrdenesTaller > 0 ? (count / totalOrdenesTaller * 100) : 0) + '%'"></div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- Mecánicos -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary-600">engineering</span>
                Carga de Mecánicos
              </h3>
              <div class="space-y-3">
                <template x-for="mec in mecanicosDisponibles.slice(0, 5)" :key="mec.id">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                        <span class="text-xs font-bold" x-text="(mec.nombre || 'M')[0]"></span>
                      </div>
                      <span class="text-sm text-gray-700 dark:text-gray-300" x-text="mec.nombre || 'Mecánico'"></span>
                    </div>
                    <span class="text-sm font-bold" :class="mec.ordenesActivas > 3 ? 'text-red-600' : 'text-green-600'" x-text="mec.ordenesActivas + ' órdenes'"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- Stock Bajo -->
            <template x-if="lowStockItems.length > 0">
              <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-5">
                <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                  <span class="material-symbols-outlined text-amber-600">warning</span>
                  Stock Bajo
                </h3>
                <div class="space-y-2">
                  <template x-for="item in lowStockItems" :key="item.id">
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-gray-700 dark:text-gray-300" x-text="item.nombre"></span>
                      <span class="font-bold text-red-600" x-text="item.stock + ' uds'"></span>
                    </div>
                  </template>
                </div>
                <a href="/encargado/alert_stock" class="mt-4 block text-center text-primary-600 hover:underline text-sm">Ver todos</a>
              </div>
            </template>
          </div>
        </div>
      </div>
    </template>
  </div>
</DashboardLayout>
