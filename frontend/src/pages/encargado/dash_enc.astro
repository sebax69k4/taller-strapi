---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import { strapiGet } from '../../lib/strapi';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
const userName = Astro.cookies.get('user_name')?.value;

let activeOrdersCount = 0;
let completedTodayCount = 0;
let lowStockCount = 0;
let recentOrders: any[] = [];
let lowStockItems: any[] = [];

const today = new Date().toISOString().split('T')[0];

if (userRole) {
  try {
    // Active Orders (excluding 'entregado' and 'facturado')
    const activeRes = await strapiGet('/api/orden-de-trabajos?filters[estado][$notIn][0]=entregado&filters[estado][$notIn][1]=facturado');
    activeOrdersCount = activeRes.meta?.pagination?.total || 0;

    // Completed Today
    const completedRes = await strapiGet(`/api/orden-de-trabajos?filters[estado][$eq]=entregado&filters[updatedAt][$gte]=${today}`);
    completedTodayCount = completedRes.meta?.pagination?.total || 0;

    // Low Stock - fetch all and filter where stock <= stock_minimo
    const allRepuestosRes = await strapiGet('/api/repuestos');
    const allRepuestos = allRepuestosRes.data || [];
    lowStockItems = allRepuestos.filter((item: any) => {
      const stock = item.stock || 0;
      const min = item.stock_minimo || 5;
      return stock <= min;
    });
    lowStockCount = lowStockItems.length;

    // Recent Activity - cliente viene anidado en vehiculo
    const recentRes = await strapiGet('/api/orden-de-trabajos?sort[0]=updatedAt:desc&pagination[limit]=5&populate[vehiculo][populate][cliente][fields][0]=nombre&populate[vehiculo][populate][cliente][fields][1]=apellido&populate[mecanico][fields][0]=nombre&populate[mecanico][fields][1]=apellido');
    // Mapear para tener cliente accesible
    recentOrders = (recentRes.data || []).map((order: any) => ({
      ...order,
      cliente: order.vehiculo?.cliente || null
    }));

  } catch (e) {
    console.error('Error fetching dashboard data:', e);
  }
} else {
  return Astro.redirect('/login');
}
---

<DashboardLayout title="Dashboard Encargado" role="encargado" currentPath={Astro.url.pathname}>
  <div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="flex flex-col gap-2 mb-8">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Dashboard del Encargado</h1>
      <p class="text-gray-500 dark:text-gray-400">Bienvenido {userName}, aquí tienes un resumen de la actividad del taller.</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      <Card class="hover:shadow-lg transition-shadow cursor-pointer border-l-4 border-l-primary-500">
        <div class="flex items-center justify-between mb-4">
          <p class="text-gray-500 dark:text-gray-400 font-medium">Órdenes Activas</p>
          <span class="material-symbols-outlined text-primary-500 bg-primary-50 dark:bg-primary-900/20 p-2 rounded-lg">build_circle</span>
        </div>
        <p class="text-4xl font-bold text-gray-900 dark:text-white mb-1">{activeOrdersCount}</p>
        <p class="text-sm text-green-600 dark:text-green-400 font-medium flex items-center gap-1">
          <span class="material-symbols-outlined text-sm">trending_up</span> En proceso
        </p>
      </Card>

      <Card class="hover:shadow-lg transition-shadow cursor-pointer border-l-4 border-l-green-500">
        <div class="flex items-center justify-between mb-4">
          <p class="text-gray-500 dark:text-gray-400 font-medium">Completadas Hoy</p>
          <span class="material-symbols-outlined text-green-500 bg-green-50 dark:bg-green-900/20 p-2 rounded-lg">task_alt</span>
        </div>
        <p class="text-4xl font-bold text-gray-900 dark:text-white mb-1">{completedTodayCount}</p>
        <p class="text-sm text-green-600 dark:text-green-400 font-medium flex items-center gap-1">
          <span class="material-symbols-outlined text-sm">check_circle</span> Entregadas
        </p>
      </Card>

      <Card class="hover:shadow-lg transition-shadow cursor-pointer border-l-4 border-l-red-500">
        <div class="flex items-center justify-between mb-4">
          <p class="text-gray-500 dark:text-gray-400 font-medium">Stock Bajo Mínimo</p>
          <span class="material-symbols-outlined text-red-500 bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">inventory_2</span>
        </div>
        <p class="text-4xl font-bold text-gray-900 dark:text-white mb-1">{lowStockCount}</p>
        <p class="text-sm text-red-600 dark:text-red-400 font-medium flex items-center gap-1">
          <span class="material-symbols-outlined text-sm">warning</span> Requiere atención
        </p>
      </Card>
    </div>

    <!-- Quick Access -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-primary-600">rocket_launch</span>
        Accesos Rápidos
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <a href="/encargado/inventario" class="group">
          <Card class="h-full hover:border-primary-500 hover:shadow-md transition-all duration-200 group-hover:-translate-y-1">
            <div class="flex flex-col gap-3">
              <div class="w-10 h-10 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors">
                <span class="material-symbols-outlined">inventory</span>
              </div>
              <div>
                <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-blue-600 transition-colors">Inventario</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Gestionar repuestos</p>
              </div>
            </div>
          </Card>
        </a>
        <a href="/encargado/gen_factura" class="group">
          <Card class="h-full hover:border-primary-500 hover:shadow-md transition-all duration-200 group-hover:-translate-y-1">
            <div class="flex flex-col gap-3">
              <div class="w-10 h-10 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition-colors">
                <span class="material-symbols-outlined">receipt_long</span>
              </div>
              <div>
                <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-green-600 transition-colors">Facturación</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Aprobar y facturar</p>
              </div>
            </div>
          </Card>
        </a>
        <a href="/encargado/asig_orden" class="group">
          <Card class="h-full hover:border-primary-500 hover:shadow-md transition-all duration-200 group-hover:-translate-y-1">
            <div class="flex flex-col gap-3">
              <div class="w-10 h-10 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition-colors">
                <span class="material-symbols-outlined">assignment_ind</span>
              </div>
              <div>
                <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-purple-600 transition-colors">Asignar Orden</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Distribuir trabajo</p>
              </div>
            </div>
          </Card>
        </a>
      </div>
    </section>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Recent Activity -->
      <div class="lg:col-span-2">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Actividad Reciente</h2>
        <Card noPadding class="overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
              <thead class="bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-gray-800">
                <tr>
                  <th class="px-6 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">ID</th>
                  <th class="px-6 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Cliente</th>
                  <th class="px-6 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Vehículo</th>
                  <th class="px-6 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Mecánico</th>
                  <th class="px-6 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Estado</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {recentOrders.length > 0 ? (
                  recentOrders.map((order: any) => (
                    <tr class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                      <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">OT-{order.id}</td>
                      <td class="px-6 py-4 text-gray-600 dark:text-gray-300">
                        {order.cliente ? `${order.cliente.nombre} ${order.cliente.apellido}` : 'N/A'}
                      </td>
                      <td class="px-6 py-4 text-gray-600 dark:text-gray-300">
                        {order.vehiculo ? `${order.vehiculo.marca} ${order.vehiculo.modelo}` : 'N/A'}
                      </td>
                      <td class="px-6 py-4 text-gray-600 dark:text-gray-300">
                        {order.mecanico ? order.mecanico.nombre : 'Sin asignar'}
                      </td>
                      <td class="px-6 py-4">
                        <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                          order.estado === 'entregado' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' :
                          order.estado === 'facturado' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300' :
                          order.estado === 'finalizado' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300' :
                          order.estado === 'ingresado' ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' :
                          'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300'
                        }`}>
                          {order.estado === 'ingresado' ? 'Ingresado' :
                           order.estado === 'en_diagnostico' ? 'En Diagnóstico' :
                           order.estado === 'en_reparacion' ? 'En Reparación' :
                           order.estado === 'finalizado' ? 'Finalizado' :
                           order.estado === 'facturado' ? 'Facturado' :
                           order.estado === 'entregado' ? 'Entregado' : order.estado}
                        </span>
                      </td>
                    </tr>
                  ))
                ) : (
                  <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                      No hay órdenes recientes
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </Card>
      </div>

      <!-- Low Stock Alert -->
      <div>
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-red-500">warning</span>
          Stock Bajo
        </h2>
        <Card>
          <div class="space-y-4">
            {lowStockItems.length > 0 ? (
              lowStockItems.map((item: any) => (
                <div class="flex flex-col gap-2">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{item.nombre}</span>
                    <span class="text-xs font-bold text-red-600 dark:text-red-400">{item.stock} unid.</span>
                  </div>
                  <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div 
                      class="bg-red-500 h-2 rounded-full transition-all duration-500" 
                      style={`width: ${Math.min(item.stock * 10, 100)}%`}
                    ></div>
                  </div>
                </div>
              ))
            ) : (
              <div class="text-center py-8">
                <span class="material-symbols-outlined text-green-500 text-4xl mb-2">check_circle</span>
                <p class="text-gray-500 dark:text-gray-400">No hay alertas de stock bajo.</p>
              </div>
            )}
          </div>
          {lowStockItems.length > 0 && (
            <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
              <a href="/encargado/inventario" class="text-sm text-primary-600 dark:text-primary-400 hover:underline flex items-center justify-center gap-1">
                Ver todo el inventario 
                <span class="material-symbols-outlined text-sm">arrow_forward</span>
              </a>
            </div>
          )}
        </Card>
      </div>
    </div>
  </div>
</DashboardLayout>
