---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import { strapiGet } from '../../lib/strapi';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
const userName = Astro.cookies.get('user_name')?.value;
let activeOrdersCount = 0;
let completedTodayCount = 0;
let lowStockCount = 0;
let recentOrders = [];
let lowStockItems = [];

const today = new Date().toISOString().split('T')[0];

if (userRole) {
  try {
    // Active Orders
    const activeRes = await strapiGet('/api/orden-de-trabajos?filters[estado][$ne]=Entregado');
    activeOrdersCount = activeRes.meta?.pagination?.total || 0;

    // Completed Today
    const completedRes = await strapiGet(`/api/orden-de-trabajos?filters[estado][$eq]=Entregado&filters[updatedAt][$gte]=${today}`);
    completedTodayCount = completedRes.meta?.pagination?.total || 0;

    // Low Stock (assuming threshold 5)
    const lowStockRes = await strapiGet('/api/repuestos?filters[stock][$lte]=5');
    lowStockCount = lowStockRes.meta?.pagination?.total || 0;
    lowStockItems = lowStockRes.data || [];

    // Recent Activity
    const recentRes = await strapiGet('/api/orden-de-trabajos?sort[0]=updatedAt:desc&pagination[limit]=5&populate[0]=cliente&populate[1]=vehiculo&populate[2]=mecanico');
    recentOrders = recentRes.data || [];

  } catch (e) {
    console.error('Error fetching dashboard data:', e);
  }
} else {
  return Astro.redirect('/login');
}
---

<DashboardLayout title="Dashboard Encargado" role="encargado" currentPath={Astro.url.pathname}>
    <div class="max-w-7xl mx-auto">
        <!-- PageHeading -->
        <div class="flex flex-col gap-2 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Dashboard del Encargado</h1>
            <p class="text-gray-500 dark:text-gray-400">Bienvenido, aquí tienes un resumen de la actividad del taller.</p>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <Card class="hover:shadow-lg transition-shadow cursor-pointer border-l-4 border-l-primary-500">
                <div class="flex items-center justify-between mb-4">
                    <p class="text-gray-500 dark:text-gray-400 font-medium">Órdenes Activas</p>
                    <span class="material-symbols-outlined text-primary-500 bg-primary-50 dark:bg-primary-900/20 p-2 rounded-lg">build_circle</span>
                </div>
                <p class="text-4xl font-bold text-gray-900 dark:text-white mb-1">{activeOrdersCount}</p>
                <p class="text-sm text-green-600 dark:text-green-400 font-medium flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">trending_up</span> En proceso
                </p>
            </Card>

            <Card class="hover:shadow-lg transition-shadow cursor-pointer border-l-4 border-l-green-500">
                <div class="flex items-center justify-between mb-4">
                    <p class="text-gray-500 dark:text-gray-400 font-medium">Completadas Hoy</p>
                    <span class="material-symbols-outlined text-green-500 bg-green-50 dark:bg-green-900/20 p-2 rounded-lg">task_alt</span>
                </div>
                <p class="text-4xl font-bold text-gray-900 dark:text-white mb-1">{completedTodayCount}</p>
                <p class="text-sm text-green-600 dark:text-green-400 font-medium flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">check_circle</span> Entregadas
                </p>
            </Card>

            <Card class="hover:shadow-lg transition-shadow cursor-pointer border-l-4 border-l-red-500">
                <div class="flex items-center justify-between mb-4">
                    <p class="text-gray-500 dark:text-gray-400 font-medium">Stock Bajo Mínimo</p>
                    <span class="material-symbols-outlined text-red-500 bg-red-50 dark:bg-red-900/20 p-2 rounded-lg">inventory_2</span>
                </div>
                <p class="text-4xl font-bold text-gray-900 dark:text-white mb-1">{lowStockCount}</p>
                <p class="text-sm text-red-600 dark:text-red-400 font-medium flex items-center gap-1">
                    <span class="material-symbols-outlined text-sm">warning</span> Requiere atención
                </p>
            </Card>
        </div>

        <!-- Quick Actions -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Accesos Rápidos</h2>
            <div class="flex flex-wrap gap-4">
                <a href="/encargado/alert_stock">
                    <Button variant="secondary" icon="warning" class="bg-amber-100 text-amber-800 hover:bg-amber-200 dark:bg-amber-900/30 dark:text-amber-200 dark:hover:bg-amber-900/50 border-amber-200 dark:border-amber-800">Alertas Stock</Button>
                </a>
                <a href="/encargado/asig_orden">
                    <Button icon="add_circle">Asignar Orden</Button>
                </a>
                <a href="/encargado/disp_mec">
                    <Button variant="secondary" icon="group">Disponibilidad</Button>
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <!-- Recent Activity Table -->
            <div class="lg:col-span-3">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Actividad Reciente</h2>
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
                                <tr>
                                    <th class="px-6 py-3">ID</th>
                                    <th class="px-6 py-3">Cliente</th>
                                    <th class="px-6 py-3">Vehículo</th>
                                    <th class="px-6 py-3">Mecánico</th>
                                    <th class="px-6 py-3">Estado</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                {recentOrders.map((order: any) => (
                                    <tr class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">#{order.id}</td>
                                        <td class="px-6 py-4">{order.cliente ? `${order.cliente.nombre} ${order.cliente.apellido}` : 'N/A'}</td>
                                        <td class="px-6 py-4">{order.vehiculo ? `${order.vehiculo.marca} ${order.vehiculo.modelo}` : 'N/A'}</td>
                                        <td class="px-6 py-4">{order.mecanico ? order.mecanico.nombre : 'Sin asignar'}</td>
                                        <td class="px-6 py-4">
                                            <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                                order.estado === 'Entregado' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' :
                                                order.estado === 'Pendiente' ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' :
                                                'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300'
                                            }`}>
                                                {order.estado}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                                {recentOrders.length === 0 && (
                                    <tr>
                                        <td colspan="5" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">No hay actividad reciente.</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stock Alerts -->
            <div class="lg:col-span-2">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Alertas de Stock</h2>
                <Card>
                    <div class="space-y-6">
                        {lowStockItems.length > 0 ? lowStockItems.map((item: any) => (
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{item.nombre}</span>
                                    <span class="text-xs font-bold text-red-600 dark:text-red-400">{item.stock} unid.</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="bg-red-500 h-2 rounded-full transition-all duration-500" style={`width: ${Math.min(item.stock * 10, 100)}%`}></div>
                                </div>
                            </div>
                        )) : (
                            <div class="text-center py-8">
                                <span class="material-symbols-outlined text-green-500 text-4xl mb-2">check_circle</span>
                                <p class="text-gray-500 dark:text-gray-400">No hay alertas de stock bajo.</p>
                            </div>
                        )}
                    </div>
                    {lowStockItems.length > 0 && (
                        <div class="mt-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                            <a href="/encargado/alert_stock" class="text-sm text-primary-600 dark:text-primary-400 hover:underline flex items-center justify-center gap-1">
                                Ver todo el inventario <span class="material-symbols-outlined text-sm">arrow_forward</span>
                            </a>
                        </div>
                    )}
                </Card>
            </div>
        </div>
    </div>
</DashboardLayout>