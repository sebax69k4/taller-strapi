---
export const prerender = false;
import { strapiGet, strapiPut, strapiPost } from '../../lib/strapi';
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Badge from '../../components/ui/Badge.astro';
import EmptyState from '../../components/ui/EmptyState.astro';

const userRole = Astro.cookies.get('user_role')?.value as 'recepcionista' | 'encargado' | 'mecanico' | undefined;
if (!userRole) {
  return Astro.redirect('/login');
}

interface Repuesto {
  nombre: string;
  precio: number;
}

interface Presupuesto {
  monto_total: number;
}

interface Order {
  id: number;
  documentId: string;
  estado: string;
  cliente: { nombre: string; apellido: string };
  vehiculo: { marca: string; modelo: string };
  repuestos?: Repuesto[];
  presupuesto?: Presupuesto;
  factura?: any;
}

let completedOrders: Order[] = [];
let successMessage = '';
let errorMessage = '';

try {
  // Helper function to calculate totals
  const calculateOrderTotals = (order: any) => {
    let total = 0;
    let subtotal = 0;
    
    // Calculate from budget or parts
    if (order.presupuesto && order.presupuesto.monto_total) {
        total = order.presupuesto.monto_total;
        subtotal = Math.round(total / 1.19);
    } else {
        // Fallback calculation
        const partsTotal = order.repuestos?.reduce((sum: number, r: any) => sum + r.precio, 0) || 0;
        const labor = 75000; // Default labor cost
        subtotal = partsTotal + labor;
        total = Math.round(subtotal * 1.19);
    }
    const iva = total - subtotal;
    return { subtotal, iva, total };
  };

  // Handle POST request to mark as delivered
  if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    const orderId = formData.get('orderId');

    if (action === 'approveInvoice' && orderId) {
        try {
            // 1. Fetch order details to calculate totals AND validate status
            const orderRes = await strapiGet(`/api/orden-de-trabajos/${orderId}?populate=presupuesto&populate=repuestos`);
            const order = orderRes.data;
            
            if (!order) {
                throw new Error('Orden no encontrada');
            }

            // VALIDATION: Ensure order is in correct state
            if (order.estado !== 'finalizado') {
                throw new Error(`La orden no está en estado 'finalizado' (Estado actual: ${order.estado}). No se puede facturar.`);
            }
            
            const { subtotal, iva, total } = calculateOrderTotals(order);

            // 2. Check if Factura already exists
            const existingInvoiceRes = await strapiGet(`/api/facturas?filters[orden_de_trabajo][documentId][$eq]=${orderId}`);
            
            if (existingInvoiceRes.data && existingInvoiceRes.data.length === 0) {
                // Create only if it doesn't exist
                const invoiceNumber = `FACT-${Date.now()}-${orderId}`;
                
                await strapiPost('/api/facturas', {
                    numero_factura: invoiceNumber,
                    fecha_emision: new Date().toISOString().split('T')[0],
                    subtotal: subtotal,
                    iva: iva,
                    total: total,
                    orden_de_trabajo: orderId,
                    estado: 'pendiente'
                });
            }

            // 3. Update Order Status
            await strapiPut(`/api/orden-de-trabajos/${orderId}`, {
                estado: 'facturado'
            });
            successMessage = 'Factura aprobada y generada. La orden ha sido enviada a recepción.';
        } catch (err: any) {
            console.error('Error updating order:', err);
            errorMessage = 'Error al actualizar la orden: ' + (err.message || 'Error desconocido');
        }
    }
  }

  // Obtener órdenes finalizadas (pendientes de aprobación)
  const data = await strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=finalizado&populate[vehiculo][populate][cliente][fields][0]=nombre&populate[vehiculo][populate][cliente][fields][1]=apellido&populate[repuestos][fields][0]=nombre&populate[repuestos][fields][1]=precio&populate[presupuesto][fields][0]=monto_total&populate[factura][fields][0]=numero_factura&populate[factura][fields][1]=total&sort[0]=updatedAt:desc');
  
  // Mapear las órdenes y PRE-CALCULAR totales para el frontend
  completedOrders = (data.data || []).map((order: any) => {
    const totals = calculateOrderTotals(order);
    return {
        ...order,
        cliente: order.vehiculo?.cliente || { nombre: 'N/A', apellido: '' },
        vehiculo: order.vehiculo || { marca: 'N/A', modelo: '' },
        calculatedTotals: totals // Pass calculated totals to frontend
    };
  });
} catch (e) {
  console.error('Error fetching orders:', e);
}

const breadcrumbs = [
  { label: 'Dashboard', href: '/encargado/dash_enc' },
  { label: 'Facturación', href: '/encargado/gen_factura' },
];
---

<DashboardLayout 
    title="Aprobar Facturas" 
    role={userRole} 
    currentPath="/encargado/gen_factura"
    breadcrumbs={breadcrumbs}
>
    <div class="max-w-4xl mx-auto">
        <div class="mb-8 print:hidden">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Aprobar Facturas</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Órdenes finalizadas por mecánicos con factura generada, pendientes de aprobación para enviar a recepción.</p>
        </div>
        
        {successMessage && (
            <div class="p-4 mb-6 text-sm text-green-700 bg-green-100 rounded-lg dark:bg-green-900/30 dark:text-green-300 print:hidden flex items-center gap-2" role="alert">
                <span class="material-symbols-outlined">check_circle</span>
                {successMessage}
            </div>
        )}
        {errorMessage && (
            <div class="p-4 mb-6 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-900/30 dark:text-red-300 print:hidden flex items-center gap-2" role="alert">
                <span class="material-symbols-outlined">error</span>
                {errorMessage}
            </div>
        )}
        
        <div class="grid gap-6 print:hidden">
            {completedOrders.map((order: Order) => (
                <Card class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex items-start gap-4">
                        <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-blue-600 dark:text-blue-400">
                            <span class="material-symbols-outlined text-2xl">receipt_long</span>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-lg text-gray-900 dark:text-white">Orden #{order.documentId.slice(0, 6)}</h3>
                                <Badge variant="info">Finalizado</Badge>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 font-medium">{order.cliente.nombre} {order.cliente.apellido}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-500">{order.vehiculo.marca} {order.vehiculo.modelo}</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-end gap-3 w-full sm:w-auto">
                        <div class="flex flex-col text-right text-sm text-gray-500 dark:text-gray-400 mb-1">
                            {order.factura ? (
                                <span class="text-green-600 dark:text-green-400 font-medium flex items-center justify-end gap-1">
                                    <span class="material-symbols-outlined text-sm">check</span>
                                    Factura: {order.factura.numero_factura}
                                </span>
                            ) : (
                                <span class="text-amber-600 dark:text-amber-400 flex items-center justify-end gap-1">
                                    <span class="material-symbols-outlined text-sm">pending</span>
                                    Sin factura generada
                                </span>
                            )}
                            {order.factura && <span class="text-lg font-bold text-gray-900 dark:text-white mt-1">${order.factura.total?.toLocaleString('es-CL')}</span>}
                        </div>
                        
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <Button 
                                variant="outline" 
                                size="sm"
                                onclick={`window.printInvoice('${order.documentId}')`}
                                icon="print"
                            >
                                Imprimir
                            </Button>
                            
                            <form method="POST" onsubmit="return confirm('¿Aprobar factura y enviar a recepción para entrega?');" class="w-full sm:w-auto">
                                <input type="hidden" name="orderId" value={order.documentId} />
                                <input type="hidden" name="action" value="approveInvoice" />
                                <Button 
                                    type="submit" 
                                    variant="primary" 
                                    size="sm"
                                    icon="verified"
                                    class="w-full sm:w-auto"
                                >
                                    Aprobar
                                </Button>
                            </form>
                        </div>
                    </div>
                </Card>
            ))}
            
            {completedOrders.length === 0 && (
                <EmptyState 
                    title="No hay facturas pendientes" 
                    description="Las facturas aparecerán aquí cuando los mecánicos finalicen sus órdenes."
                    icon="task_alt"
                />
            )}
        </div>

        <!-- Invoice Template (Hidden by default, shown when printing) -->
        <div id="invoice-template" class="hidden print:block bg-white p-8 text-black">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900">FACTURA</h1>
                    <p class="text-gray-600 mt-2">Taller Veloz S.A.</p>
                    <p class="text-gray-600">Av. Principal 123</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-xl" id="inv-id">FACT-XXXX</p>
                    <p class="text-gray-600" id="inv-date">Fecha: DD/MM/YYYY</p>
                </div>
            </div>
            
            <div class="border-t border-b border-gray-200 py-4 mb-8">
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-bold text-gray-900 mb-2">Cliente</h3>
                        <p class="text-gray-600" id="inv-customer">Nombre Cliente</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-900 mb-2">Vehículo</h3>
                        <p class="text-gray-600" id="inv-vehicle">Marca Modelo</p>
                    </div>
                </div>
            </div>

            <table class="w-full mb-8">
                <thead>
                    <tr class="border-b-2 border-gray-900">
                        <th class="text-left py-2">Descripción</th>
                        <th class="text-right py-2">Precio</th>
                    </tr>
                </thead>
                <tbody id="inv-items">
                    <!-- Items injected via JS -->
                </tbody>
                <tfoot>
                    <tr class="border-t-2 border-gray-900 font-bold text-xl">
                        <td class="pt-4 text-right">Total:</td>
                        <td class="pt-4 text-right" id="inv-total">$0</td>
                    </tr>
                </tfoot>
            </table>
            
            <div class="text-center text-gray-500 text-sm mt-12">
                <p>Gracias por su preferencia.</p>
            </div>
        </div>
    </div>
</DashboardLayout>

<script define:vars={{ completedOrders }}>
    window.printInvoice = (orderId) => {
        const order = completedOrders.find(o => o.documentId === orderId);
        if (!order) return;

        // Populate invoice
        document.getElementById('inv-id').textContent = `FACT-${order.documentId.slice(0, 6).toUpperCase()}`;
        document.getElementById('inv-date').textContent = new Date().toLocaleDateString();
        document.getElementById('inv-customer').textContent = `${order.cliente.nombre} ${order.cliente.apellido}`;
        document.getElementById('inv-vehicle').textContent = `${order.vehiculo.marca} ${order.vehiculo.modelo}`;
        
        // Generate items
        const items = [];
        
        // Add parts
        if (order.repuestos && order.repuestos.length > 0) {
            order.repuestos.forEach(part => {
                items.push({ desc: `Repuesto: ${part.nombre}`, price: part.precio });
            });
        }

        // Add labor/budget
        // Use the server-calculated total to derive the labor cost displayed
        // Total = (Parts + Labor) * 1.19
        // So Subtotal = Total / 1.19
        // Labor = Subtotal - Parts
        
        const total = order.calculatedTotals.total;
        const subtotal = order.calculatedTotals.subtotal;
        const partsTotal = items.reduce((sum, item) => sum + item.price, 0);
        
        const labor = subtotal - partsTotal;
        
        if (labor > 0) {
            items.push({ desc: 'Mano de Obra / Servicios', price: labor });
        }
        
        const tbody = document.getElementById('inv-items');
        tbody.innerHTML = items.map(item => `
            <tr class="border-b border-gray-200">
                <td class="py-2">${item.desc}</td>
                <td class="py-2 text-right">$${item.price.toLocaleString('es-CL')}</td>
            </tr>
        `).join('');
        
        // Add IVA and Total rows
        const tfoot = document.querySelector('table tfoot');
        tfoot.innerHTML = `
            <tr class="border-t border-gray-300">
                <td class="pt-4 text-right font-medium">Subtotal:</td>
                <td class="pt-4 text-right">$${subtotal.toLocaleString('es-CL')}</td>
            </tr>
            <tr>
                <td class="pt-1 text-right font-medium">IVA (19%):</td>
                <td class="pt-1 text-right">$${order.calculatedTotals.iva.toLocaleString('es-CL')}</td>
            </tr>
            <tr class="border-t-2 border-gray-900 font-bold text-xl">
                <td class="pt-2 text-right">Total:</td>
                <td class="pt-2 text-right">$${total.toLocaleString('es-CL')}</td>
            </tr>
        `;

        window.print();
    };
</script>
