---
export const prerender = false;
import { strapiGet, strapiPut, strapiPost } from '../../lib/strapi';
import DashboardLayout from '../../layouts/DashboardLayout.astro';

const userRole = Astro.cookies.get('user_role')?.value as 'recepcionista' | 'encargado' | 'mecanico' | undefined;
if (!userRole) {
  return Astro.redirect('/login');
}

interface Repuesto {
  nombre: string;
  precio: number;
}

interface Presupuesto {
  monto_total: number;
}

interface Order {
  id: number;
  documentId: string;
  estado: string;
  cliente: { nombre: string; apellido: string };
  vehiculo: { marca: string; modelo: string };
  repuestos?: Repuesto[];
  presupuesto?: Presupuesto;
  factura?: any;
}

let completedOrders: Order[] = [];
let successMessage = '';
let errorMessage = '';

try {
  // Handle POST request to mark as delivered
  if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    const orderId = formData.get('orderId');

    if (action === 'approveInvoice' && orderId) {
        try {
            // 1. Fetch order details to calculate totals
            const orderRes = await strapiGet(`/api/orden-de-trabajos/${orderId}?populate=presupuesto&populate=repuestos`);
            const order = orderRes.data;
            
            let total = 0;
            let subtotal = 0;
            
            // Calculate from budget or parts
            if (order.presupuesto && order.presupuesto.monto_total) {
                total = order.presupuesto.monto_total;
                subtotal = Math.round(total / 1.19);
            } else {
                // Fallback calculation
                const partsTotal = order.repuestos?.reduce((sum: number, r: any) => sum + r.precio, 0) || 0;
                const labor = 75000;
                subtotal = partsTotal + labor;
                total = Math.round(subtotal * 1.19);
            }
            const iva = total - subtotal;

            // 2. Check if Factura already exists
            const existingInvoiceRes = await strapiGet(`/api/facturas?filters[orden_de_trabajo][documentId][$eq]=${orderId}`);
            
            if (existingInvoiceRes.data && existingInvoiceRes.data.length === 0) {
                // Create only if it doesn't exist
                const invoiceNumber = `FACT-${Date.now()}-${orderId}`;
                
                await strapiPost('/api/facturas', {
                    numero_factura: invoiceNumber,
                    fecha_emision: new Date().toISOString().split('T')[0],
                    subtotal: subtotal,
                    iva: iva,
                    total: total,
                    orden_de_trabajo: orderId,
                    estado: 'pendiente'
                });
            }

            // 3. Update Order Status
            await strapiPut(`/api/orden-de-trabajos/${orderId}`, {
                estado: 'facturado'
            });
            successMessage = 'Factura aprobada y generada. La orden ha sido enviada a recepción.';
        } catch (err: any) {
            console.error('Error updating order:', err);
            errorMessage = 'Error al actualizar la orden: ' + (err.message || 'Error desconocido');
        }
    }
  }

  // Obtener órdenes finalizadas (pendientes de aprobación)
  const data = await strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=finalizado&populate[vehiculo][populate][cliente][fields][0]=nombre&populate[vehiculo][populate][cliente][fields][1]=apellido&populate[repuestos][fields][0]=nombre&populate[repuestos][fields][1]=precio&populate[presupuesto][fields][0]=monto_total&populate[factura][fields][0]=numero_factura&populate[factura][fields][1]=total&sort[0]=updatedAt:desc');
  // Mapear las órdenes para tener cliente accesible directamente
  completedOrders = (data.data || []).map((order: any) => ({
    ...order,
    cliente: order.vehiculo?.cliente || { nombre: 'N/A', apellido: '' },
    vehiculo: order.vehiculo || { marca: 'N/A', modelo: '' }
  }));
} catch (e) {
  console.error('Error fetching orders:', e);
}
---

<DashboardLayout title="Aprobar Facturas" role={userRole} currentPath="/encargado/gen_factura">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-6 print:hidden">Aprobar Facturas</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-6 print:hidden">Órdenes finalizadas por mecánicos con factura generada, pendientes de aprobación para enviar a recepción.</p>
        
        {successMessage && <div class="p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg dark:bg-green-200 dark:text-green-800 print:hidden" role="alert">{successMessage}</div>}
        {errorMessage && <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-200 dark:text-red-800 print:hidden" role="alert">{errorMessage}</div>}
        
        <div class="grid gap-6 print:hidden">
            {completedOrders.map((order: Order) => (
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">Orden #{order.documentId.slice(0, 6)}</h3>
                        <p class="text-gray-600 dark:text-gray-400">{order.cliente.nombre} {order.cliente.apellido} - {order.vehiculo.marca}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col text-right text-sm text-gray-500 dark:text-gray-400">
                            {order.factura ? (
                                <span class="text-green-600 dark:text-green-400 font-medium">Factura: {order.factura.numero_factura}</span>
                            ) : (
                                <span class="text-yellow-600 dark:text-yellow-400">Sin factura generada</span>
                            )}
                            {order.factura && <span>Total: ${order.factura.total?.toLocaleString('es-CL')}</span>}
                        </div>
                        <button onclick={`window.printInvoice('${order.documentId}')`} class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">print</span>
                            Imprimir
                        </button>
                        <form method="POST" onsubmit="return confirm('¿Aprobar factura y enviar a recepción para entrega?');">
                            <input type="hidden" name="orderId" value={order.documentId} />
                            <input type="hidden" name="action" value="approveInvoice" />
                            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">verified</span>
                                Aprobar y Enviar
                            </button>
                        </form>
                    </div>
                </div>
            ))}
            {completedOrders.length === 0 && (
                <div class="text-center py-12">
                    <span class="material-symbols-outlined text-5xl text-gray-300 dark:text-gray-600 mb-4">task_alt</span>
                    <p class="text-gray-500 dark:text-gray-400">No hay facturas pendientes de aprobación.</p>
                    <p class="text-gray-400 dark:text-gray-500 text-sm mt-2">Las facturas aparecen aquí cuando los mecánicos finalizan sus órdenes.</p>
                </div>
            )}
        </div>

        <!-- Invoice Template (Hidden by default, shown when printing) -->
        <div id="invoice-template" class="hidden print:block bg-white p-8 text-black">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900">FACTURA</h1>
                    <p class="text-gray-600 mt-2">Taller Veloz S.A.</p>
                    <p class="text-gray-600">Av. Principal 123</p>
                </div>
                <div class="text-right">
                    <p class="font-bold text-xl" id="inv-id">FACT-XXXX</p>
                    <p class="text-gray-600" id="inv-date">Fecha: DD/MM/YYYY</p>
                </div>
            </div>
            
            <div class="border-t border-b border-gray-200 py-4 mb-8">
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-bold text-gray-900 mb-2">Cliente</h3>
                        <p class="text-gray-600" id="inv-customer">Nombre Cliente</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-900 mb-2">Vehículo</h3>
                        <p class="text-gray-600" id="inv-vehicle">Marca Modelo</p>
                    </div>
                </div>
            </div>

            <table class="w-full mb-8">
                <thead>
                    <tr class="border-b-2 border-gray-900">
                        <th class="text-left py-2">Descripción</th>
                        <th class="text-right py-2">Precio</th>
                    </tr>
                </thead>
                <tbody id="inv-items">
                    <!-- Items injected via JS -->
                </tbody>
                <tfoot>
                    <tr class="border-t-2 border-gray-900 font-bold text-xl">
                        <td class="pt-4 text-right">Total:</td>
                        <td class="pt-4 text-right" id="inv-total">$0</td>
                    </tr>
                </tfoot>
            </table>
            
            <div class="text-center text-gray-500 text-sm mt-12">
                <p>Gracias por su preferencia.</p>
            </div>
        </div>
    </div>
</DashboardLayout>

<script define:vars={{ completedOrders }}>
    window.printInvoice = (orderId) => {
        const order = completedOrders.find(o => o.documentId === orderId);
        if (!order) return;

        // Populate invoice
        document.getElementById('inv-id').textContent = `FACT-${order.documentId.slice(0, 6).toUpperCase()}`;
        document.getElementById('inv-date').textContent = new Date().toLocaleDateString();
        document.getElementById('inv-customer').textContent = `${order.cliente.nombre} ${order.cliente.apellido}`;
        document.getElementById('inv-vehicle').textContent = `${order.vehiculo.marca} ${order.vehiculo.modelo}`;
        
        // Generate items
        const items = [];
        let total = 0;

        // Add parts
        if (order.repuestos && order.repuestos.length > 0) {
            order.repuestos.forEach(part => {
                items.push({ desc: `Repuesto: ${part.nombre}`, price: part.precio });
                total += part.precio;
            });
        }

        // Add labor/budget
        if (order.presupuesto && order.presupuesto.monto_total) {
            // If budget exists, we can either use it as the total or calculate labor from it
            // For simplicity, let's assume budget total includes everything, so we might need to adjust logic
            // Or we treat budget as "Mano de Obra" + "Repuestos".
            // Let's calculate labor as Total - Parts
            const partsTotal = items.reduce((sum, item) => sum + item.price, 0);
            const labor = order.presupuesto.monto_total - partsTotal;
            if (labor > 0) {
                items.push({ desc: 'Mano de Obra / Servicios', price: labor });
                total += labor;
            }
        } else {
            // Fallback labor cost if no budget
             items.push({ desc: 'Mano de Obra (Estimado)', price: 75000 });
             total += 75000;
        }
        
        const tbody = document.getElementById('inv-items');
        tbody.innerHTML = items.map(item => `
            <tr class="border-b border-gray-200">
                <td class="py-2">${item.desc}</td>
                <td class="py-2 text-right">$${item.price.toLocaleString('es-CL')}</td>
            </tr>
        `).join('');
        
        document.getElementById('inv-total').textContent = `$${total.toLocaleString('es-CL')}`;

        window.print();
    };
</script>
