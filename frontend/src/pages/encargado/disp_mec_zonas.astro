---
export const prerender = false;
import { strapiGet } from '../../lib/strapi';
import '../../styles/global.css';
import DashboardLayout from '../../layouts/DashboardLayout.astro';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

let mechanics = [];
let zones = [];

try {
  // Fetch Mechanics with today's orders
  const mecData = await strapiGet('/api/mecenicos?populate[orden_de_trabajos][populate][0]=vehiculo&populate[orden_de_trabajos][filters][estado][$ne]=Entregado');
  mechanics = mecData.data || [];

  // Fetch Zones with today's orders
  const zoneData = await strapiGet('/api/zonas?populate[orden_de_trabajos][filters][estado][$ne]=Entregado&populate[orden_de_trabajos][populate][0]=vehiculo');
  zones = zoneData.data || [];

} catch (e) {
  console.error('Error fetching data:', e);
}

const today = new Date();
today.setHours(0, 0, 0, 0);
const tomorrow = new Date(today);
tomorrow.setDate(today.getDate() + 1);

const getTodayOrders = (orders: any[]) => {
    if (!orders) return [];
    return orders.filter(order => {
        const startDate = order.fecha_inicio_planificada ? new Date(order.fecha_inicio_planificada) : null;
        return startDate && startDate >= today && startDate < tomorrow;
    }).sort((a, b) => new Date(a.fecha_inicio_planificada).getTime() - new Date(b.fecha_inicio_planificada).getTime());
};

const calculateTimelineStyle = (order: any) => {
    const dayStart = today.getTime();
    const dayEnd = tomorrow.getTime();
    const totalDayMinutes = 24 * 60;

    const start = new Date(order.fecha_inicio_planificada).getTime();
    const end = new Date(order.fecha_fin_planificada).getTime();

    const startOffsetMinutes = (start - dayStart) / (1000 * 60);
    const durationMinutes = Math.max((end - start) / (1000 * 60), 30); // Min 30 minutes

    const left = (startOffsetMinutes / totalDayMinutes) * 100;
    const width = (durationMinutes / totalDayMinutes) * 100;

    return `left: ${Math.max(0, left)}%; width: ${Math.min(100 - Math.max(0, left), width)}%;`;
};

const formatTime = (dateString: string) => {
    if (!dateString) return '';
    return new Date(dateString).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
};

const hours = Array.from({ length: 17 }, (_, i) => i + 7); // 7 AM to 11 PM
---

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script define:vars={{ mechanics, zones }}>
    document.addEventListener('alpine:init', () => {
        Alpine.data('dispMecZonas', () => ({
            searchQuery: '',
            mechanics: mechanics,
            zones: zones,
            get filteredMechanics() {
                if (!this.searchQuery) return this.mechanics;
                const query = this.searchQuery.toLowerCase();
                return this.mechanics.filter(m => 
                    m.nombre.toLowerCase().includes(query) ||
                    m.apellido.toLowerCase().includes(query) ||
                    (m.especialidad && m.especialidad.toLowerCase().includes(query))
                );
            },
            get filteredZones() {
                if (!this.searchQuery) return this.zones;
                const query = this.searchQuery.toLowerCase();
                return this.zones.filter(z => z.nombre.toLowerCase().includes(query));
            }
        }));
    });
</script>

<DashboardLayout title="Disponibilidad de Mecánicos y Zonas" role="encargado" currentPath="/encargado/disp_mec_zonas">
    <div class="w-full max-w-7xl mx-auto" x-data="dispMecZonas">
        <!-- PageHeading -->
        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
            <div class="flex flex-col">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Disponibilidad del Taller</h1>
                <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">Visualiza la carga de trabajo y el estado de los recursos en tiempo real.</p>
            </div>
            <a href="/encargado/asig_orden" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 gap-2">
                <span class="material-symbols-outlined text-lg">add</span>
                Asignar Tarea
            </a>
        </div>

        <!-- ToolBar & SegmentedButtons -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 mb-6 shadow-sm">
            <div class="flex items-center gap-2 w-full md:w-auto">
                <div class="relative w-full md:w-auto">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                    <input x-model="searchQuery" class="pl-10 pr-4 py-2 h-10 w-full md:w-64 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 focus:outline-none text-sm text-gray-900 dark:text-white" placeholder="Buscar mecánico o zona..." type="text"/>
                </div>
                <button class="p-2 h-10 w-10 flex items-center justify-center text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <span class="material-symbols-outlined">filter_list</span>
                </button>
            </div>
        </div>

        <!-- Timeline View for Mechanics -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden mb-8 shadow-sm">
            <!-- Header -->
            <div class="grid grid-cols-[200px_1fr] border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <div class="p-4 border-r border-gray-200 dark:border-gray-700">
                    <h2 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wider">Mecánicos</h2>
                </div>
                <div class="flex overflow-x-auto hide-scrollbar">
                    {hours.map(hour => (
                        <div class="flex-shrink-0 text-center p-2 border-r border-gray-200 dark:border-gray-700 last:border-r-0" style="width: 60px;">
                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400">{hour.toString().padStart(2, '0')}:00</p>
                        </div>
                    ))}
                </div>
            </div>

            <!-- Mechanic Rows -->
            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                {mechanics.map((mec: any) => {
                    const todayOrders = getTodayOrders(mec.orden_de_trabajos);
                    return (
                        <div class="grid grid-cols-[200px_1fr]" x-show="!searchQuery || (
                            '${mec.nombre}'.toLowerCase().includes(searchQuery.toLowerCase()) || 
                            '${mec.apellido}'.toLowerCase().includes(searchQuery.toLowerCase()) ||
                            ('${mec.especialidad}' || '').toLowerCase().includes(searchQuery.toLowerCase())
                        )">
                            <!-- Mechanic Info -->
                            <div class="p-4 border-r border-gray-200 dark:border-gray-700 flex flex-col justify-center bg-white dark:bg-gray-800">
                                <h3 class="font-bold text-gray-900 dark:text-white text-sm">{mec.nombre} {mec.apellido}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{mec.especialidad || 'Mecánico General'}</p>
                            </div>
                            <!-- Timeline -->
                            <div class="relative h-20 bg-gray-50 dark:bg-gray-900/30 flex overflow-x-auto hide-scrollbar">
                                {/* Grid lines */}
                                <div class="flex absolute inset-0 pointer-events-none">
                                    {hours.map(hour => (
                                        <div class="flex-shrink-0 border-r border-gray-200 dark:border-gray-700/50" style="width: 60px;"></div>
                                    ))}
                                </div>
                                <!-- Scheduled Orders -->
                                <div class="relative w-full h-full">
                                    {todayOrders.map(order => (
                                        <div class="absolute top-4 h-12 bg-blue-600/90 hover:bg-blue-600 rounded-md p-2 text-white flex flex-col justify-center overflow-hidden border border-blue-700/50 text-xs shadow-sm transition-colors z-10 cursor-pointer" style={calculateTimelineStyle(order)} title={`${order.vehiculo?.marca} ${order.vehiculo?.modelo} - ${order.descripcion}`}>
                                            <p class="font-bold truncate">OT-{order.documentId.slice(0, 4)}</p>
                                            <p class="truncate opacity-90">{order.vehiculo?.marca} {order.vehiculo?.modelo}</p>
                                        </div>
                                    ))}
                                    {todayOrders.length === 0 && (
                                        <div class="flex items-center justify-center w-full h-full text-gray-400 text-xs italic">
                                            Disponible
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                })}
                {mechanics.length === 0 && (
                    <div class="text-center py-12 text-gray-500 col-span-full">
                        <span class="material-symbols-outlined text-4xl mb-2 opacity-50">person_off</span>
                        <p>No se encontraron mecánicos.</p>
                    </div>
                )}
            </div>
        </div>

        <!-- Timeline View for Zones -->
        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
            <!-- Header -->
            <div class="grid grid-cols-[200px_1fr] border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <div class="p-4 border-r border-gray-200 dark:border-gray-700">
                    <h2 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wider">Zonas del Taller</h2>
                </div>
                <div class="flex overflow-x-auto hide-scrollbar">
                    {hours.map(hour => (
                        <div class="flex-shrink-0 text-center p-2 border-r border-gray-200 dark:border-gray-700 last:border-r-0" style="width: 60px;">
                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400">{hour.toString().padStart(2, '0')}:00</p>
                        </div>
                    ))}
                </div>
            </div>

            <!-- Zone Rows -->
            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                {zones.map((zone: any) => {
                    const todayOrders = getTodayOrders(zone.orden_de_trabajos);
                    return (
                        <div class="grid grid-cols-[200px_1fr]" x-show="!searchQuery || '${zone.nombre}'.toLowerCase().includes(searchQuery.toLowerCase())">
                            <!-- Zone Info -->
                            <div class="p-4 border-r border-gray-200 dark:border-gray-700 flex flex-col justify-center bg-white dark:bg-gray-800">
                                <h3 class="font-bold text-gray-900 dark:text-white text-sm">{zone.nombre}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{todayOrders.length} órdenes hoy</p>
                            </div>
                            <!-- Timeline -->
                            <div class="relative h-20 bg-gray-50 dark:bg-gray-900/30 flex overflow-x-auto hide-scrollbar">
                                {/* Grid lines */}
                                <div class="flex absolute inset-0 pointer-events-none">
                                    {hours.map(hour => (
                                        <div class="flex-shrink-0 border-r border-gray-200 dark:border-gray-700/50" style="width: 60px;"></div>
                                    ))}
                                </div>
                                <!-- Scheduled Orders -->
                                <div class="relative w-full h-full">
                                    {todayOrders.map((order, idx) => {
                                        const colors = ['bg-orange-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500'];
                                        const bgColor = colors[idx % colors.length];
                                        return (
                                            <div class={`absolute top-4 h-12 ${bgColor}/90 hover:${bgColor} rounded-md p-2 text-white flex flex-col justify-center overflow-hidden border border-white/10 text-xs shadow-sm transition-colors z-10 cursor-pointer`} style={calculateTimelineStyle(order)} title={`${order.vehiculo?.marca} ${order.vehiculo?.modelo} - ${order.descripcion}`}>
                                                <p class="font-bold truncate">OT-{order.documentId.slice(0, 4)}</p>
                                                <p class="truncate opacity-90">{order.vehiculo?.marca} {order.vehiculo?.modelo}</p>
                                            </div>
                                        );
                                    })}
                                    {todayOrders.length === 0 && (
                                        <div class="flex items-center justify-center w-full h-full text-gray-400 text-xs italic">
                                            Disponible
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                })}
                {zones.length === 0 && (
                    <div class="text-center py-12 text-gray-500 col-span-full">
                        <span class="material-symbols-outlined text-4xl mb-2 opacity-50">no_meeting_room</span>
                        <p>No se encontraron zonas.</p>
                    </div>
                )}
            </div>
        </div>
    </div>
</DashboardLayout>