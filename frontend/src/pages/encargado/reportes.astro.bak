---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import { strapiGet } from '../../lib/strapi';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole || userRole !== 'encargado') return Astro.redirect('/login');

// Handle Export Actions
if (Astro.request.method === 'POST') {
    try {
        const formData = await Astro.request.formData();
        const reportType = formData.get('type');
        
        let data = [];
        let filename = '';
        let headers = [];

        if (reportType === 'ventas') {
            const res = await strapiGet('/api/facturas?populate=*&pagination[limit]=-1');
            data = res.data.map((f: any) => ({
                id: f.id,
                fecha: f.fecha_emision,
                cliente: f.orden_de_trabajo?.vehiculo?.cliente?.nombre || 'N/A',
                monto: f.monto_total,
                metodo: f.metodo_pago,
                estado: f.estado
            }));
            headers = ['ID', 'Fecha', 'Cliente', 'Monto', 'Método', 'Estado'];
            filename = `reporte-ventas-${new Date().toISOString().split('T')[0]}.csv`;
        } else if (reportType === 'inventario') {
            const res = await strapiGet('/api/repuestos?pagination[limit]=-1');
            data = res.data.map((r: any) => ({
                nombre: r.nombre,
                sku: r.sku,
                stock: r.stock,
                precio: r.precio,
                ubicacion: r.ubicacion
            }));
            headers = ['Nombre', 'SKU', 'Stock', 'Precio', 'Ubicación'];
            filename = `reporte-inventario-${new Date().toISOString().split('T')[0]}.csv`;
        }

        // Convert to CSV
        const csvContent = [
            headers.join(','),
            ...data.map((row: any) => Object.values(row).map(v => `"${v}"`).join(','))
        ].join('\n');

        return new Response(csvContent, {
            status: 200,
            headers: {
                'Content-Type': 'text/csv',
                'Content-Disposition': `attachment; filename="${filename}"`
            }
        });

    } catch (e) {
        console.error('Error generating report:', e);
    }
}
---

<DashboardLayout title="Reportes" role="encargado" currentPath="/encargado/reportes">
    <div class="max-w-7xl mx-auto">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Reportes y Exportación</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-1">Descarga datos del sistema en formato CSV</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Ventas -->
            <Card>
                <div class="flex flex-col h-full">
                    <div class="w-12 h-12 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center mb-4">
                        <span class="material-symbols-outlined text-2xl">payments</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Reporte de Ventas</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 flex-1">
                        Exporta el historial completo de facturas emitidas, incluyendo montos y métodos de pago.
                    </p>
                    <form method="POST">
                        <input type="hidden" name="type" value="ventas" />
                        <Button type="submit" variant="outline" class="w-full" icon="download">
                            Descargar CSV
                        </Button>
                    </form>
                </div>
            </Card>

            <!-- Inventario -->
            <Card>
                <div class="flex flex-col h-full">
                    <div class="w-12 h-12 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center mb-4">
                        <span class="material-symbols-outlined text-2xl">inventory_2</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Inventario Actual</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 flex-1">
                        Descarga la lista completa de repuestos con sus niveles de stock y precios actuales.
                    </p>
                    <form method="POST">
                        <input type="hidden" name="type" value="inventario" />
                        <Button type="submit" variant="outline" class="w-full" icon="download">
                            Descargar CSV
                        </Button>
                    </form>
                </div>
            </Card>

            <!-- Mecánicos (Placeholder) -->
            <Card>
                <div class="flex flex-col h-full opacity-60">
                    <div class="w-12 h-12 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 flex items-center justify-center mb-4">
                        <span class="material-symbols-outlined text-2xl">engineering</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Productividad (Pronto)</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 flex-1">
                        Próximamente: Reporte detallado de horas trabajadas por cada mecánico.
                    </p>
                    <Button type="button" variant="secondary" class="w-full" disabled>
                        No disponible
                    </Button>
                </div>
            </Card>
        </div>
    </div>
</DashboardLayout>
