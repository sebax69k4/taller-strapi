---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import { strapiGet, strapiPut } from '../../lib/strapi';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
const token = Astro.cookies.get('token')?.value;

if (!userRole) {
  return Astro.redirect('/login');
}

interface SolicitudRepuesto {
  id: number;
  documentId: string;
  repuesto: {
    id: number;
    documentId: string;
    nombre: string;
    stock: number;
    sku: string;
  };
  cantidad: number;
  urgencia: string;
  estado: string;
  orden_de_trabajo: {
    id: number;
    documentId: string;
    vehiculo: {
      marca: string;
      modelo: string;
      patente: string;
    };
    mecanico: {
      nombre: string;
      apellido: string;
    };
  };
  createdAt: string;
  observaciones?: string;
}

interface Repuesto {
  id: number;
  documentId: string;
  nombre: string;
  stock: number;
  sku: string;
  precio_venta: number;
}

let solicitudes: SolicitudRepuesto[] = [];
let message = '';
let messageType = '';
let error = '';

// Obtener mensaje de URL
const urlMessage = Astro.url.searchParams.get('message');
const urlType = Astro.url.searchParams.get('type');
if (urlMessage) {
  message = urlMessage;
  messageType = urlType || 'success';
}

const filtroEstado = Astro.url.searchParams.get('estado') || 'pendiente';

try {
  // Obtener solicitudes de repuesto
  let endpoint = '/api/solicitud-de-repuestos?populate[repuesto][fields][0]=nombre&populate[repuesto][fields][1]=stock&populate[repuesto][fields][2]=sku&populate[orden_de_trabajo][populate][vehiculo][fields][0]=marca&populate[orden_de_trabajo][populate][vehiculo][fields][1]=modelo&populate[orden_de_trabajo][populate][vehiculo][fields][2]=patente&populate[orden_de_trabajo][populate][mecanico][fields][0]=nombre&populate[orden_de_trabajo][populate][mecanico][fields][1]=apellido&sort=createdAt:desc';
  
  if (filtroEstado !== 'todas') {
    endpoint += `&filters[estado][$eq]=${filtroEstado}`;
  }
  
  const response = await strapiGet(endpoint);
  solicitudes = response.data || [];

  // Manejar POST para aprobar/rechazar
  if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    const solicitudId = formData.get('solicitudId');
    const repuestoId = formData.get('repuestoId');
    const cantidad = parseInt(formData.get('cantidad') as string || '0');
    const stockActual = parseInt(formData.get('stockActual') as string || '0');

    if (action === 'aprobar') {
      // Verificar stock
      if (stockActual < cantidad) {
        return Astro.redirect(`/encargado/aprobar_solicitudes?message=${encodeURIComponent('Stock insuficiente para aprobar esta solicitud.')}&type=error`);
      }

      // Actualizar estado de solicitud
      await strapiPut(`/api/solicitud-de-repuestos/${solicitudId}`, {
        estado: 'aprobado'
      });

      // Descontar stock del repuesto
      await strapiPut(`/api/repuestos/${repuestoId}`, {
        stock: stockActual - cantidad
      });

      return Astro.redirect(`/encargado/aprobar_solicitudes?message=${encodeURIComponent('Solicitud aprobada y stock actualizado.')}&type=success`);
    } else if (action === 'rechazar') {
      const motivoRechazo = formData.get('motivo_rechazo') || 'Sin especificar';
      
      await strapiPut(`/api/solicitud-de-repuestos/${solicitudId}`, {
        estado: 'rechazado',
        observaciones: `Rechazado: ${motivoRechazo}`
      });

      return Astro.redirect(`/encargado/aprobar_solicitudes?message=${encodeURIComponent('Solicitud rechazada.')}&type=warning`);
    }
  }

} catch (e: any) {
  console.error('Error:', e);
  // Si no existe el content-type, mostrar un mensaje apropiado
  if (e.message?.includes('404') || e.message?.includes('not found')) {
    error = 'El módulo de solicitudes de repuesto no está configurado en el sistema.';
  } else {
    error = 'Error al cargar solicitudes';
  }
}

const urgenciaClases: Record<string, string> = {
  'alta': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
  'media': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300',
  'baja': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
};

const estadoClases: Record<string, string> = {
  'pendiente': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300',
  'aprobado': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
  'rechazado': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
};

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('es-CL', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}
---

<DashboardLayout title="Aprobar Solicitudes de Repuesto" role="encargado" currentPath="/encargado/aprobar_solicitudes">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Solicitudes de Repuesto</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-2">Revisa y aprueba las solicitudes de repuesto de los mecánicos.</p>
      </div>
    </div>

    {message && (
      <div class={`p-4 mb-6 rounded-lg border flex items-center gap-3 ${messageType === 'success' ? 'bg-green-50 border-green-200 text-green-800 dark:bg-green-900/30 dark:border-green-800 dark:text-green-300' : messageType === 'warning' ? 'bg-amber-50 border-amber-200 text-amber-800 dark:bg-amber-900/30 dark:border-amber-800 dark:text-amber-300' : 'bg-red-50 border-red-200 text-red-800 dark:bg-red-900/30 dark:border-red-800 dark:text-red-300'}`}>
        <span class="material-symbols-outlined">{messageType === 'success' ? 'check_circle' : messageType === 'warning' ? 'warning' : 'error'}</span>
        <p>{message}</p>
      </div>
    )}

    {error && (
      <Card>
        <div class="text-center py-12">
          <span class="material-symbols-outlined text-5xl text-amber-400 mb-4">info</span>
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Módulo no configurado</h3>
          <p class="text-gray-500 dark:text-gray-400 mb-6">{error}</p>
          <p class="text-sm text-gray-400 dark:text-gray-500">
            Para habilitar esta función, crea el content-type "solicitud-de-repuesto" en Strapi con los campos: 
            repuesto (relación), cantidad, urgencia, estado, orden_de_trabajo (relación), observaciones.
          </p>
        </div>
      </Card>
    )}

    {!error && (
      <>
        <!-- Filtros -->
        <Card class="mb-6">
          <div class="flex flex-wrap gap-2">
            <a 
              href="/encargado/aprobar_solicitudes?estado=pendiente"
              class={`px-4 py-2 rounded-lg font-medium transition-colors ${filtroEstado === 'pendiente' ? 'bg-amber-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'}`}
            >
              Pendientes
            </a>
            <a 
              href="/encargado/aprobar_solicitudes?estado=aprobado"
              class={`px-4 py-2 rounded-lg font-medium transition-colors ${filtroEstado === 'aprobado' ? 'bg-green-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'}`}
            >
              Aprobadas
            </a>
            <a 
              href="/encargado/aprobar_solicitudes?estado=rechazado"
              class={`px-4 py-2 rounded-lg font-medium transition-colors ${filtroEstado === 'rechazado' ? 'bg-red-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'}`}
            >
              Rechazadas
            </a>
            <a 
              href="/encargado/aprobar_solicitudes?estado=todas"
              class={`px-4 py-2 rounded-lg font-medium transition-colors ${filtroEstado === 'todas' ? 'bg-primary-600 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'}`}
            >
              Todas
            </a>
          </div>
        </Card>

        {solicitudes.length === 0 ? (
          <Card>
            <div class="text-center py-12">
              <span class="material-symbols-outlined text-5xl text-gray-300 dark:text-gray-600 mb-4">inventory_2</span>
              <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">No hay solicitudes {filtroEstado !== 'todas' ? filtroEstado + 's' : ''}</h3>
              <p class="text-gray-500 dark:text-gray-400">Las solicitudes de repuesto de los mecánicos aparecerán aquí.</p>
            </div>
          </Card>
        ) : (
          <div class="space-y-4">
            {solicitudes.map((solicitud) => (
              <Card>
                <div class="flex flex-col lg:flex-row lg:items-center gap-4">
                  <!-- Info Principal -->
                  <div class="flex-1">
                    <div class="flex items-start gap-3">
                      <div class="w-12 h-12 bg-primary-100 dark:bg-primary-900/30 rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-primary-600 dark:text-primary-400">inventory_2</span>
                      </div>
                      <div class="flex-1">
                        <div class="flex items-center gap-2 flex-wrap">
                          <h3 class="text-lg font-bold text-gray-900 dark:text-white">
                            {solicitud.repuesto?.nombre || 'Repuesto no especificado'}
                          </h3>
                          <span class={`px-2 py-0.5 rounded text-xs font-medium ${urgenciaClases[solicitud.urgencia] || urgenciaClases['media']}`}>
                            {solicitud.urgencia?.toUpperCase() || 'MEDIA'}
                          </span>
                          <span class={`px-2 py-0.5 rounded text-xs font-medium ${estadoClases[solicitud.estado] || estadoClases['pendiente']}`}>
                            {solicitud.estado?.toUpperCase() || 'PENDIENTE'}
                          </span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                          SKU: {solicitud.repuesto?.sku || 'N/A'} • Cantidad solicitada: <span class="font-bold">{solicitud.cantidad}</span>
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                          Stock actual: <span class={`font-bold ${(solicitud.repuesto?.stock || 0) < solicitud.cantidad ? 'text-red-600' : 'text-green-600'}`}>
                            {solicitud.repuesto?.stock || 0}
                          </span>
                        </p>
                      </div>
                    </div>

                    <!-- Detalles de la orden -->
                    <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                          <span class="text-gray-500 dark:text-gray-400">Orden:</span>
                          <p class="font-medium text-gray-900 dark:text-white">OT-{solicitud.orden_de_trabajo?.id || 'N/A'}</p>
                        </div>
                        <div>
                          <span class="text-gray-500 dark:text-gray-400">Vehículo:</span>
                          <p class="font-medium text-gray-900 dark:text-white">
                            {solicitud.orden_de_trabajo?.vehiculo?.patente || 'N/A'}
                          </p>
                        </div>
                        <div>
                          <span class="text-gray-500 dark:text-gray-400">Mecánico:</span>
                          <p class="font-medium text-gray-900 dark:text-white">
                            {solicitud.orden_de_trabajo?.mecanico?.nombre || 'N/A'} {solicitud.orden_de_trabajo?.mecanico?.apellido || ''}
                          </p>
                        </div>
                        <div>
                          <span class="text-gray-500 dark:text-gray-400">Fecha:</span>
                          <p class="font-medium text-gray-900 dark:text-white">{formatDate(solicitud.createdAt)}</p>
                        </div>
                      </div>
                    </div>

                    {solicitud.observaciones && (
                      <div class="mt-3 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
                        <p class="text-sm text-amber-800 dark:text-amber-200">
                          <span class="font-medium">Observaciones:</span> {solicitud.observaciones}
                        </p>
                      </div>
                    )}
                  </div>

                  <!-- Acciones -->
                  {solicitud.estado === 'pendiente' && (
                    <div class="flex flex-row lg:flex-col gap-2 lg:w-auto" x-data="{ showReject: false, motivo: '' }">
                      <form method="POST" class="flex-1 lg:flex-none">
                        <input type="hidden" name="action" value="aprobar" />
                        <input type="hidden" name="solicitudId" value={solicitud.documentId} />
                        <input type="hidden" name="repuestoId" value={solicitud.repuesto?.documentId} />
                        <input type="hidden" name="cantidad" value={solicitud.cantidad} />
                        <input type="hidden" name="stockActual" value={solicitud.repuesto?.stock || 0} />
                        <button 
                          type="submit"
                          class={`w-full px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors ${(solicitud.repuesto?.stock || 0) >= solicitud.cantidad ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                          disabled={(solicitud.repuesto?.stock || 0) < solicitud.cantidad}
                        >
                          <span class="material-symbols-outlined text-sm">check</span>
                          Aprobar
                        </button>
                      </form>
                      
                      <button 
                        type="button"
                        @click="showReject = !showReject"
                        class="flex-1 lg:flex-none px-4 py-2 bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300 rounded-lg font-medium flex items-center justify-center gap-2 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors"
                      >
                        <span class="material-symbols-outlined text-sm">close</span>
                        Rechazar
                      </button>

                      <!-- Modal de rechazo -->
                      <div 
                        x-show="showReject" 
                        x-cloak
                        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
                        @click.self="showReject = false"
                      >
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4">
                          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Rechazar Solicitud</h3>
                          <form method="POST">
                            <input type="hidden" name="action" value="rechazar" />
                            <input type="hidden" name="solicitudId" value={solicitud.documentId} />
                            <textarea 
                              name="motivo_rechazo"
                              x-model="motivo"
                              rows="3"
                              placeholder="Motivo del rechazo..."
                              class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white mb-4"
                            ></textarea>
                            <div class="flex gap-2">
                              <button 
                                type="button"
                                @click="showReject = false"
                                class="flex-1 px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg"
                              >
                                Cancelar
                              </button>
                              <button 
                                type="submit"
                                class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                              >
                                Confirmar Rechazo
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  )}

                  {solicitud.estado !== 'pendiente' && (
                    <div class="text-center lg:w-32">
                      <span class={`inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium ${estadoClases[solicitud.estado]}`}>
                        <span class="material-symbols-outlined text-sm">
                          {solicitud.estado === 'aprobado' ? 'check_circle' : 'cancel'}
                        </span>
                        {solicitud.estado === 'aprobado' ? 'Aprobada' : 'Rechazada'}
                      </span>
                    </div>
                  )}
                </div>
              </Card>
            ))}
          </div>
        )}
      </>
    )}
  </div>
</DashboardLayout>
