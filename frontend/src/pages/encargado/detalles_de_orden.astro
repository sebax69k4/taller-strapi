---
export const prerender = false;
import { strapiGet } from '../../lib/strapi';
import '../../styles/global.css';
import DashboardLayout from '../../layouts/DashboardLayout.astro';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

const orderId = Astro.url.searchParams.get('id');
let order = null;

if (!orderId) {
  return Astro.redirect('/encargado/trabajos_en_curso');
}

try {
  const data = await strapiGet(`/api/orden-de-trabajos/${orderId}?populate[0]=cliente&populate[1]=vehiculo&populate[2]=mecanico&populate[3]=repuestos&populate[4]=bitacoras&populate[5]=presupuesto`);
  order = data.data;
} catch (e) {
  console.error('Error fetching order:', e);
}

if (!order) {
  return Astro.redirect('/encargado/trabajos_en_curso');
}

const formatDate = (dateString: string) => {
  if (!dateString) return 'N/A';
  return new Date(dateString).toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

const getStatusColor = (status: string) => {
    switch (status) {
        case 'ingresado': return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
        case 'en_diagnostico': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
        case 'en_reparacion': return 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300';
        case 'finalizado': return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
        case 'entregado': return 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300';
        default: return 'bg-gray-100 text-gray-800';
    }
};

const getStatusLabel = (status: string) => {
    return status ? status.replace('_', ' ').toUpperCase() : 'DESCONOCIDO';
};

// Calculate total from parts and labor
const partsTotal = order.repuestos?.reduce((acc: number, part: any) => acc + (part.precio || 0), 0) || 0;
// Use budget total if available to derive labor, or use default labor cost
const budgetTotal = order.presupuesto?.monto_total;
const laborCost = budgetTotal ? (budgetTotal - partsTotal) : 75000; 
// If budget exists, we assume it's the subtotal before tax or the total. 
// Let's assume for consistency with other pages: Total = Parts + Labor + Tax
// If budget is present, we treat it as the "Subtotal" (Parts + Labor).
const subtotal = partsTotal + laborCost;
const iva = subtotal * 0.19; // 19% IVA
const grandTotal = subtotal + iva;

--- 

<DashboardLayout title="Detalles de Orden" role="encargado" currentPath="/encargado/detalles_de_orden">
    <div class="mx-auto max-w-6xl">
        <!-- Header Bar -->
        <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6 print:hidden">
            <div>
                <!-- Breadcrumbs -->
                <div class="flex flex-wrap items-center gap-2">
                    <a class="text-gray-500 dark:text-gray-400 text-base font-medium leading-normal hover:text-primary-600 dark:hover:text-primary-400" href="/encargado/trabajos_en_curso">Órdenes</a>
                    <span class="text-gray-400 dark:text-gray-500 text-base font-medium leading-normal">/</span>
                    <span class="text-gray-800 dark:text-gray-200 text-base font-medium leading-normal">Orden #{order.documentId.slice(0, 6)}</span>
                </div>
                <div class="flex items-center gap-3 mt-2">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Orden de Trabajo #{order.documentId.slice(0, 6)}</h1>
                    <!-- Chip -->
                    <div class={`flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-full px-3 ${getStatusColor(order.estado)}`}>
                        <span class="w-2 h-2 rounded-full bg-current"></span>
                        <p class="text-sm font-medium leading-normal">{getStatusLabel(order.estado)}</p>
                    </div>
                </div>
            </div>
            <!-- Toolbar -->
            <div class="flex gap-2">
                <a href={`/encargado/asignar_orden_zona?id=${order.documentId}`} class="flex items-center justify-center gap-2 p-2 h-10 w-10 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm transition-colors">
                    <span class="material-symbols-outlined">edit</span>
                </a>
                <button onclick="window.print()" class="flex items-center justify-center gap-2 p-2 h-10 w-10 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm transition-colors">
                    <span class="material-symbols-outlined">print</span>
                </button>
            </div>
        </header>

        <!-- Grid Layout for Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Details -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- Customer & Vehicle Card -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white pb-4 border-b border-gray-200 dark:border-gray-700">Información del Cliente y Vehículo</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Cliente</h3>
                            <p class="font-bold text-gray-900 dark:text-white text-lg">{order.cliente?.nombre} {order.cliente?.apellido}</p>
                            <div class="flex items-center gap-2 mt-1 text-gray-600 dark:text-gray-300">
                                <span class="material-symbols-outlined text-sm">email</span>
                                <p>{order.cliente?.email}</p>
                            </div>
                            <div class="flex items-center gap-2 mt-1 text-gray-600 dark:text-gray-300">
                                <span class="material-symbols-outlined text-sm">phone</span>
                                <p>{order.cliente?.telefono}</p>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2 uppercase tracking-wide">Vehículo</h3>
                            <p class="font-bold text-gray-900 dark:text-white text-lg">{order.vehiculo?.marca} {order.vehiculo?.modelo} <span class="text-gray-500 font-normal">({order.vehiculo?.ano})</span></p>
                            <div class="flex items-center gap-2 mt-1 text-gray-600 dark:text-gray-300">
                                <span class="material-symbols-outlined text-sm">pin</span>
                                <p>Matrícula: {order.vehiculo?.patente}</p>
                            </div>
                            <div class="flex items-center gap-2 mt-1 text-gray-600 dark:text-gray-300">
                                <span class="material-symbols-outlined text-sm">fingerprint</span>
                                <p>VIN: {order.vehiculo?.vin || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parts & Labor Card -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white pb-4 mb-4 border-b border-gray-200 dark:border-gray-700">Repuestos y Servicios</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-sm text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                                    <th class="py-3 font-medium">Descripción</th>
                                    <th class="py-3 font-medium text-center">Cantidad</th>
                                    <th class="py-3 font-medium text-right">Precio Unitario</th>
                                    <th class="py-3 font-medium text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                {order.repuestos?.map((part: any) => (
                                    <tr>
                                        <td class="py-4 text-gray-900 dark:text-white">{part.nombre}</td>
                                        <td class="py-4 text-center text-gray-600 dark:text-gray-300">1</td>
                                        <td class="py-4 text-right text-gray-600 dark:text-gray-300">€{part.precio}</td>
                                        <td class="py-4 text-right font-medium text-gray-900 dark:text-white">€{part.precio}</td>
                                    </tr>
                                ))}
                                <tr>
                                    <td class="py-4 text-gray-900 dark:text-white">Mano de Obra / Servicios</td>
                                    <td class="py-4 text-center text-gray-600 dark:text-gray-300">1</td>
                                    <td class="py-4 text-right text-gray-600 dark:text-gray-300">€{laborCost}</td>
                                    <td class="py-4 text-right font-medium text-gray-900 dark:text-white">€{laborCost}</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="pt-6 text-right font-medium text-gray-600 dark:text-gray-300" colspan="3">Subtotal</td>
                                    <td class="pt-6 text-right font-medium text-gray-900 dark:text-white">€{subtotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-right font-medium text-gray-600 dark:text-gray-300" colspan="3">IVA (19%)</td>
                                    <td class="py-2 text-right font-medium text-gray-900 dark:text-white">€{iva.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td class="pt-4 text-right text-lg font-bold text-gray-900 dark:text-white" colspan="3">Total</td>
                                    <td class="pt-4 text-right text-lg font-bold text-primary-600 dark:text-primary-400">€{grandTotal.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary & History -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- Summary Card -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white pb-4 mb-4 border-b border-gray-200 dark:border-gray-700">Resumen de la Orden</h2>
                    <div class="space-y-4 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 dark:text-gray-400">Fecha de Ingreso</span>
                            <span class="font-medium text-gray-900 dark:text-white">{formatDate(order.fecha_ingreso)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 dark:text-gray-400">Mecánico Asignado</span>
                            <span class="font-medium text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
                                {order.mecanico ? `${order.mecanico.nombre} ${order.mecanico.apellido}` : 'Sin asignar'}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 dark:text-gray-400">Inicio Planificado</span>
                            <span class="font-medium text-gray-900 dark:text-white">{formatDate(order.fecha_inicio_planificada)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 dark:text-gray-400">Fin Planificado</span>
                            <span class="font-medium text-gray-900 dark:text-white">{formatDate(order.fecha_fin_planificada)}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 dark:text-gray-400">Entrega Estimada</span>
                            <span class="font-medium text-gray-900 dark:text-white">{formatDate(order.fecha_estimada)}</span>
                        </div>
                        <div class="pt-4 border-t border-gray-100 dark:border-gray-700">
                            <span class="text-gray-500 dark:text-gray-400 block mb-2">Descripción del Problema</span>
                            <p class="font-medium text-gray-900 dark:text-white bg-gray-50 dark:bg-gray-900/50 p-3 rounded-lg border border-gray-100 dark:border-gray-700 text-sm leading-relaxed">
                                {order.descripcion}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Timeline Component -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white pb-4 border-b border-gray-200 dark:border-gray-700">Historial y Bitácora</h2>
                    <div class="mt-6 space-y-8 relative">
                        <!-- Vertical line -->
                        <div class="absolute left-[11px] top-2 bottom-2 w-0.5 bg-gray-200 dark:bg-gray-700"></div>

                        {order.bitacoras?.map((bitacora: any) => (
                            <div class="relative flex gap-4">
                                <div class="z-10 flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-blue-500 text-white ring-4 ring-white dark:ring-gray-800">
                                    <span class="material-symbols-outlined !text-[14px]">history</span>
                                </div>
                                <div class="flex-1 -mt-1">
                                    <p class="font-bold text-gray-900 dark:text-white text-sm">{bitacora.procedimientos}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">{formatDate(bitacora.fecha)}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-gray-900/50 p-2 rounded border border-gray-100 dark:border-gray-700">{bitacora.observaciones}</p>
                                </div>
                            </div>
                        ))}

                        <div class="relative flex gap-4">
                            <div class="z-10 flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-green-500 text-white ring-4 ring-white dark:ring-gray-800">
                                <span class="material-symbols-outlined !text-[14px]">add</span>
                            </div>
                            <div class="flex-1 -mt-1">
                                <p class="font-bold text-gray-900 dark:text-white text-sm">Orden Creada</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">{formatDate(order.createdAt)}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Vehículo recibido en el taller.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</DashboardLayout>