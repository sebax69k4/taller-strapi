---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Badge from '../../components/ui/Badge.astro';
import { strapiGet, strapiPut } from '../../lib/strapi';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

interface Vehiculo {
  marca: string;
  modelo: string;
  patente: string;
  cliente?: {
    nombre: string;
    apellido: string;
    telefono?: string;
  };
}

interface Order {
  id: number;
  documentId: string;
  descripcion: string;
  estado: string;
  prioridad?: string;
  fecha_ingreso?: string;
  vehiculo?: Vehiculo;
  zona?: { nombre: string };
}

interface Mechanic {
  id: number;
  documentId: string;
  nombre: string;
  apellido?: string;
  especialidad?: string;
  estado?: string;
  orden_de_trabajos?: any[];
  zona?: { nombre: string };
}

let pendingOrders: Order[] = [];
let mechanics: Mechanic[] = [];
let error = '';
let successMessage = '';

// Stats
let ordenesSinAsignar = 0;
let ordenesUrgentes = 0;
let mecanicosDisponibles = 0;
let capacidadTotal = 0;

try {
  const [ordersData, mechanicsData] = await Promise.all([
    strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=ingresado&populate[vehiculo][populate]=cliente&populate=zona&sort=prioridad:asc,createdAt:asc'),
    strapiGet('/api/mecenicos?populate[orden_de_trabajos][filters][estado][$notIn][0]=entregado&populate[orden_de_trabajos][filters][estado][$notIn][1]=facturado&populate=zona')
  ]);
  
  pendingOrders = ordersData.data || [];
  mechanics = mechanicsData.data || [];

  // Stats
  ordenesSinAsignar = pendingOrders.length;
  ordenesUrgentes = pendingOrders.filter(o => o.prioridad === 'urgente').length;
  
  mechanics.forEach((m: Mechanic) => {
    const activeOrders = m.orden_de_trabajos?.length || 0;
    if (activeOrders < 3) mecanicosDisponibles++;
  });
  
  capacidadTotal = mechanics.length * 5;

  // Handle Assignment
  if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const orderId = formData.get('orderId');
    const mechanicId = formData.get('mechanicId');

    if (orderId && mechanicId) {
      await strapiPut(`/api/orden-de-trabajos/${orderId}`, {
        mecanico: mechanicId,
        estado: 'en_diagnostico'
      });
      return Astro.redirect('/encargado/asig_orden?success=true');
    }
  }

} catch (e: any) {
  console.error('Error fetching data:', e);
  error = e.message || 'Error de conexión';
}

const urlSuccess = Astro.url.searchParams.get('success');
if (urlSuccess === 'true') {
  successMessage = 'Orden asignada correctamente al mecánico';
}

const getPrioridadColor = (prioridad: string) => {
  switch (prioridad) {
    case 'urgente': return 'bg-red-500';
    case 'alta': return 'bg-orange-500';
    case 'normal': return 'bg-blue-500';
    case 'baja': return 'bg-gray-400';
    default: return 'bg-blue-500';
  }
};

const getTimeAgo = (dateStr: string) => {
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffHrs / 24);
  
  if (diffDays > 0) return `Hace ${diffDays} día${diffDays > 1 ? 's' : ''}`;
  if (diffHrs > 0) return `Hace ${diffHrs} hora${diffHrs > 1 ? 's' : ''}`;
  return 'Recién ingresado';
};
---

<DashboardLayout title="Asignar Orden" role="encargado" currentPath="/encargado/asig_orden">
  <div class="max-w-7xl mx-auto" x-data="assignController()">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Asignación de Órdenes</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1">Arrastra una orden y suéltala sobre un mecánico para asignarla</p>
      </div>
      <div class="flex gap-2">
        <a href="/encargado/reasignar_orden" class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">swap_horiz</span>
          Reasignar
        </a>
        <a href="/encargado/disp_mec" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined">groups</span>
          Ver Equipo
        </a>
      </div>
    </div>

    <!-- Mensajes -->
    {successMessage && (
      <div class="p-4 mb-6 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl text-green-800 dark:text-green-200 flex items-center gap-3">
        <span class="material-symbols-outlined">check_circle</span>
        <span class="font-medium">{successMessage}</span>
        <a href="/encargado/trabajos_en_curso" class="ml-auto text-sm underline">Ver en curso →</a>
      </div>
    )}
    {error && (
      <div class="p-4 mb-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-800 dark:text-red-200 flex items-center gap-2">
        <span class="material-symbols-outlined">error</span>
        <span>{error}</span>
      </div>
    )}

    <!-- KPIs -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-5 text-white">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-amber-100 text-xs uppercase tracking-wide">Sin Asignar</p>
            <p class="text-3xl font-bold mt-1">{ordenesSinAsignar}</p>
          </div>
          <span class="material-symbols-outlined text-amber-200 text-2xl">pending_actions</span>
        </div>
      </div>
      
      <div class="bg-gradient-to-br from-red-500 to-rose-600 rounded-2xl p-5 text-white">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-red-100 text-xs uppercase tracking-wide">Urgentes</p>
            <p class="text-3xl font-bold mt-1">{ordenesUrgentes}</p>
          </div>
          <span class="material-symbols-outlined text-red-200 text-2xl">priority_high</span>
        </div>
      </div>
      
      <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-green-100 text-xs uppercase tracking-wide">Mec. Disponibles</p>
            <p class="text-3xl font-bold mt-1">{mecanicosDisponibles}</p>
          </div>
          <span class="material-symbols-outlined text-green-200 text-2xl">engineering</span>
        </div>
      </div>
      
      <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-blue-100 text-xs uppercase tracking-wide">Total Mecánicos</p>
            <p class="text-3xl font-bold mt-1">{mechanics.length}</p>
          </div>
          <span class="material-symbols-outlined text-blue-200 text-2xl">groups</span>
        </div>
      </div>
    </div>

    <!-- Panel principal -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Órdenes Pendientes -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-amber-50 dark:bg-amber-900/20">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-amber-500">pending_actions</span>
              Órdenes Pendientes
            </h2>
            <span class="px-2.5 py-1 bg-amber-500 text-white text-sm font-bold rounded-full">{pendingOrders.length}</span>
          </div>
        </div>
        
        <div class="p-4 space-y-3 max-h-[600px] overflow-y-auto">
          {pendingOrders.length > 0 ? (
            pendingOrders.map((order: Order) => (
              <div 
                class="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-200 dark:border-gray-700 cursor-move hover:border-primary-500 hover:shadow-lg transition-all group"
                draggable="true"
                data-order-id={order.documentId}
                ondragstart="event.dataTransfer.setData('text/plain', this.dataset.orderId); this.classList.add('opacity-50')"
                ondragend="this.classList.remove('opacity-50')"
              >
                <div class="flex justify-between items-start mb-2">
                  <div class="flex items-center gap-2">
                    <span class={`w-2 h-2 rounded-full ${getPrioridadColor(order.prioridad || 'normal')}`}></span>
                    <h3 class="font-bold text-gray-900 dark:text-white">OT-{order.id}</h3>
                    {order.prioridad === 'urgente' && (
                      <Badge variant="error">URGENTE</Badge>
                    )}
                  </div>
                  <span class="material-symbols-outlined text-gray-400 group-hover:text-primary-500 transition-colors">drag_indicator</span>
                </div>
                
                <div class="space-y-2">
                  <div class="flex items-center gap-2 text-sm">
                    <span class="material-symbols-outlined text-gray-400 text-base">directions_car</span>
                    <span class="font-medium text-gray-900 dark:text-white">
                      {order.vehiculo ? `${order.vehiculo.marca} ${order.vehiculo.modelo}` : 'N/A'}
                    </span>
                    <span class="text-gray-500 font-mono">{order.vehiculo?.patente}</span>
                  </div>
                  
                  {order.vehiculo?.cliente && (
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                      <span class="material-symbols-outlined text-gray-400 text-base">person</span>
                      <span>{order.vehiculo.cliente.nombre} {order.vehiculo.cliente.apellido}</span>
                    </div>
                  )}
                  
                  <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">{order.descripcion || 'Sin descripción'}</p>
                  
                  <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-700">
                    {order.zona && (
                      <span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-gray-600 dark:text-gray-300">
                        {order.zona.nombre}
                      </span>
                    )}
                    {order.fecha_ingreso && (
                      <span class="text-xs text-gray-400 flex items-center gap-1">
                        <span class="material-symbols-outlined text-xs">schedule</span>
                        {getTimeAgo(order.fecha_ingreso)}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ))
          ) : (
            <div class="text-center py-12">
              <span class="material-symbols-outlined text-5xl text-green-500 mb-3">check_circle</span>
              <h3 class="font-bold text-gray-900 dark:text-white">¡Todo asignado!</h3>
              <p class="text-gray-500 text-sm mt-1">No hay órdenes pendientes</p>
            </div>
          )}
        </div>
      </div>

      <!-- Mecánicos -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-blue-50 dark:bg-blue-900/20">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-blue-500">engineering</span>
              Mecánicos
            </h2>
            <span class="text-sm text-gray-500">{mecanicosDisponibles} disponibles</span>
          </div>
        </div>
        
        <div class="p-4 space-y-3 max-h-[600px] overflow-y-auto">
          {mechanics.length > 0 ? (
            mechanics.map((mechanic: Mechanic) => {
              const activeOrders = mechanic.orden_de_trabajos?.length || 0;
              const maxOrders = 5;
              const workloadPercentage = Math.min((activeOrders / maxOrders) * 100, 100);
              const isOverloaded = activeOrders >= maxOrders;
              
              return (
                <div 
                  class={`p-4 rounded-xl border-2 border-dashed transition-all ${
                    isOverloaded 
                      ? 'border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 opacity-60' 
                      : 'border-gray-300 dark:border-gray-600 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 cursor-pointer'
                  }`}
                  data-mechanic-id={mechanic.id}
                  ondragover={!isOverloaded ? "event.preventDefault(); this.classList.add('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20', 'scale-[1.02]')" : ""}
                  ondragleave="this.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20', 'scale-[1.02]')"
                  ondrop={!isOverloaded ? "handleDrop(event, this.dataset.mechanicId)" : ""}
                >
                  <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-3">
                      <div class={`w-12 h-12 rounded-full flex items-center justify-center text-white font-bold ${
                        isOverloaded ? 'bg-gray-400' : 
                        activeOrders === 0 ? 'bg-green-500' :
                        activeOrders <= 2 ? 'bg-blue-500' : 'bg-amber-500'
                      }`}>
                        {mechanic.nombre?.charAt(0)}{mechanic.apellido?.charAt(0) || ''}
                      </div>
                      <div>
                        <h3 class="font-bold text-gray-900 dark:text-white">{mechanic.nombre} {mechanic.apellido || ''}</h3>
                        <p class="text-xs text-gray-500 uppercase tracking-wide">{mechanic.especialidad || 'General'}</p>
                      </div>
                    </div>
                    <div class="text-right">
                      <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold ${
                        isOverloaded ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300' :
                        activeOrders === 0 ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' :
                        activeOrders <= 2 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' :
                        'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300'
                      }`}>
                        {activeOrders} / {maxOrders}
                      </span>
                      {isOverloaded && (
                        <p class="text-xs text-red-500 mt-1">Capacidad máxima</p>
                      )}
                    </div>
                  </div>
                  
                  <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                      <span class="text-gray-500">Carga de trabajo</span>
                      <span class="font-medium text-gray-700 dark:text-gray-300">{Math.round(workloadPercentage)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                      <div 
                        class={`h-2 rounded-full transition-all ${
                          isOverloaded ? 'bg-red-500' :
                          workloadPercentage > 60 ? 'bg-amber-500' : 'bg-green-500'
                        }`}
                        style={`width: ${workloadPercentage}%`}
                      ></div>
                    </div>
                  </div>
                  
                  {!isOverloaded && activeOrders === 0 && (
                    <div class="mt-3 text-center">
                      <span class="text-xs text-green-600 dark:text-green-400 flex items-center justify-center gap-1">
                        <span class="material-symbols-outlined text-sm">check_circle</span>
                        Disponible para asignación
                      </span>
                    </div>
                  )}
                </div>
              );
            })
          ) : (
            <div class="text-center py-12">
              <span class="material-symbols-outlined text-5xl text-gray-300 mb-3">person_off</span>
              <h3 class="font-bold text-gray-900 dark:text-white">Sin mecánicos</h3>
              <p class="text-gray-500 text-sm mt-1">No hay mecánicos registrados</p>
            </div>
          )}
        </div>
      </div>
    </div>

    <!-- Form oculto para submit -->
    <form id="assignForm" method="POST" class="hidden">
      <input type="hidden" name="orderId" id="orderIdInput" />
      <input type="hidden" name="mechanicId" id="mechanicIdInput" />
    </form>

    <!-- Modal de confirmación -->
    <div x-show="showConfirmModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl" @click.outside="showConfirmModal = false">
        <div class="text-center mb-6">
          <div class="w-16 h-16 mx-auto bg-primary-100 dark:bg-primary-900/30 rounded-full flex items-center justify-center mb-4">
            <span class="material-symbols-outlined text-3xl text-primary-600">assignment_ind</span>
          </div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-white">Confirmar Asignación</h3>
          <p class="text-gray-500 mt-2" x-text="confirmMessage"></p>
        </div>
        <div class="flex gap-3">
          <button @click="showConfirmModal = false" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
            Cancelar
          </button>
          <button @click="confirmAssign()" class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
            Confirmar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    function handleDrop(event, mechanicId) {
      event.preventDefault();
      event.currentTarget.classList.remove('border-primary-500', 'bg-primary-50', 'dark:bg-primary-900/20', 'scale-[1.02]');
      const orderId = event.dataTransfer.getData('text/plain');
      if (orderId && mechanicId) {
        document.getElementById('orderIdInput').value = orderId;
        document.getElementById('mechanicIdInput').value = mechanicId;
        document.getElementById('assignForm').submit();
      }
    }

    function assignController() {
      return {
        showConfirmModal: false,
        confirmMessage: '',
        pendingOrderId: '',
        pendingMechanicId: '',
        
        openConfirmModal(orderId, mechanicId, mechanicName) {
          this.pendingOrderId = orderId;
          this.pendingMechanicId = mechanicId;
          this.confirmMessage = `¿Asignar esta orden a ${mechanicName}?`;
          this.showConfirmModal = true;
        },
        
        confirmAssign() {
          document.getElementById('orderIdInput').value = this.pendingOrderId;
          document.getElementById('mechanicIdInput').value = this.pendingMechanicId;
          document.getElementById('assignForm').submit();
        }
      }
    }
  </script>
</DashboardLayout>

<style>
  [x-cloak] { display: none !important; }
</style>
