---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { strapiGet, strapiPut } from '../../lib/strapi';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

let pendingOrders = [];
let mechanics = [];
let error = '';
let successMessage = '';

try {
  // Fetch Pending Orders
  const ordersData = await strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=Pendiente&populate=vehiculo');
  pendingOrders = ordersData.data || [];

  // Fetch Mechanics with their orders to calculate workload
  const mechanicsData = await strapiGet('/api/mecenicos?populate=orden_de_trabajos');
  mechanics = mechanicsData.data || [];

  // Handle Assignment (POST request to self)
  if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const orderId = formData.get('orderId');
    const mechanicId = formData.get('mechanicId');

    if (orderId && mechanicId) {
      await strapiPut(`/api/orden-de-trabajos/${orderId}`, {
        mecanico: mechanicId,
        estado: 'En Progreso'
      });
      successMessage = 'Orden asignada correctamente';
      // Refresh data
      return Astro.redirect('/encargado/asig_orden');
    }
  }

} catch (e) {
  console.error('Error fetching data:', e);
  error = 'Error de conexión';
}
---
<DashboardLayout title="Asignar Orden" role="encargado" currentPath="/encargado/asig_orden">
    <!-- Page Heading -->
    <header class="mb-8">
        <div class="flex flex-col gap-2">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Asignación de Órdenes de Trabajo</h1>
            <p class="text-gray-500 dark:text-gray-400 text-base">Arrastra una orden pendiente y suéltala sobre un mecánico para asignarla.</p>
            {successMessage && (
                <div class="mt-4 p-4 bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 rounded-lg text-green-800 dark:text-green-200 flex items-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    <p class="font-medium">{successMessage}</p>
                </div>
            )}
            {error && (
                <div class="mt-4 p-4 bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 rounded-lg text-red-800 dark:text-red-200 flex items-center gap-2">
                    <span class="material-symbols-outlined">error</span>
                    <p class="font-medium">{error}</p>
                </div>
            )}
        </div>
    </header>

    <!-- Main grid layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-250px)]">
        <!-- Left Panel: Pending Orders -->
        <div class="flex flex-col bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden h-full">
            <!-- Section Header -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-gray-500">pending_actions</span>
                    Órdenes Pendientes ({pendingOrders.length})
                </h2>
            </div>
            
            <!-- Search and Filters -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="material-symbols-outlined text-gray-400">search</span>
                    </div>
                    <input 
                        class="block w-full pl-10 pr-3 py-2 border border-gray-200 dark:border-gray-700 rounded-lg leading-5 bg-gray-50 dark:bg-gray-900/50 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 sm:text-sm transition duration-150 ease-in-out" 
                        placeholder="Buscar por ID, vehículo o servicio..." 
                        type="text"
                    />
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="text-base font-bold text-gray-900 dark:text-white">{mechanic.nombre}</h3>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">{mechanic.especialidad || 'Mecánico General'}</p>
                                        </div>
                                        <span class={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                            workloadPercentage > 80 ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' : 
                                            workloadPercentage > 50 ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' : 
                                            'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
                                        }`}>
                                            {activeOrders} Asignadas
                                        </span>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <div class="flex justify-between mb-1">
                                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Carga de Trabajo</span>
                                            <span class="text-xs font-medium text-gray-700 dark:text-gray-300">{Math.round(workloadPercentage)}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 overflow-hidden">
                                            <div 
                                                class={`h-1.5 rounded-full transition-all duration-500 ${
                                                    workloadPercentage > 80 ? 'bg-red-500' : 
                                                    workloadPercentage > 50 ? 'bg-yellow-500' : 
                                                    'bg-green-500'
                                                }`} 
                                                style={`width: ${workloadPercentage}%`}
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    </div>

    <form id="assignForm" method="POST" class="hidden">
        <input type="hidden" name="orderId" id="orderIdInput" />
        <input type="hidden" name="mechanicId" id="mechanicIdInput" />
    </form>

    <script is:inline>
        function handleDrop(event, mechanicId) {
            event.preventDefault();
            const orderId = event.dataTransfer.getData('text/plain');
            if (orderId && mechanicId) {
                document.getElementById('orderIdInput').value = orderId;
                document.getElementById('mechanicIdInput').value = mechanicId;
                document.getElementById('assignForm').submit();
            }
        }
    </script>
</DashboardLayout>