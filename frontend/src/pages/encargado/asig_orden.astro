---
export const prerender = false;
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { strapiGet, strapiPut } from '../../lib/strapi';
import '../../styles/global.css';

const userRole = Astro.cookies.get('user_role')?.value;
if (!userRole) {
  return Astro.redirect('/login');
}

interface Vehiculo {
  marca: string;
  modelo: string;
  patente: string;
}

interface Order {
  id: number;
  documentId: string;
  descripcion: string;
  estado: string;
  fecha_ingreso?: string;
  vehiculo?: Vehiculo;
}

interface Mechanic {
  id: number;
  documentId: string;
  nombre: string;
  apellido?: string;
  especialidad?: string;
  orden_de_trabajos?: any[];
}

let pendingOrders: Order[] = [];
let mechanics: Mechanic[] = [];
let error = '';
let successMessage = '';

try {
  // Fetch Pending Orders (estado = ingresado, sin mecánico asignado)
  const ordersData = await strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=ingresado&populate=vehiculo');
  pendingOrders = ordersData.data || [];

  // Fetch Mechanics with their orders to calculate workload
  const mechanicsData = await strapiGet('/api/mecenicos?populate[orden_de_trabajos][fields][0]=estado&populate[orden_de_trabajos][fields][1]=id');
  mechanics = mechanicsData.data || [];

  // Handle Assignment (POST request)
  if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const orderId = formData.get('orderId');
    const mechanicId = formData.get('mechanicId');

    if (orderId && mechanicId) {
      await strapiPut(`/api/orden-de-trabajos/${orderId}`, {
        mecanico: mechanicId,
        estado: 'en_diagnostico'
      });
      successMessage = 'Orden asignada correctamente';
      return Astro.redirect('/encargado/asig_orden?success=true');
    }
  }

} catch (e: any) {
  console.error('Error fetching data:', e);
  error = e.message || 'Error de conexión';
}

// Check for success message from redirect
const urlSuccess = Astro.url.searchParams.get('success');
if (urlSuccess === 'true') {
  successMessage = 'Orden asignada correctamente';
}
---

<DashboardLayout title="Asignar Orden" role="encargado" currentPath="/encargado/asig_orden">
    <header class="mb-8">
        <div class="flex flex-col gap-2">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white font-display">Asignación de Órdenes de Trabajo</h1>
            <p class="text-gray-500 dark:text-gray-400 text-base">Arrastra una orden pendiente y suéltala sobre un mecánico para asignarla.</p>
            {successMessage && (
                <div class="mt-4 p-4 bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 rounded-lg text-green-800 dark:text-green-200 flex items-center gap-2">
                    <span class="material-symbols-outlined">check_circle</span>
                    <p class="font-medium">{successMessage}</p>
                </div>
            )}
            {error && (
                <div class="mt-4 p-4 bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 rounded-lg text-red-800 dark:text-red-200 flex items-center gap-2">
                    <span class="material-symbols-outlined">error</span>
                    <p class="font-medium">{error}</p>
                </div>
            )}
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Panel: Pending Orders -->
        <div class="flex flex-col bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-gray-500">pending_actions</span>
                    Órdenes Pendientes ({pendingOrders.length})
                </h2>
            </div>
            
            <div class="p-4 space-y-3 overflow-y-auto max-h-[500px]">
                {pendingOrders.length > 0 ? (
                    pendingOrders.map((order: Order) => (
                        <div 
                            class="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700 cursor-move hover:border-primary-500 hover:shadow-md transition-all"
                            draggable="true"
                            data-order-id={order.documentId}
                            ondragstart="event.dataTransfer.setData('text/plain', this.dataset.orderId)"
                        >
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-gray-900 dark:text-white">OT-{order.id}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        {order.vehiculo ? `${order.vehiculo.marca} ${order.vehiculo.modelo} - ${order.vehiculo.patente}` : 'Sin vehículo'}
                                    </p>
                                </div>
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                                    Ingresado
                                </span>
                            </div>
                            <p class="mt-2 text-sm text-gray-600 dark:text-gray-300 line-clamp-2">{order.descripcion || 'Sin descripción'}</p>
                            {order.fecha_ingreso && (
                                <p class="mt-2 text-xs text-gray-400 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">calendar_today</span>
                                    {new Date(order.fecha_ingreso).toLocaleDateString()}
                                </p>
                            )}
                        </div>
                    ))
                ) : (
                    <div class="text-center py-8">
                        <span class="material-symbols-outlined text-4xl text-gray-300 dark:text-gray-600">inbox</span>
                        <p class="mt-2 text-gray-500 dark:text-gray-400">No hay órdenes pendientes</p>
                    </div>
                )}
            </div>
        </div>

        <!-- Right Panel: Mechanics -->
        <div class="flex flex-col bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-gray-500">engineering</span>
                    Mecánicos Disponibles ({mechanics.length})
                </h2>
            </div>
            
            <div class="p-4 space-y-3 overflow-y-auto max-h-[500px]">
                {mechanics.length > 0 ? (
                    mechanics.map((mechanic: Mechanic) => {
                        // Solo contar órdenes activas (no finalizadas, facturadas o entregadas)
                        const activeOrders = mechanic.orden_de_trabajos?.filter((o: any) => 
                            !['finalizado', 'facturado', 'entregado'].includes(o.estado)
                        ).length || 0;
                        const maxOrders = 5;
                        const workloadPercentage = Math.min((activeOrders / maxOrders) * 100, 100);
                        
                        return (
                            <div 
                                class="p-4 bg-gray-50 dark:bg-gray-900/50 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all"
                                data-mechanic-id={mechanic.documentId}
                                ondragover="event.preventDefault(); this.classList.add('border-primary-500', 'bg-primary-50')"
                                ondragleave="this.classList.remove('border-primary-500', 'bg-primary-50')"
                                ondrop="handleDrop(event, this.dataset.mechanicId)"
                            >
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-base font-bold text-gray-900 dark:text-white">
                                            {mechanic.nombre} {mechanic.apellido || ''}
                                        </h3>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">
                                            {mechanic.especialidad || 'Mecánico General'}
                                        </p>
                                    </div>
                                    <span class={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                        workloadPercentage > 80 ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' : 
                                        workloadPercentage > 50 ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' : 
                                        'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300'
                                    }`}>
                                        {activeOrders} Asignadas
                                    </span>
                                </div>
                                
                                <div class="mt-3">
                                    <div class="flex justify-between mb-1">
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Carga de Trabajo</span>
                                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300">{Math.round(workloadPercentage)}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 overflow-hidden">
                                        <div 
                                            class={`h-1.5 rounded-full transition-all duration-500 ${
                                                workloadPercentage > 80 ? 'bg-red-500' : 
                                                workloadPercentage > 50 ? 'bg-yellow-500' : 
                                                'bg-green-500'
                                            }`} 
                                            style={`width: ${workloadPercentage}%`}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        );
                    })
                ) : (
                    <div class="text-center py-8">
                        <span class="material-symbols-outlined text-4xl text-gray-300 dark:text-gray-600">person_off</span>
                        <p class="mt-2 text-gray-500 dark:text-gray-400">No hay mecánicos registrados</p>
                    </div>
                )}
            </div>
        </div>
    </div>

    <form id="assignForm" method="POST" class="hidden">
        <input type="hidden" name="orderId" id="orderIdInput" />
        <input type="hidden" name="mechanicId" id="mechanicIdInput" />
    </form>

    <script is:inline>
        function handleDrop(event, mechanicId) {
            event.preventDefault();
            event.currentTarget.classList.remove('border-primary-500', 'bg-primary-50');
            const orderId = event.dataTransfer.getData('text/plain');
            if (orderId && mechanicId) {
                document.getElementById('orderIdInput').value = orderId;
                document.getElementById('mechanicIdInput').value = mechanicId;
                document.getElementById('assignForm').submit();
            }
        }
    </script>
</DashboardLayout>
