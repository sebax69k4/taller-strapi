---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import Sidebar from '../../components/Sidebar.astro';
import { strapiGet, strapiPut, strapiPost } from '../../lib/strapi';

const ordenId = Astro.url.searchParams.get('orden');
let orden: any = null;
let mecanicos: any[] = [];
let error = '';
let successMessage = '';

// Cargar mecánicos disponibles
try {
  const mecResponse = await strapiGet('/api/mecenicos?filters[disponible][$eq]=true&pagination[pageSize]=100');
  mecanicos = mecResponse.data || [];
} catch (e: any) {
  error = e.message;
}

// Cargar orden si hay ID
if (ordenId) {
  try {
    const response = await strapiGet(`/api/orden-de-trabajos/${ordenId}?populate[vehiculo][populate][cliente]=*&populate[mecanico]=*&populate[zona]=*`);
    orden = response.data;
  } catch (e: any) {
    error = e.message;
  }
}

// Procesar reasignación
if (Astro.request.method === 'POST' && orden) {
  try {
    const formData = await Astro.request.formData();
    const nuevoMecanicoId = formData.get('mecanico_id') as string;
    const motivo = formData.get('motivo') as string;
    
    if (!nuevoMecanicoId) {
      error = 'Debe seleccionar un mecánico';
    } else if (!motivo) {
      error = 'Debe indicar el motivo de la reasignación';
    } else {
      const mecanicoAnterior = orden.mecanico ? `${orden.mecanico.nombre} ${orden.mecanico.apellido}` : 'Sin asignar';
      const nuevoMecanico = mecanicos.find(m => m.documentId === nuevoMecanicoId);
      
      // Actualizar orden con nuevo mecánico
      await strapiPut(`/api/orden-de-trabajos/${ordenId}`, {
        mecanico: parseInt(nuevoMecanicoId),
      });
      
      // Registrar en bitácora
      await strapiPost('/api/bitacoras', {
        descripcion: `Orden reasignada de ${mecanicoAnterior} a ${nuevoMecanico?.nombre} ${nuevoMecanico?.apellido}. Motivo: ${motivo}`,
        tipo: 'reasignacion',
        orden_de_trabajo: orden.id,
      });
      
      successMessage = `Orden reasignada exitosamente a ${nuevoMecanico?.nombre} ${nuevoMecanico?.apellido}`;
      
      // Recargar orden
      const response = await strapiGet(`/api/orden-de-trabajos/${ordenId}?populate[vehiculo][populate][cliente]=*&populate[mecanico]=*&populate[zona]=*`);
      orden = response.data;
    }
  } catch (e: any) {
    error = e.message;
  }
}

// Obtener carga de trabajo de cada mecánico
const getCargaTrabajo = async (mecanicoId: number) => {
  try {
    const response = await strapiGet(`/api/orden-de-trabajos?filters[mecanico][id][$eq]=${mecanicoId}&filters[estado][$in][0]=en_diagnostico&filters[estado][$in][1]=en_reparacion&pagination[pageSize]=100`);
    return response.data?.length || 0;
  } catch {
    return 0;
  }
};

// Cargar carga de trabajo para cada mecánico
const mecanicosConCarga = await Promise.all(
  mecanicos.map(async (mec: any) => ({
    ...mec,
    cargaTrabajo: await getCargaTrabajo(mec.id)
  }))
);
---

<Layout title="Reasignar Orden">
  <div class="flex min-h-screen bg-background-light dark:bg-background-dark">
    <Sidebar role="encargado" currentPath="/encargado/reasignar_orden" />
    
    <main class="flex-1 p-8">
      <div class="max-w-4xl mx-auto">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Reasignar Orden</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">Cambiar el mecánico asignado a una orden de trabajo</p>
        </div>

        {!ordenId && (
          <div class="card p-8">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Buscar Orden</h2>
            <form class="flex gap-4">
              <input 
                type="text" 
                name="orden"
                placeholder="ID de la orden..."
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
              <button type="submit" class="btn-primary">Buscar</button>
            </form>
          </div>
        )}

        {error && (
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            ⚠️ {error}
          </div>
        )}

        {successMessage && (
          <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
            ✓ {successMessage}
          </div>
        )}

        {orden && (
          <>
            <!-- Info de la orden -->
            <div class="card p-6 mb-6">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">
                  Orden #{orden.id}
                </h2>
                <span class={`px-3 py-1 rounded-full text-sm font-bold ${
                  orden.estado === 'en_reparacion' ? 'bg-orange-100 text-orange-800' :
                  orden.estado === 'en_diagnostico' ? 'bg-yellow-100 text-yellow-800' :
                  'bg-gray-100 text-gray-800'
                }`}>
                  {orden.estado?.replace('_', ' ').toUpperCase()}
                </span>
              </div>
              
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <p class="text-gray-500">Vehículo</p>
                  <p class="font-bold text-gray-800 dark:text-white">{orden.vehiculo?.patente}</p>
                  <p class="text-gray-600">{orden.vehiculo?.marca} {orden.vehiculo?.modelo}</p>
                </div>
                <div>
                  <p class="text-gray-500">Cliente</p>
                  <p class="font-bold text-gray-800 dark:text-white">
                    {orden.vehiculo?.cliente?.nombre} {orden.vehiculo?.cliente?.apellido}
                  </p>
                </div>
                <div>
                  <p class="text-gray-500">Zona</p>
                  <p class="font-bold text-gray-800 dark:text-white">{orden.zona?.nombre || 'Sin asignar'}</p>
                </div>
                <div>
                  <p class="text-gray-500">Mecánico Actual</p>
                  <p class="font-bold text-gray-800 dark:text-white">
                    {orden.mecanico ? `${orden.mecanico.nombre} ${orden.mecanico.apellido}` : 'Sin asignar'}
                  </p>
                </div>
              </div>
            </div>

            <!-- Formulario de reasignación -->
            <form method="POST" class="card p-6">
              <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-6">
                Seleccionar Nuevo Mecánico
              </h2>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                {mecanicosConCarga.map((mec: any) => {
                  const esActual = orden.mecanico?.id === mec.id;
                  return (
                    <label class={`flex items-center p-4 rounded-lg border-2 cursor-pointer transition-all ${
                      esActual 
                        ? 'border-gray-300 bg-gray-100 opacity-60 cursor-not-allowed' 
                        : 'border-gray-200 hover:border-blue-300 hover:bg-blue-50'
                    }`}>
                      <input 
                        type="radio" 
                        name="mecanico_id"
                        value={mec.documentId}
                        disabled={esActual}
                        class="w-5 h-5 text-blue-600 mr-4"
                      />
                      <div class="flex-1">
                        <p class="font-bold text-gray-800 dark:text-white">
                          {mec.nombre} {mec.apellido}
                          {esActual && <span class="text-xs ml-2 text-gray-500">(actual)</span>}
                        </p>
                        <p class="text-sm text-gray-600">{mec.especialidad || 'General'}</p>
                      </div>
                      <div class="text-right">
                        <span class={`px-2 py-1 rounded-full text-xs font-bold ${
                          mec.cargaTrabajo === 0 ? 'bg-green-100 text-green-800' :
                          mec.cargaTrabajo <= 2 ? 'bg-yellow-100 text-yellow-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {mec.cargaTrabajo} orden{mec.cargaTrabajo !== 1 ? 'es' : ''}
                        </span>
                      </div>
                    </label>
                  );
                })}
              </div>

              <div class="mb-6">
                <label class="block text-gray-700 dark:text-gray-300 font-bold mb-2">
                  Motivo de la reasignación *
                </label>
                <select 
                  name="motivo" 
                  required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-2"
                >
                  <option value="">Seleccione un motivo...</option>
                  <option value="Sobrecarga de trabajo">Sobrecarga de trabajo</option>
                  <option value="Ausencia del mecánico">Ausencia del mecánico</option>
                  <option value="Cambio de especialidad requerida">Cambio de especialidad requerida</option>
                  <option value="Solicitud del cliente">Solicitud del cliente</option>
                  <option value="Redistribución de tareas">Redistribución de tareas</option>
                  <option value="Otro">Otro motivo</option>
                </select>
              </div>

              <div class="flex gap-4">
                <button type="submit" class="btn-primary flex-1">
                  <span class="material-symbols-outlined mr-2">swap_horiz</span>
                  Confirmar Reasignación
                </button>
                <a href="/encargado/trabajos_en_curso" class="btn-secondary">
                  Cancelar
                </a>
              </div>
            </form>
          </>
        )}
      </div>
    </main>
  </div>
</Layout>
