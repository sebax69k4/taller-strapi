---
export const prerender = false;
import DashboardLayout from '../../../layouts/DashboardLayout.astro';

let usuarios: any[] = [];
let error = '';
const successMessage = Astro.url.searchParams.get('success');

// Obtener usuarios de Strapi (users-permissions)
try {
  const response = await fetch('http://localhost:1337/api/users?populate=role', {
    headers: {
      'Content-Type': 'application/json',
    },
  });
  
  if (response.ok) {
    usuarios = await response.json();
  } else {
    error = 'Error al cargar usuarios. Verifique los permisos de la API.';
  }
} catch (e: any) {
  error = e.message;
}

// Crear usuario
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    
    if (action === 'create') {
      const response = await fetch('http://localhost:1337/api/users', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username: formData.get('username'),
          email: formData.get('email'),
          password: formData.get('password'),
          role: parseInt(formData.get('role') as string),
          confirmed: true,
          blocked: false,
        }),
      });
      
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error?.message || 'Error al crear usuario');
      }
      
      return Astro.redirect('/admin/usuarios?success=created');
    } else if (action === 'delete') {
      const id = formData.get('id');
      const response = await fetch(`http://localhost:1337/api/users/${id}`, {
        method: 'DELETE',
      });
      
      if (!response.ok) {
        throw new Error('Error al eliminar usuario');
      }
      
      return Astro.redirect('/admin/usuarios?success=deleted');
    } else if (action === 'toggle_block') {
      const id = formData.get('id');
      const blocked = formData.get('blocked') === 'true';
      
      const response = await fetch(`http://localhost:1337/api/users/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ blocked: !blocked }),
      });
      
      if (!response.ok) {
        throw new Error('Error al actualizar usuario');
      }
      
      return Astro.redirect('/admin/usuarios?success=updated');
    }
  } catch (e: any) {
    error = e.message;
  }
}

// Obtener roles disponibles
let roles: any[] = [];
try {
  const response = await fetch('http://localhost:1337/api/users-permissions/roles');
  if (response.ok) {
    const data = await response.json();
    roles = data.roles || [];
  }
} catch (e) {
  // Roles por defecto si falla
  roles = [
    { id: 1, name: 'Authenticated' },
    { id: 2, name: 'Public' },
  ];
}

const getRoleName = (user: any) => {
  if (user.role?.name) return user.role.name;
  return 'Sin rol';
};

const getRoleColor = (roleName: string) => {
  switch (roleName.toLowerCase()) {
    case 'admin': return 'bg-red-100 text-red-800';
    case 'encargado': return 'bg-purple-100 text-purple-800';
    case 'mecanico': return 'bg-blue-100 text-blue-800';
    case 'recepcionista': return 'bg-green-100 text-green-800';
    default: return 'bg-gray-100 text-gray-800';
  }
};
---

<DashboardLayout title="Gesti√≥n de Usuarios" role="admin" currentPath="/admin/usuarios">
  <div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <a href="/admin" class="text-gray-600 hover:text-blue-600 mr-4 transition-colors">
          ‚Üê Volver
        </a>
        <h1 class="text-3xl font-bold text-gray-800">Gesti√≥n de Usuarios</h1>
      </div>
    </div>

    {successMessage && (
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        {successMessage === 'created' ? '‚úì Usuario creado exitosamente' : 
         successMessage === 'updated' ? '‚úì Usuario actualizado exitosamente' :
         successMessage === 'deleted' ? '‚úì Usuario eliminado exitosamente' : '‚úì Operaci√≥n exitosa'}
      </div>
    )}

    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        {error}
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Formulario de nuevo usuario -->
      <div class="lg:col-span-1">
        <div class="card p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Nuevo Usuario</h2>
          <form method="POST" class="space-y-4">
            <input type="hidden" name="action" value="create" />
            
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Usuario *</label>
              <input
                type="text"
                name="username"
                required
                placeholder="nombre.usuario"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Email *</label>
              <input
                type="email"
                name="email"
                required
                placeholder="usuario@taller.cl"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Contrase√±a *</label>
              <input
                type="password"
                name="password"
                required
                minlength="6"
                placeholder="M√≠nimo 6 caracteres"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Rol *</label>
              <select
                name="role"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Seleccione rol...</option>
                {roles.map((rol: any) => (
                  <option value={rol.id}>{rol.name}</option>
                ))}
              </select>
            </div>

            <button type="submit" class="btn-primary w-full">
              + Crear Usuario
            </button>
          </form>
        </div>

        <!-- Info de roles -->
        <div class="card p-6 mt-4">
          <h3 class="font-bold text-gray-800 mb-3">Roles del Sistema</h3>
          <div class="space-y-2 text-sm">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-red-500"></span>
              <span><strong>Admin:</strong> Acceso total</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-purple-500"></span>
              <span><strong>Encargado:</strong> Gesti√≥n de taller</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-blue-500"></span>
              <span><strong>Mec√°nico:</strong> √ìrdenes asignadas</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-green-500"></span>
              <span><strong>Recepcionista:</strong> Atenci√≥n cliente</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de usuarios -->
      <div class="lg:col-span-2">
        <div class="card p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Usuarios del Sistema ({usuarios.length})</h2>
          
          {usuarios.length === 0 ? (
            <div class="text-center py-12 text-gray-500">
              <span class="material-symbols-outlined text-6xl mb-4 block">group</span>
              <p>No hay usuarios registrados</p>
            </div>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="text-left px-4 py-3 font-bold text-gray-700">Usuario</th>
                    <th class="text-left px-4 py-3 font-bold text-gray-700">Email</th>
                    <th class="text-center px-4 py-3 font-bold text-gray-700">Rol</th>
                    <th class="text-center px-4 py-3 font-bold text-gray-700">Estado</th>
                    <th class="text-center px-4 py-3 font-bold text-gray-700">Acciones</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                  {usuarios.map((user: any) => (
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-blue-600 font-bold">
                              {user.username?.charAt(0).toUpperCase()}
                            </span>
                          </div>
                          <span class="font-medium text-gray-800">{user.username}</span>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-gray-600">{user.email}</td>
                      <td class="px-4 py-3 text-center">
                        <span class={`px-2 py-1 rounded-full text-xs font-bold ${getRoleColor(getRoleName(user))}`}>
                          {getRoleName(user)}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center">
                        {user.blocked ? (
                          <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold">
                            Bloqueado
                          </span>
                        ) : (
                          <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold">
                            Activo
                          </span>
                        )}
                      </td>
                      <td class="px-4 py-3">
                        <div class="flex items-center justify-center gap-2">
                          <form method="POST" class="inline">
                            <input type="hidden" name="action" value="toggle_block" />
                            <input type="hidden" name="id" value={user.id} />
                            <input type="hidden" name="blocked" value={user.blocked} />
                            <button 
                              type="submit" 
                              class={`text-sm px-2 py-1 rounded ${user.blocked ? 'text-green-600 hover:bg-green-50' : 'text-yellow-600 hover:bg-yellow-50'}`}
                              title={user.blocked ? 'Desbloquear' : 'Bloquear'}
                            >
                              {user.blocked ? 'üîì' : 'üîí'}
                            </button>
                          </form>
                          <form method="POST" class="inline" onsubmit="return confirm('¬øEliminar este usuario?')">
                            <input type="hidden" name="action" value="delete" />
                            <input type="hidden" name="id" value={user.id} />
                            <button 
                              type="submit" 
                              class="text-red-600 hover:bg-red-50 text-sm px-2 py-1 rounded"
                              title="Eliminar"
                            >
                              üóëÔ∏è
                            </button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
