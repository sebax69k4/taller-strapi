---
export const prerender = false;
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { strapiGet, strapiPost, strapiDelete } from '../../../lib/strapi';

let servicios: any[] = [];
let error = '';
const successMessage = Astro.url.searchParams.get('success');

try {
  const response = await strapiGet('/api/servicios?pagination[pageSize]=100&sort=nombre:asc');
  servicios = response.data || [];
} catch (e: any) {
  // Si no existe el content-type, mostrar mensaje
  if (e.message.includes('404') || e.message.includes('not found')) {
    error = 'El content-type "servicio" no existe en Strapi. Por favor cr√©alo primero.';
  } else {
    error = e.message;
  }
}

// Crear servicio inline
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action');
    
    if (action === 'create') {
      await strapiPost('/api/servicios', {
        nombre: formData.get('nombre'),
        descripcion: formData.get('descripcion') || null,
        precio_base: parseFloat(formData.get('precio_base') as string) || 0,
        tiempo_estimado: parseInt(formData.get('tiempo_estimado') as string) || 60,
        categoria: formData.get('categoria') || 'otros',
        activo: true,
      });
      return Astro.redirect('/admin/servicios?success=created');
    } else if (action === 'delete') {
      const id = formData.get('id');
      await strapiDelete(`/api/servicios/${id}`);
      return Astro.redirect('/admin/servicios?success=deleted');
    }
  } catch (e: any) {
    error = e.message;
  }
}

const categorias = ['mantencion', 'reparacion', 'diagnostico', 'pintura', 'electrico', 'neumaticos', 'otros'];
---

<DashboardLayout title="Gesti√≥n de Servicios" role="admin" currentPath="/admin/servicios">
  <div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <a href="/admin" class="text-gray-600 hover:text-blue-600 mr-4 transition-colors">
          ‚Üê Volver
        </a>
        <h1 class="text-3xl font-bold text-gray-800">Gesti√≥n de Servicios</h1>
      </div>
    </div>

    {successMessage && (
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        {successMessage === 'created' ? '‚úì Servicio creado exitosamente' : 
         successMessage === 'updated' ? '‚úì Servicio actualizado exitosamente' :
         successMessage === 'deleted' ? '‚úì Servicio eliminado exitosamente' : '‚úì Operaci√≥n exitosa'}
      </div>
    )}

    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        {error}
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Formulario de nuevo servicio -->
      <div class="lg:col-span-1">
        <div class="card p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Nuevo Servicio</h2>
          <form method="POST" class="space-y-4">
            <input type="hidden" name="action" value="create" />
            
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Nombre *</label>
              <input
                type="text"
                name="nombre"
                required
                placeholder="Ej: Cambio de aceite"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Categor√≠a</label>
              <select
                name="categoria"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Seleccione...</option>
                {categorias.map(cat => (
                  <option value={cat}>{cat}</option>
                ))}
              </select>
            </div>

            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Precio Base *</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                <input
                  type="number"
                  name="precio_base"
                  required
                  min="0"
                  placeholder="0"
                  class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>

            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Tiempo Estimado (min)</label>
              <input
                type="number"
                name="tiempo_estimado"
                min="15"
                step="15"
                value="60"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2">Descripci√≥n</label>
              <textarea
                name="descripcion"
                rows="3"
                placeholder="Descripci√≥n del servicio..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              ></textarea>
            </div>

            <button type="submit" class="btn-primary w-full">
              + Crear Servicio
            </button>
          </form>
        </div>
      </div>

      <!-- Lista de servicios -->
      <div class="lg:col-span-2">
        <div class="card p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Servicios Existentes ({servicios.length})</h2>
          
          {servicios.length === 0 ? (
            <div class="text-center py-12 text-gray-500">
              <span class="material-symbols-outlined text-6xl mb-4 block">home_repair_service</span>
              <p>No hay servicios registrados</p>
            </div>
          ) : (
            <div class="space-y-3">
              {servicios.map((servicio: any) => (
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors">
                  <div class="flex-1">
                    <div class="flex items-center gap-3">
                      <h3 class="font-bold text-gray-800">{servicio.nombre}</h3>
                      {servicio.categoria && (
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">
                          {servicio.categoria}
                        </span>
                      )}
                    </div>
                    <p class="text-sm text-gray-600 mt-1">{servicio.descripcion || 'Sin descripci√≥n'}</p>
                    <div class="flex gap-4 mt-2 text-sm">
                      <span class="text-green-600 font-bold">
                        ${(servicio.precio_base || 0).toLocaleString('es-CL')}
                      </span>
                      <span class="text-gray-500">
                        ‚è±Ô∏è {servicio.tiempo_estimado || 60} min
                      </span>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <a 
                      href={`/admin/servicios/editar/${servicio.documentId}`}
                      class="text-blue-600 hover:text-blue-800 p-2"
                    >
                      ‚úèÔ∏è
                    </a>
                    <form method="POST" class="inline" onsubmit="return confirm('¬øEliminar este servicio?')">
                      <input type="hidden" name="action" value="delete" />
                      <input type="hidden" name="id" value={servicio.documentId} />
                      <button type="submit" class="text-red-600 hover:text-red-800 p-2">
                        üóëÔ∏è
                      </button>
                    </form>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
