---
export const prerender = false;

import DashboardLayout from '../../layouts/DashboardLayout.astro';
import StatsCard from '../../components/ui/StatsCard.astro';
import QuickStats from '../../components/ui/QuickStats.astro';
import Badge from '../../components/ui/Badge.astro';
import { strapiGet } from '../../lib/strapi';

// Verificar sesión
const userRole = Astro.cookies.get('user_role')?.value;
const userName = Astro.cookies.get('user_name')?.value || 'Administrador';

if (!userRole || userRole !== 'admin') {
  return Astro.redirect('/login');
}

// Obtener estadísticas
let stats = {
  clientes: 0,
  vehiculos: 0,
  mecanicos: 0,
  repuestos: 0,
  ordenes: {
    total: 0,
    ingresado: 0,
    en_diagnostico: 0,
    en_reparacion: 0,
    finalizado: 0,
    facturado: 0,
    entregado: 0
  },
  stockBajo: 0
};

let recentOrders: any[] = [];
let recentClients: any[] = [];
let error = '';

try {
  const [
    clientesRes,
    vehiculosRes,
    mecanicosRes,
    repuestosRes,
    ordenesTotalRes,
    ordenesIngresadoRes,
    ordenesDiagRes,
    ordenesRepRes,
    ordenesFinRes,
    ordenesFactRes,
    ordenesEntRes,
    stockBajoRes,
    recentOrdersRes,
    recentClientsRes
  ] = await Promise.all([
    strapiGet('/api/clientes?pagination[pageSize]=1'),
    strapiGet('/api/vehiculos?pagination[pageSize]=1'),
    strapiGet('/api/mecenicos?pagination[pageSize]=1'),
    strapiGet('/api/repuestos?pagination[pageSize]=1'),
    strapiGet('/api/orden-de-trabajos?pagination[pageSize]=1'),
    strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=ingresado&pagination[pageSize]=1'),
    strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=en_diagnostico&pagination[pageSize]=1'),
    strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=en_reparacion&pagination[pageSize]=1'),
    strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=finalizado&pagination[pageSize]=1'),
    strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=facturado&pagination[pageSize]=1'),
    strapiGet('/api/orden-de-trabajos?filters[estado][$eq]=entregado&pagination[pageSize]=1'),
    strapiGet('/api/repuestos?filters[stock][$lt]=5&pagination[pageSize]=1'),
    strapiGet('/api/orden-de-trabajos?sort=createdAt:desc&pagination[pageSize]=5&populate[vehiculo][populate]=cliente'),
    strapiGet('/api/clientes?sort=createdAt:desc&pagination[pageSize]=5')
  ]);

  stats.clientes = clientesRes.meta?.pagination?.total || 0;
  stats.vehiculos = vehiculosRes.meta?.pagination?.total || 0;
  stats.mecanicos = mecanicosRes.meta?.pagination?.total || 0;
  stats.repuestos = repuestosRes.meta?.pagination?.total || 0;
  stats.ordenes.total = ordenesTotalRes.meta?.pagination?.total || 0;
  stats.ordenes.ingresado = ordenesIngresadoRes.meta?.pagination?.total || 0;
  stats.ordenes.en_diagnostico = ordenesDiagRes.meta?.pagination?.total || 0;
  stats.ordenes.en_reparacion = ordenesRepRes.meta?.pagination?.total || 0;
  stats.ordenes.finalizado = ordenesFinRes.meta?.pagination?.total || 0;
  stats.ordenes.facturado = ordenesFactRes.meta?.pagination?.total || 0;
  stats.ordenes.entregado = ordenesEntRes.meta?.pagination?.total || 0;
  stats.stockBajo = stockBajoRes.meta?.pagination?.total || 0;
  
  recentOrders = recentOrdersRes.data || [];
  recentClients = recentClientsRes.data || [];
} catch (e: any) {
  error = e.message;
}

const ordenesActivas = stats.ordenes.ingresado + stats.ordenes.en_diagnostico + stats.ordenes.en_reparacion;

const quickStatsItems = [
  { label: 'Ingresadas', value: stats.ordenes.ingresado, icon: 'inbox', color: 'info' as const },
  { label: 'En Diagnóstico', value: stats.ordenes.en_diagnostico, icon: 'search', color: 'warning' as const },
  { label: 'En Reparación', value: stats.ordenes.en_reparacion, icon: 'build', color: 'warning' as const },
  { label: 'Finalizadas', value: stats.ordenes.finalizado, icon: 'check_circle', color: 'success' as const },
  { label: 'Facturadas', value: stats.ordenes.facturado, icon: 'receipt', color: 'primary' as const },
];

const getEstadoBadge = (estado: string) => {
  const map: Record<string, 'info' | 'warning' | 'success' | 'purple' | 'default'> = {
    ingresado: 'info',
    en_diagnostico: 'warning',
    en_reparacion: 'warning',
    finalizado: 'success',
    facturado: 'purple',
    entregado: 'default'
  };
  return map[estado] || 'default';
};

const formatEstado = (estado: string) => {
  const estados: Record<string, string> = {
    ingresado: 'Ingresado',
    en_diagnostico: 'Diagnóstico',
    en_reparacion: 'Reparación',
    finalizado: 'Finalizado',
    facturado: 'Facturado',
    entregado: 'Entregado'
  };
  return estados[estado] || estado;
};
---

<DashboardLayout title="Panel de Administración" role="admin" currentPath="/admin" userName={userName}>
  {error && (
    <div class="p-4 text-sm text-red-700 bg-red-50 rounded-lg border border-red-100 flex items-center gap-2">
      <span class="material-symbols-outlined">error</span>
      <span>Error: {error}</span>
    </div>
  )}

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Panel de Administración</h1>
      <p class="text-gray-500 dark:text-gray-400 mt-1">Bienvenido, {userName}. Aquí tienes el resumen del taller.</p>
    </div>
    <div class="flex gap-3">
      <a href="/admin/ordenes/crear" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
        <span class="material-symbols-outlined text-lg">add</span>
        Nueva Orden
      </a>
    </div>
  </div>

  <!-- Quick Stats Bar -->
  <QuickStats stats={quickStatsItems} />

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <StatsCard 
      title="Órdenes Activas" 
      value={ordenesActivas} 
      icon="assignment"
      color="primary"
      href="/admin/ordenes?estado=en_reparacion"
      subtitle="En proceso actualmente"
    />
    <StatsCard 
      title="Clientes" 
      value={stats.clientes} 
      icon="people"
      color="info"
      href="/admin/clientes"
    />
    <StatsCard 
      title="Vehículos" 
      value={stats.vehiculos} 
      icon="directions_car"
      color="success"
      href="/admin/vehiculos"
    />
    <StatsCard 
      title="Stock Bajo" 
      value={stats.stockBajo} 
      icon="inventory_2"
      color={stats.stockBajo > 0 ? 'error' : 'success'}
      href="/admin/repuestos?stockBajo=true"
      subtitle={stats.stockBajo > 0 ? 'Requieren atención' : 'Todo en orden'}
    />
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Recent Orders -->
    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
      <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
          <span class="material-symbols-outlined text-primary-600">assignment</span>
          Órdenes Recientes
        </h2>
        <a href="/admin/ordenes" class="text-sm text-primary-600 hover:text-primary-700 font-medium">Ver todas →</a>
      </div>
      <div class="divide-y divide-gray-100 dark:divide-gray-700">
        {recentOrders.length === 0 ? (
          <div class="p-8 text-center text-gray-500">
            <span class="material-symbols-outlined text-4xl mb-2 block opacity-50">inbox</span>
            <p>No hay órdenes recientes</p>
          </div>
        ) : (
          recentOrders.map((orden: any) => (
            <a href={`/admin/ordenes/ver/${orden.documentId}`} class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
              <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
                  <span class="material-symbols-outlined text-primary-600 dark:text-primary-400">directions_car</span>
                </div>
                <div>
                  <p class="font-medium text-gray-900 dark:text-white">
                    {orden.vehiculo?.patente || 'Sin patente'}
                  </p>
                  <p class="text-sm text-gray-500 dark:text-gray-400">
                    {orden.vehiculo?.cliente?.nombre} {orden.vehiculo?.cliente?.apellido}
                  </p>
                </div>
              </div>
              <Badge variant={getEstadoBadge(orden.estado)} size="sm">
                {formatEstado(orden.estado)}
              </Badge>
            </a>
          ))
        )}
      </div>
    </div>

    <!-- Quick Actions & Recent Clients -->
    <div class="space-y-6">
      <!-- Quick Actions -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-primary-600">bolt</span>
          Acciones Rápidas
        </h2>
        <div class="grid grid-cols-2 gap-3">
          <a href="/admin/clientes/crear" class="flex flex-col items-center gap-2 p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors">
            <span class="material-symbols-outlined text-2xl">person_add</span>
            <span class="text-xs font-medium">Nuevo Cliente</span>
          </a>
          <a href="/admin/vehiculos/crear" class="flex flex-col items-center gap-2 p-4 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 hover:bg-green-100 dark:hover:bg-green-900/40 transition-colors">
            <span class="material-symbols-outlined text-2xl">directions_car</span>
            <span class="text-xs font-medium">Nuevo Vehículo</span>
          </a>
          <a href="/admin/repuestos/crear" class="flex flex-col items-center gap-2 p-4 rounded-lg bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400 hover:bg-orange-100 dark:hover:bg-orange-900/40 transition-colors">
            <span class="material-symbols-outlined text-2xl">inventory_2</span>
            <span class="text-xs font-medium">Nuevo Repuesto</span>
          </a>
          <a href="/admin/mecanicos/crear" class="flex flex-col items-center gap-2 p-4 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-400 hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-colors">
            <span class="material-symbols-outlined text-2xl">engineering</span>
            <span class="text-xs font-medium">Nuevo Mecánico</span>
          </a>
        </div>
      </div>

      <!-- Recent Clients -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
          <h3 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-blue-600">people</span>
            Clientes Recientes
          </h3>
          <a href="/admin/clientes" class="text-xs text-primary-600 hover:text-primary-700">Ver todos</a>
        </div>
        <div class="divide-y divide-gray-100 dark:divide-gray-700">
          {recentClients.length === 0 ? (
            <div class="p-6 text-center text-gray-500 text-sm">No hay clientes</div>
          ) : (
            recentClients.slice(0, 4).map((cliente: any) => (
              <a href={`/admin/clientes/ver/${cliente.documentId}`} class="flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center text-white text-xs font-medium">
                  {(cliente.nombre?.[0] || 'C').toUpperCase()}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                    {cliente.nombre} {cliente.apellido}
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{cliente.email || cliente.telefono || '-'}</p>
                </div>
              </a>
            ))
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- Module Cards -->
  <div class="mt-8">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Módulos del Sistema</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      <a href="/admin/clientes" class="group p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-blue-500 hover:shadow-lg transition-all">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">people</span>
          </div>
          <div>
            <p class="font-medium text-gray-900 dark:text-white">Clientes</p>
            <p class="text-xs text-gray-500">{stats.clientes} registrados</p>
          </div>
        </div>
      </a>
      
      <a href="/admin/vehiculos" class="group p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-green-500 hover:shadow-lg transition-all">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center group-hover:bg-green-600 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">directions_car</span>
          </div>
          <div>
            <p class="font-medium text-gray-900 dark:text-white">Vehículos</p>
            <p class="text-xs text-gray-500">{stats.vehiculos} registrados</p>
          </div>
        </div>
      </a>
      
      <a href="/admin/mecanicos" class="group p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-purple-500 hover:shadow-lg transition-all">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">engineering</span>
          </div>
          <div>
            <p class="font-medium text-gray-900 dark:text-white">Mecánicos</p>
            <p class="text-xs text-gray-500">{stats.mecanicos} activos</p>
          </div>
        </div>
      </a>
      
      <a href="/admin/repuestos" class="group p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-orange-500 hover:shadow-lg transition-all">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center group-hover:bg-orange-600 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">inventory_2</span>
          </div>
          <div>
            <p class="font-medium text-gray-900 dark:text-white">Repuestos</p>
            <p class="text-xs text-gray-500">{stats.repuestos} en stock</p>
          </div>
        </div>
      </a>
      
      <a href="/admin/ordenes" class="group p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-red-500 hover:shadow-lg transition-all">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">assignment</span>
          </div>
          <div>
            <p class="font-medium text-gray-900 dark:text-white">Órdenes</p>
            <p class="text-xs text-gray-500">{stats.ordenes.total} totales</p>
          </div>
        </div>
      </a>
      
      <a href="/admin/zonas" class="group p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-yellow-500 hover:shadow-lg transition-all">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 flex items-center justify-center group-hover:bg-yellow-600 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">map</span>
          </div>
          <div>
            <p class="font-medium text-gray-900 dark:text-white">Zonas</p>
            <p class="text-xs text-gray-500">Áreas de trabajo</p>
          </div>
        </div>
      </a>
      
      <a href="/admin/servicios" class="group p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-teal-500 hover:shadow-lg transition-all">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-teal-100 dark:bg-teal-900/30 text-teal-600 flex items-center justify-center group-hover:bg-teal-600 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">build</span>
          </div>
          <div>
            <p class="font-medium text-gray-900 dark:text-white">Servicios</p>
            <p class="text-xs text-gray-500">Catálogo</p>
          </div>
        </div>
      </a>
      
      <a href="/admin/usuarios" class="group p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 hover:border-indigo-500 hover:shadow-lg transition-all">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-colors">
            <span class="material-symbols-outlined">manage_accounts</span>
          </div>
          <div>
            <p class="font-medium text-gray-900 dark:text-white">Usuarios</p>
            <p class="text-xs text-gray-500">Sistema</p>
          </div>
        </div>
      </a>
    </div>
  </div>
</DashboardLayout>
