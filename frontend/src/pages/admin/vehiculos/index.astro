---
export const prerender = false;
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { strapiGet } from '../../../lib/strapi';

let vehiculos: any[] = [];
let error = '';
const successMessage = Astro.url.searchParams.get('success');

try {
  const response = await strapiGet('/api/vehiculos?populate[cliente]=*&pagination[pageSize]=200&sort=patente:asc');
  vehiculos = response.data || [];
} catch (e: any) {
  error = e.message;
}
---

<DashboardLayout title="Gesti√≥n de Veh√≠culos" role="admin" currentPath="/admin/vehiculos">
  <div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <a href="/admin" class="text-gray-600 hover:text-blue-600 mr-4 transition-colors">
          ‚Üê Volver
        </a>
        <h1 class="text-3xl font-bold text-gray-800">Gesti√≥n de Veh√≠culos</h1>
      </div>
      <a href="/admin/vehiculos/crear" class="btn-primary">
        + Nuevo Veh√≠culo
      </a>
    </div>

    {successMessage && (
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        {successMessage === 'created' ? '‚úì Veh√≠culo creado exitosamente' : 
         successMessage === 'updated' ? '‚úì Veh√≠culo actualizado exitosamente' :
         successMessage === 'deleted' ? '‚úì Veh√≠culo eliminado exitosamente' : '‚úì Operaci√≥n exitosa'}
      </div>
    )}

    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        Error: {error}
      </div>
    )}

    <!-- Buscador -->
    <div class="card p-4 mb-6">
      <input 
        type="text" 
        id="searchInput"
        placeholder="Buscar por patente, marca, modelo o propietario..."
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
      />
    </div>

    <!-- Lista de veh√≠culos -->
    <div class="card overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-left px-6 py-4 font-bold text-gray-700">Patente</th>
            <th class="text-left px-6 py-4 font-bold text-gray-700">Marca / Modelo</th>
            <th class="text-left px-6 py-4 font-bold text-gray-700">A√±o</th>
            <th class="text-left px-6 py-4 font-bold text-gray-700">Propietario</th>
            <th class="text-left px-6 py-4 font-bold text-gray-700">Kilometraje</th>
            <th class="text-center px-6 py-4 font-bold text-gray-700">Acciones</th>
          </tr>
        </thead>
        <tbody id="vehiculosTable" class="divide-y divide-gray-100">
          {vehiculos.length === 0 && (
            <tr>
              <td colspan="6" class="text-center py-8 text-gray-500">
                No hay veh√≠culos registrados
              </td>
            </tr>
          )}
          {vehiculos.map((veh: any) => (
            <tr class="hover:bg-gray-50 transition-colors vehiculo-row" 
                data-search={`${veh.patente} ${veh.marca} ${veh.modelo} ${veh.cliente?.nombre || ''} ${veh.cliente?.apellido || ''}`.toLowerCase()}>
              <td class="px-6 py-4">
                <span class="font-bold text-lg text-gray-800 bg-gray-100 px-2 py-1 rounded">
                  {veh.patente}
                </span>
              </td>
              <td class="px-6 py-4">
                <div class="font-medium text-gray-800">{veh.marca}</div>
                <div class="text-sm text-gray-500">{veh.modelo}</div>
              </td>
              <td class="px-6 py-4 text-gray-600">{veh.anio || '-'}</td>
              <td class="px-6 py-4">
                {veh.cliente ? (
                  <div>
                    <div class="font-medium text-gray-800">{veh.cliente.nombre} {veh.cliente.apellido}</div>
                    <div class="text-sm text-gray-500">{veh.cliente.telefono || ''}</div>
                  </div>
                ) : (
                  <span class="text-gray-400">Sin asignar</span>
                )}
              </td>
              <td class="px-6 py-4 text-gray-600">
                {veh.kilometraje ? `${veh.kilometraje.toLocaleString('es-CL')} km` : '-'}
              </td>
              <td class="px-6 py-4">
                <div class="flex items-center justify-center gap-2">
                  <a 
                    href={`/admin/vehiculos/editar/${veh.documentId}`}
                    class="text-blue-600 hover:text-blue-800 font-medium text-sm"
                  >
                    ‚úèÔ∏è Editar
                  </a>
                  <button 
                    type="button"
                    class="text-red-600 hover:text-red-800 font-medium text-sm delete-btn"
                    data-id={veh.documentId}
                    data-name={veh.patente}
                  >
                    üóëÔ∏è Eliminar
                  </button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <div class="mt-4 text-gray-500 text-sm">
      Total: <span id="totalCount">{vehiculos.length}</span> veh√≠culos
    </div>
  </div>
</DashboardLayout>

<script>
  // Search functionality
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const rows = document.querySelectorAll('.vehiculo-row');
  const totalCount = document.getElementById('totalCount');

  searchInput?.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    let visible = 0;
    
    rows.forEach(row => {
      const searchData = row.getAttribute('data-search') || '';
      const matches = searchData.includes(query);
      (row as HTMLElement).style.display = matches ? '' : 'none';
      if (matches) visible++;
    });
    
    if (totalCount) totalCount.textContent = visible.toString();
  });

  // Delete functionality
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.target as HTMLButtonElement;
      const id = target.dataset.id;
      const name = target.dataset.name;
      
      if (!confirm(`¬øEst√° seguro de eliminar el veh√≠culo "${name}"?`)) return;
      
      try {
        const response = await fetch(`http://localhost:1337/api/vehiculos/${id}`, {
          method: 'DELETE',
        });
        
        if (!response.ok) throw new Error('Error al eliminar');
        
        window.location.href = '/admin/vehiculos?success=deleted';
      } catch (error) {
        alert('Error al eliminar el veh√≠culo');
      }
    });
  });
</script>
