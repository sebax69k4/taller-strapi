---
export const prerender = false;
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { strapiGet } from '../../../lib/strapi';

let mecanicos: any[] = [];
let error = '';
const successMessage = Astro.url.searchParams.get('success');

try {
  const response = await strapiGet('/api/mecenicos?populate[zona]=*&pagination[pageSize]=100&sort=apellido:asc');
  mecanicos = response.data || [];
} catch (e: any) {
  error = e.message;
}
---

<DashboardLayout title="Gesti√≥n de Mec√°nicos" role="admin" currentPath="/admin/mecanicos">
  <div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <a href="/admin" class="text-gray-600 hover:text-blue-600 mr-4 transition-colors">
          ‚Üê Volver
        </a>
        <h1 class="text-3xl font-bold text-gray-800">Gesti√≥n de Mec√°nicos</h1>
      </div>
      <a href="/admin/mecanicos/crear" class="btn-primary">
        + Nuevo Mec√°nico
      </a>
    </div>

    {successMessage && (
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        {successMessage === 'created' ? '‚úì Mec√°nico creado exitosamente' : 
         successMessage === 'updated' ? '‚úì Mec√°nico actualizado exitosamente' :
         successMessage === 'deleted' ? '‚úì Mec√°nico eliminado exitosamente' : '‚úì Operaci√≥n exitosa'}
      </div>
    )}

    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        Error: {error}
      </div>
    )}

    <!-- Buscador -->
    <div class="card p-4 mb-6">
      <input 
        type="text" 
        id="searchInput"
        placeholder="Buscar por nombre, especialidad o zona..."
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
      />
    </div>

    <!-- Lista de mec√°nicos -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="mecanicosGrid">
      {mecanicos.length === 0 && (
        <div class="col-span-full text-center py-12 text-gray-500">
          No hay mec√°nicos registrados
        </div>
      )}
      {mecanicos.map((mec: any) => (
        <div class="card p-6 mecanico-card" 
             data-search={`${mec.nombre} ${mec.apellido} ${mec.especialidad || ''} ${mec.zona?.nombre || ''}`.toLowerCase()}>
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                <span class="text-xl font-bold text-purple-600">
                  {mec.nombre?.charAt(0)}{mec.apellido?.charAt(0)}
                </span>
              </div>
              <div>
                <h3 class="font-bold text-gray-800">{mec.nombre} {mec.apellido}</h3>
                {mec.especialidad && (
                  <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">
                    {mec.especialidad}
                  </span>
                )}
              </div>
            </div>
            <span class={`w-3 h-3 rounded-full ${mec.disponible !== false ? 'bg-green-500' : 'bg-red-500'}`} 
                  title={mec.disponible !== false ? 'Disponible' : 'No disponible'}></span>
          </div>
          
          <div class="space-y-2 text-sm text-gray-600 mb-4">
            {mec.email && (
              <div class="flex items-center">
                <span class="mr-2">‚úâÔ∏è</span>
                <span>{mec.email}</span>
              </div>
            )}
            {mec.telefono && (
              <div class="flex items-center">
                <span class="mr-2">üì±</span>
                <span>{mec.telefono}</span>
              </div>
            )}
            {mec.zona && (
              <div class="flex items-center">
                <span class="mr-2">üìç</span>
                <span>{mec.zona.nombre}</span>
              </div>
            )}
          </div>
          
          <div class="flex items-center justify-between pt-4 border-t">
            <a 
              href={`/admin/mecanicos/editar/${mec.documentId}`}
              class="text-blue-600 hover:text-blue-800 font-medium text-sm"
            >
              ‚úèÔ∏è Editar
            </a>
            <button 
              type="button"
              class="text-red-600 hover:text-red-800 font-medium text-sm delete-btn"
              data-id={mec.documentId}
              data-name={`${mec.nombre} ${mec.apellido}`}
            >
              üóëÔ∏è Eliminar
            </button>
          </div>
        </div>
      ))}
    </div>

    <div class="mt-4 text-gray-500 text-sm">
      Total: <span id="totalCount">{mecanicos.length}</span> mec√°nicos
    </div>
  </div>
</DashboardLayout>

<script>
  // Search functionality
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const cards = document.querySelectorAll('.mecanico-card');
  const totalCount = document.getElementById('totalCount');

  searchInput?.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    let visible = 0;
    
    cards.forEach(card => {
      const searchData = card.getAttribute('data-search') || '';
      const matches = searchData.includes(query);
      (card as HTMLElement).style.display = matches ? '' : 'none';
      if (matches) visible++;
    });
    
    if (totalCount) totalCount.textContent = visible.toString();
  });

  // Delete functionality
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.target as HTMLButtonElement;
      const id = target.dataset.id;
      const name = target.dataset.name;
      
      if (!confirm(`¬øEst√° seguro de eliminar al mec√°nico "${name}"?`)) return;
      
      try {
        const response = await fetch(`http://localhost:1337/api/mecenicos/${id}`, {
          method: 'DELETE',
        });
        
        if (!response.ok) throw new Error('Error al eliminar');
        
        window.location.href = '/admin/mecanicos?success=deleted';
      } catch (error) {
        alert('Error al eliminar el mec√°nico');
      }
    });
  });
</script>
