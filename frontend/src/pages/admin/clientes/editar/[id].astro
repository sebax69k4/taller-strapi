---
export const prerender = false;
import DashboardLayout from '../../../../layouts/DashboardLayout.astro';
import { getById } from '../../../../lib/crud';

interface Vehiculo {
  patente: string;
  marca: string;
  modelo: string;
}

interface Cliente {
  id: number;
  documentId: string;
  nombre: string;
  apellido: string;
  rut: string;
  email: string;
  telefono?: string;
  vehiculos?: Vehiculo[];
}

const id = Astro.params.id;
let cliente: Cliente | null = null;
let error = '';

if (id) {
  try {
    const response = await getById<Cliente>('clientes', id, { populate: ['vehiculos'] });
    cliente = response.data;
  } catch (e: any) {
    error = e.message;
  }
}
---

<DashboardLayout title={cliente ? 'Editar Cliente' : 'Cliente no encontrado'} role="admin" currentPath="/admin/clientes">
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="flex items-center mb-6">
      <a href="/admin/clientes" class="text-gray-600 hover:text-blue-600 mr-4 transition-colors">
        ← Volver
      </a>
      <h1 class="text-3xl font-bold text-gray-800">Editar Cliente</h1>
    </div>

    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        Error: {error}
      </div>
    )}

    {cliente && (
      <>
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
        <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>

        <form id="clienteForm" class="card p-8 mb-4">
          <input type="hidden" name="id" value={cliente.id} />
          
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="nombre">
              Nombre *
            </label>
            <input
              type="text"
              id="nombre"
              name="nombre"
              required
              value={cliente.nombre}
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
            />
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="apellido">
              Apellido *
            </label>
            <input
              type="text"
              id="apellido"
              name="apellido"
              required
              value={cliente.apellido}
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
            />
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="rut">
              RUT *
            </label>
            <input
              type="text"
              id="rut"
              name="rut"
              required
              value={cliente.rut}
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
            />
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
              Email *
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              value={cliente.email}
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
            />
          </div>

          <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="telefono">
              Teléfono
            </label>
            <input
              type="tel"
              id="telefono"
              name="telefono"
              value={cliente.telefono || ''}
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
            />
          </div>

          <div class="flex items-center justify-between pt-4">
            <button
              type="submit"
              class="btn-primary"
            >
              Actualizar Cliente
            </button>
            <a
              href="/admin/clientes"
              class="text-gray-600 hover:text-gray-800 font-medium"
            >
              Cancelar
            </a>
          </div>
        </form>

        {cliente.vehiculos && cliente.vehiculos.length > 0 && (
          <div class="card p-8 mt-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Vehículos del Cliente</h2>
            <ul class="divide-y divide-gray-200">
              {cliente.vehiculos.map((vehiculo: any) => (
                <li class="py-3">
                  <div class="flex justify-between">
                    <span class="font-medium text-gray-800">{vehiculo.patente}</span>
                    <span class="text-gray-600">{vehiculo.marca} {vehiculo.modelo}</span>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        )}
      </>
    )}
  </div>
</DashboardLayout>

<script>
  const form = document.getElementById('clienteForm') as HTMLFormElement;
  const errorDiv = document.getElementById('errorMessage') as HTMLDivElement;
  const successDiv = document.getElementById('successMessage') as HTMLDivElement;

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      
      const formData = new FormData(form);
      const id = formData.get('id');
      const data = {
        nombre: formData.get('nombre'),
        apellido: formData.get('apellido'),
        rut: formData.get('rut'),
        email: formData.get('email'),
        telefono: formData.get('telefono') || null,
      };

      try {
        const response = await fetch(`http://localhost:1337/api/clientes/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ data }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || 'Error al actualizar cliente');
        }

        successDiv.textContent = 'Cliente actualizado exitosamente';
        successDiv.classList.remove('hidden');
        
        setTimeout(() => {
          window.location.href = '/admin/clientes';
        }, 1500);
        
      } catch (error: unknown) {
        errorDiv.textContent = error instanceof Error ? error.message : 'Error desconocido';
        errorDiv.classList.remove('hidden');
      }
    });
  }
</script>
