---
export const prerender = false;
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { strapiGet, strapiPost } from '../../../lib/strapi';

let zonas: any[] = [];
let error = '';
const successMessage = Astro.url.searchParams.get('success');

try {
  const response = await strapiGet('/api/zonas?pagination[pageSize]=50&sort=nombre:asc');
  zonas = response.data || [];
} catch (e: any) {
  error = e.message;
}

// Handle POST (create new zone inline)
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const nombre = formData.get('nombre');
    const descripcion = formData.get('descripcion');
    
    if (nombre) {
      await strapiPost('/api/zonas', { nombre, descripcion });
      return Astro.redirect('/admin/zonas?success=created');
    }
  } catch (e: any) {
    error = e.message;
  }
}
---

<DashboardLayout title="Gesti√≥n de Zonas" role="admin" currentPath="/admin/zonas">
  <div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <a href="/admin" class="text-gray-600 hover:text-blue-600 mr-4 transition-colors">
          ‚Üê Volver
        </a>
        <h1 class="text-3xl font-bold text-gray-800">Gesti√≥n de Zonas de Trabajo</h1>
      </div>
    </div>

    {successMessage && (
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        {successMessage === 'created' ? '‚úì Zona creada exitosamente' : 
         successMessage === 'updated' ? '‚úì Zona actualizada exitosamente' :
         successMessage === 'deleted' ? '‚úì Zona eliminada exitosamente' : '‚úì Operaci√≥n exitosa'}
      </div>
    )}

    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        Error: {error}
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Formulario de nueva zona -->
      <div class="lg:col-span-1">
        <div class="card p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Agregar Nueva Zona</h2>
          <form method="POST" class="space-y-4">
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2" for="nombre">
                Nombre de la Zona *
              </label>
              <input
                type="text"
                id="nombre"
                name="nombre"
                required
                placeholder="Ej: Bah√≠a 1, Zona de Pintura..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              />
            </div>
            <div>
              <label class="block text-gray-700 text-sm font-bold mb-2" for="descripcion">
                Descripci√≥n
              </label>
              <textarea
                id="descripcion"
                name="descripcion"
                rows="3"
                placeholder="Descripci√≥n opcional de la zona..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              ></textarea>
            </div>
            <button type="submit" class="btn-primary w-full">
              + Crear Zona
            </button>
          </form>
        </div>
      </div>

      <!-- Lista de zonas -->
      <div class="lg:col-span-2">
        <div class="card p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Zonas Existentes ({zonas.length})</h2>
          
          {zonas.length === 0 ? (
            <p class="text-gray-500 text-center py-8">No hay zonas registradas</p>
          ) : (
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {zonas.map((zona: any) => (
                <div class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors zona-card">
                  <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold text-gray-800 text-lg">{zona.nombre}</h3>
                    <div class="flex gap-2">
                      <button 
                        type="button"
                        class="text-blue-600 hover:text-blue-800 text-sm edit-btn"
                        data-id={zona.documentId}
                        data-nombre={zona.nombre}
                        data-descripcion={zona.descripcion || ''}
                      >
                        ‚úèÔ∏è
                      </button>
                      <button 
                        type="button"
                        class="text-red-600 hover:text-red-800 text-sm delete-btn"
                        data-id={zona.documentId}
                        data-name={zona.nombre}
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                  {zona.descripcion && (
                    <p class="text-gray-600 text-sm">{zona.descripcion}</p>
                  )}
                  <div class="mt-2 pt-2 border-t border-gray-100">
                    <span class="text-xs text-gray-400">ID: {zona.documentId}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>

    <!-- Modal de edici√≥n -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Editar Zona</h3>
        <form id="editForm" class="space-y-4">
          <input type="hidden" id="editId" />
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2" for="editNombre">
              Nombre de la Zona *
            </label>
            <input
              type="text"
              id="editNombre"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
            />
          </div>
          <div>
            <label class="block text-gray-700 text-sm font-bold mb-2" for="editDescripcion">
              Descripci√≥n
            </label>
            <textarea
              id="editDescripcion"
              rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
            ></textarea>
          </div>
          <div class="flex gap-2 justify-end">
            <button type="button" id="cancelEdit" class="px-4 py-2 text-gray-600 hover:text-gray-800">
              Cancelar
            </button>
            <button type="submit" class="btn-primary">
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</DashboardLayout>

<script>
  const editModal = document.getElementById('editModal') as HTMLDivElement;
  const editForm = document.getElementById('editForm') as HTMLFormElement;
  const editId = document.getElementById('editId') as HTMLInputElement;
  const editNombre = document.getElementById('editNombre') as HTMLInputElement;
  const editDescripcion = document.getElementById('editDescripcion') as HTMLTextAreaElement;
  const cancelEdit = document.getElementById('cancelEdit') as HTMLButtonElement;

  // Edit functionality
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      editId.value = target.dataset.id || '';
      editNombre.value = target.dataset.nombre || '';
      editDescripcion.value = target.dataset.descripcion || '';
      editModal.classList.remove('hidden');
      editModal.classList.add('flex');
    });
  });

  cancelEdit?.addEventListener('click', () => {
    editModal.classList.add('hidden');
    editModal.classList.remove('flex');
  });

  editModal?.addEventListener('click', (e) => {
    if (e.target === editModal) {
      editModal.classList.add('hidden');
      editModal.classList.remove('flex');
    }
  });

  editForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
      const response = await fetch(`http://localhost:1337/api/zonas/${editId.value}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          data: {
            nombre: editNombre.value,
            descripcion: editDescripcion.value || null
          }
        }),
      });
      
      if (!response.ok) throw new Error('Error al actualizar');
      
      window.location.href = '/admin/zonas?success=updated';
    } catch (error) {
      alert('Error al actualizar la zona');
    }
  });

  // Delete functionality
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      const id = target.dataset.id;
      const name = target.dataset.name;
      
      if (!confirm(`¬øEst√° seguro de eliminar la zona "${name}"?`)) return;
      
      try {
        const response = await fetch(`http://localhost:1337/api/zonas/${id}`, {
          method: 'DELETE',
        });
        
        if (!response.ok) throw new Error('Error al eliminar');
        
        window.location.href = '/admin/zonas?success=deleted';
      } catch (error) {
        alert('Error al eliminar la zona');
      }
    });
  });
</script>
