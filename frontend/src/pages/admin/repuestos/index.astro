---
export const prerender = false;
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { strapiGet } from '../../../lib/strapi';

let repuestos: any[] = [];
let error = '';
const successMessage = Astro.url.searchParams.get('success');

try {
  const response = await strapiGet('/api/repuestos?pagination[pageSize]=200&sort=nombre:asc');
  repuestos = (response.data || []).map((rep: any) => ({
    ...rep,
    stockBajo: rep.stock <= (rep.stock_minimo || 5)
  }));
} catch (e: any) {
  error = e.message;
}

// Calcular estad√≠sticas
const totalRepuestos = repuestos.length;
const bajosStock = repuestos.filter((r: any) => r.stockBajo).length;
const valorInventario = repuestos.reduce((sum: number, r: any) => sum + ((r.precio || 0) * (r.stock || 0)), 0);
---

<DashboardLayout title="Gesti√≥n de Repuestos" role="admin" currentPath="/admin/repuestos">
  <div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center">
        <a href="/admin" class="text-gray-600 hover:text-blue-600 mr-4 transition-colors">
          ‚Üê Volver
        </a>
        <h1 class="text-3xl font-bold text-gray-800">Gesti√≥n de Repuestos</h1>
      </div>
      <a href="/admin/repuestos/crear" class="btn-primary">
        + Nuevo Repuesto
      </a>
    </div>

    {successMessage && (
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        {successMessage === 'created' ? '‚úì Repuesto creado exitosamente' : 
         successMessage === 'updated' ? '‚úì Repuesto actualizado exitosamente' :
         successMessage === 'deleted' ? '‚úì Repuesto eliminado exitosamente' : '‚úì Operaci√≥n exitosa'}
      </div>
    )}

    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        Error: {error}
      </div>
    )}

    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card p-4 bg-blue-50 border-l-4 border-blue-500">
        <p class="text-sm text-gray-600">Total Repuestos</p>
        <p class="text-2xl font-bold text-blue-700">{totalRepuestos}</p>
      </div>
      <div class="card p-4 bg-red-50 border-l-4 border-red-500">
        <p class="text-sm text-gray-600">Stock Bajo</p>
        <p class="text-2xl font-bold text-red-700">{bajosStock}</p>
      </div>
      <div class="card p-4 bg-green-50 border-l-4 border-green-500">
        <p class="text-sm text-gray-600">Valor Inventario</p>
        <p class="text-2xl font-bold text-green-700">${valorInventario.toLocaleString('es-CL')}</p>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card p-4 mb-6">
      <div class="flex flex-wrap gap-4">
        <input 
          type="text" 
          id="searchInput"
          placeholder="Buscar por nombre, SKU o categor√≠a..."
          class="flex-1 min-w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
        />
        <select id="filterStock" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
          <option value="">Todos los stocks</option>
          <option value="bajo">Stock bajo</option>
          <option value="normal">Stock normal</option>
        </select>
        <select id="filterCategoria" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
          <option value="">Todas las categor√≠as</option>
          <option value="Motor">Motor</option>
          <option value="Frenos">Frenos</option>
          <option value="Suspensi√≥n">Suspensi√≥n</option>
          <option value="Transmisi√≥n">Transmisi√≥n</option>
          <option value="Electricidad">Electricidad</option>
          <option value="Filtros">Filtros</option>
          <option value="Aceites">Aceites</option>
          <option value="Neum√°ticos">Neum√°ticos</option>
          <option value="Otros">Otros</option>
        </select>
      </div>
    </div>

    <!-- Lista de repuestos -->
    <div class="card overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-left px-6 py-4 font-bold text-gray-700">SKU</th>
            <th class="text-left px-6 py-4 font-bold text-gray-700">Nombre</th>
            <th class="text-left px-6 py-4 font-bold text-gray-700">Categor√≠a</th>
            <th class="text-right px-6 py-4 font-bold text-gray-700">Precio</th>
            <th class="text-center px-6 py-4 font-bold text-gray-700">Stock</th>
            <th class="text-center px-6 py-4 font-bold text-gray-700">Acciones</th>
          </tr>
        </thead>
        <tbody id="repuestosTable" class="divide-y divide-gray-100">
          {repuestos.length === 0 && (
            <tr>
              <td colspan="6" class="text-center py-8 text-gray-500">
                No hay repuestos registrados
              </td>
            </tr>
          )}
          {repuestos.map((rep: any) => (
              <tr class="hover:bg-gray-50 transition-colors repuesto-row" 
                  data-search={`${rep.sku} ${rep.nombre} ${rep.categoria || ''}`.toLowerCase()}
                  data-stock={rep.stockBajo ? 'bajo' : 'normal'}
                  data-categoria={rep.categoria || ''}>
                <td class="px-6 py-4">
                  <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">
                    {rep.sku}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <div class="font-medium text-gray-800">{rep.nombre}</div>
                  {rep.marca && <div class="text-sm text-gray-500">{rep.marca}</div>}
                </td>
                <td class="px-6 py-4">
                  {rep.categoria ? (
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                      {rep.categoria}
                    </span>
                  ) : '-'}
                </td>
                <td class="px-6 py-4 text-right">
                  <div class="font-medium text-gray-800">
                    ${(rep.precio_venta || rep.precio || 0).toLocaleString('es-CL')}
                  </div>
                  {rep.precio_venta && rep.precio && rep.precio_venta !== rep.precio && (
                    <div class="text-xs text-gray-500">Costo: ${rep.precio.toLocaleString('es-CL')}</div>
                  )}
                </td>
                <td class="px-6 py-4 text-center">
                  <span class={`inline-flex items-center px-3 py-1 rounded-full text-sm font-bold ${
                    rep.stockBajo ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
                  }`}>
                    {rep.stock}
                    {rep.stockBajo && <span class="ml-1">‚ö†Ô∏è</span>}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center justify-center gap-2">
                    <a 
                      href={`/admin/repuestos/editar/${rep.documentId}`}
                      class="text-blue-600 hover:text-blue-800 font-medium text-sm"
                    >
                      ‚úèÔ∏è Editar
                    </a>
                    <button 
                      type="button"
                      class="text-red-600 hover:text-red-800 font-medium text-sm delete-btn"
                      data-id={rep.documentId}
                      data-name={rep.nombre}
                    >
                      üóëÔ∏è Eliminar
                    </button>
                  </div>
                </td>
              </tr>
          ))}
        </tbody>
      </table>
    </div>

    <div class="mt-4 text-gray-500 text-sm">
      Mostrando: <span id="visibleCount">{repuestos.length}</span> de {repuestos.length} repuestos
    </div>
  </div>
</DashboardLayout>

<script>
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const filterStock = document.getElementById('filterStock') as HTMLSelectElement;
  const filterCategoria = document.getElementById('filterCategoria') as HTMLSelectElement;
  const rows = document.querySelectorAll('.repuesto-row');
  const visibleCount = document.getElementById('visibleCount');

  function filterRows() {
    const query = searchInput.value.toLowerCase();
    const stockFilter = filterStock.value;
    const categoriaFilter = filterCategoria.value;
    let visible = 0;
    
    rows.forEach(row => {
      const searchData = row.getAttribute('data-search') || '';
      const stockData = row.getAttribute('data-stock') || '';
      const categoriaData = row.getAttribute('data-categoria') || '';
      
      const matchesSearch = searchData.includes(query);
      const matchesStock = !stockFilter || stockData === stockFilter;
      const matchesCategoria = !categoriaFilter || categoriaData === categoriaFilter;
      
      const show = matchesSearch && matchesStock && matchesCategoria;
      (row as HTMLElement).style.display = show ? '' : 'none';
      if (show) visible++;
    });
    
    if (visibleCount) visibleCount.textContent = visible.toString();
  }

  searchInput?.addEventListener('input', filterRows);
  filterStock?.addEventListener('change', filterRows);
  filterCategoria?.addEventListener('change', filterRows);

  // Delete functionality
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.target as HTMLButtonElement;
      const id = target.dataset.id;
      const name = target.dataset.name;
      
      if (!confirm(`¬øEst√° seguro de eliminar el repuesto "${name}"?`)) return;
      
      try {
        const response = await fetch(`http://localhost:1337/api/repuestos/${id}`, {
          method: 'DELETE',
        });
        
        if (!response.ok) throw new Error('Error al eliminar');
        
        window.location.href = '/admin/repuestos?success=deleted';
      } catch (error) {
        alert('Error al eliminar el repuesto');
      }
    });
  });
</script>
